<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bate Papo P2P</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>

    :root {
      --primary-color: #4a76fd;
      --secondary-color: #e8f0ff;
      --accent-color: #74b9ff;
      --sent-message: #e2f2ff;
      --received-message: #ffffff;
      --background: #f0f5ff;
      --text-dark: #2c3e50;
      --text-light: #7f8c8d;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --border-radius: 16px;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--background);
      color: var(--text-dark);
      line-height: 1.5;
      height: 100vh;
      display: flex;
      flex-direction: column;
      margin: 0;
      padding: 0;
    }
    
    #root {
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 16px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      border-bottom: 2px solid var(--secondary-color);
      padding-bottom: 12px;
    }
    
    .header h1 {
      font-size: 22px;
      color: var(--primary-color);
      font-weight: 700;
      letter-spacing: -0.5px;
    }
    
    .connection-status {
      display: flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 24px;
      background-color: var(--secondary-color);
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
      box-shadow: 0 0 4px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }
    
    .status-connected {
      background-color: #4CAF50;
      box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
    }
    
    .status-disconnected {
      background-color: #f44336;
      box-shadow: 0 0 10px rgba(244, 67, 54, 0.5);
    }
    
    .status-connecting {
      background-color: #FFC107;
      animation: pulse 1.5s infinite;
      box-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
    }
    
    @keyframes pulse {
      0% { transform: scale(0.8); opacity: 0.7; }
      50% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(0.8); opacity: 0.7; }
    }
    
    .message-container {
      flex: 1;
      overflow-y: auto;
      border-radius: var(--border-radius);
      padding: 12px;
      margin-bottom: 12px; /* Adicionado margin-bottom para espaÃ§o adequado */
      display: flex;
      flex-direction: column;
      background-color: #f8faff;
      border: 1px solid rgba(74, 118, 253, 0.1);
      min-height: 200px;
      max-height: calc(100vh - 300px); /* Ajustado para garantir espaÃ§o para a caixa de entrada */
      scrollbar-width: thin;
      scrollbar-color: var(--primary-color) rgba(0, 0, 0, 0.1);
    }
    
    .message-container::-webkit-scrollbar {
      width: 8px;
    }
    
    .message-container::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 10px;
    }
    
    .message-container::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 10px;
    }
    
    .message-container::-webkit-scrollbar-thumb:hover {
      background: #3764e6;
    }
    
    .message {
      margin-bottom: 12px;
      padding: 10px 16px;
      border-radius: 16px;
      max-width: 80%;
      word-break: break-word;
      position: relative;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      animation: messageAppear 0.3s ease-out;
      line-height: 1.4;
      font-size: 14px;
    }
    
    @keyframes messageAppear {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .message.sent {
      align-self: flex-end;
      background-color: var(--primary-color);
      color: white;
      border-bottom-right-radius: 5px;
      margin-left: auto;
    }
    
    .message.received {
      align-self: flex-start;
      background-color: var(--received-message);
      border-bottom-left-radius: 5px;
      margin-right: auto;
      border-left: 4px solid var(--accent-color);
    }
    
    .message-sender {
      font-weight: 600;
      margin-bottom: 3px;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      font-size: 13px;
    }
    
    .message.sent .message-sender {
      color: rgba(255, 255, 255, 0.85);
    }
    
    .message-sender::before {
      content: '';
      display: inline-block;
      width: 8px;
      height: 8px;
      background-color: var(--accent-color);
      border-radius: 50%;
      margin-right: 6px;
    }
    
    .message.sent .message-sender::before {
      background-color: white;
    }
    
    .empty-message {
      text-align: center;
      color: var(--text-light);
      margin-top: 20px;
      font-style: italic;
      animation: fadeIn 1s ease;
      font-size: 14px;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .system-message {
      align-self: center;
      background-color: rgba(232, 240, 255, 0.8);
      padding: 8px 16px;
      border-radius: 20px;
      font-style: italic;
      color: var(--text-dark);
      font-size: 13px;
      box-shadow: none;
      max-width: 90%;
      margin: 8px 0;
      text-align: center;
      border: 1px dashed rgba(74, 118, 253, 0.3);
    }
    
    .connection-form {
      margin-bottom: 12px;
      display: flex;
      gap: 8px;
      align-items: center;
      background-color: var(--secondary-color);
      padding: 10px;
      border-radius: var(--border-radius);
    }
    
    .connection-form input {
      flex-grow: 1;
      padding: 8px 12px;
      border: 1px solid rgba(74, 118, 253, 0.2);
      border-radius: 10px;
      font-size: 14px;
      outline: none;
      transition: all 0.3s ease;
      background-color: white;
    }
    
    .connection-form input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(74, 118, 253, 0.2);
    }
    
    .connection-button {
      padding: 8px 16px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      font-size: 14px;
    }
    
    .connection-button:hover {
      background-color: #3764e6;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(74, 118, 253, 0.3);
    }
    
    .connection-button:active {
      transform: translateY(0);
      box-shadow: none;
    }
    
    .connection-button.disconnect {
      background-color: #f44336;
    }
    
    .connection-button.disconnect:hover {
      background-color: #d32f2f;
      box-shadow: 0 4px 8px rgba(244, 67, 54, 0.3);
    }
    
    .input-container {
      display: flex;
      background-color: var(--secondary-color);
      padding: 10px;
      border-radius: var(--border-radius);
      position: relative;
      margin-top: 0;
      /* Estas propriedades garantem que a caixa de entrada permanecerÃ¡ fixada na parte inferior */
      min-height: 60px;
      width: 100%;
      z-index: 2;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
    }
    
    .message-input {
      flex-grow: 1;
      padding: 10px 14px;
      border: 1px solid rgba(74, 118, 253, 0.2);
      border-radius: 10px;
      font-size: 14px;
      outline: none;
      transition: all 0.3s ease;
      background-color: white;
    }
    
    .message-input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(74, 118, 253, 0.2);
    }
    
    .send-button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-left: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 0 3px 6px rgba(74, 118, 253, 0.3);
    }
    
    .send-button:hover {
      background-color: #3764e6;
      transform: translateY(-2px);
      box-shadow: 0 5px 10px rgba(74, 118, 253, 0.4);
    }
    
    .send-button:active {
      transform: translateY(0);
      box-shadow: none;
    }
    
    .send-button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    
    .send-button i {
      font-size: 16px;
    }
    
    .username-input {
      padding: 8px 12px;
      border: 1px solid rgba(74, 118, 253, 0.2);
      border-radius: 10px;
      font-size: 14px;
      width: 180px;
      background-color: white;
    }
    
    .file-message {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .file-link {
      color: var(--primary-color);
      text-decoration: underline;
      cursor: pointer;
    }
    
    .message.sent .file-link {
      color: white;
    }
    
    .emoji-button {
      background-color: var(--secondary-color);
      color: var(--primary-color);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 0 3px 6px rgba(74, 118, 253, 0.1);
    }
    
    .emoji-button:hover {
      background-color: #d9e6ff;
      transform: translateY(-2px);
      box-shadow: 0 5px 10px rgba(74, 118, 253, 0.2);
    }
    
    .emoji-button:active {
      transform: translateY(0);
      box-shadow: none;
    }
    
    .emoji-button:disabled {
      background-color: #eeeeee;
      color: #bbbbbb;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    
    .emoji-button i {
      font-size: 18px;
    }
    
    .emoji-picker {
      position: absolute;
      bottom: 70px;
      left: 10px;
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
      padding: 10px;
      width: 320px;
      max-height: 250px;
      overflow-y: auto;
      z-index: 1000;
      transition: all 0.3s ease;
      animation: fadeInUp 0.3s ease;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    
    .emoji-item {
      font-size: 24px;
      height: 36px;
      width: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      text-align: center;
      border-radius: 5px;
      transition: all 0.2s ease;
    }
    
    .emoji-item:hover {
      background-color: var(--secondary-color);
      transform: scale(1.2);
    }
    
    .nav-tabs {
      display: flex;
      border-bottom: 2px solid var(--secondary-color);
      margin-bottom: 12px;
    }
    
    .nav-tab {
      padding: 10px 20px;
      cursor: pointer;
      font-weight: 600;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .nav-tab:hover {
      color: var(--primary-color);
      background-color: rgba(232, 240, 255, 0.5);
    }
    
    .nav-tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }
    
    .contacts-container {
      flex: 1;
      overflow-y: auto;
      border-radius: var(--border-radius);
      padding: 12px;
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
      background-color: #f8faff;
      border: 1px solid rgba(74, 118, 253, 0.1);
      scrollbar-width: none;
    }
    
    .contacts-container::-webkit-scrollbar {
      display: none;
    }
    
    .contact-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .contact-status {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .contact-status i {
      font-size: 12px;
      color: #ccc;
    }
    
    .contact-status.online i {
      color: #4CAF50;
      text-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
    }
    
    .contact-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-radius: 12px;
      background-color: white;
      transition: all 0.3s ease;
      border: 1px solid rgba(74, 118, 253, 0.1);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .contact-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      border-color: rgba(74, 118, 253, 0.3);
    }
    
    .contact-item:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background-color: transparent;
      transition: all 0.3s ease;
    }
    
    .contact-item:hover:after {
      background-color: var(--primary-color);
    }
    
    .contact-item .status-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all 0.3s ease;
      color: white;
      font-weight: bold;
      border-radius: 12px;
      pointer-events: none;
    }
    
    .contact-item.checking .status-overlay {
      opacity: 1;
      pointer-events: all;
    }
    
    .contact-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background-color: var(--secondary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      font-weight: bold;
      color: var(--primary-color);
      font-size: 18px;
    }
    
    .contact-info {
      flex: 1;
    }
    
    .contact-name {
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 4px;
    }
    
    .contact-id {
      font-size: 13px;
      color: var(--text-light);
    }
    
    .contact-actions {
      display: flex;
      gap: 8px;
    }
    
    .contact-action {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: var(--secondary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .contact-action:hover {
      background-color: var(--primary-color);
      color: white;
      transform: translateY(-2px);
    }
    
    .contact-action.delete:hover {
      background-color: #f44336;
    }
    
    .add-contact-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
      background-color: var(--secondary-color);
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 16px;
    }
    
    .form-row {
      display: flex;
      gap: 8px;
    }
    
    .add-contact-form input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid rgba(74, 118, 253, 0.2);
      border-radius: 10px;
      font-size: 14px;
      outline: none;
      transition: all 0.3s ease;
      background-color: white;
    }
    
    .add-contact-form input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(74, 118, 253, 0.2);
    }
    
    .add-contact-button {
      padding: 10px 20px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .add-contact-button:hover {
      background-color: #3764e6;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(74, 118, 253, 0.3);
    }
    
    .add-contact-button:active {
      transform: translateY(0);
      box-shadow: none;
    }
    
    .empty-contacts {
      text-align: center;
      color: var(--text-light);
      margin: 32px 0;
      font-style: italic;
      animation: fadeIn 1s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }
    
    .empty-illustration {
      font-size: 48px;
      color: var(--accent-color);
      opacity: 0.7;
    }
    
    /* Adicionado: estilos para o componente do chat para garantir que o layout seja preservado */
    .chat-wrapper {
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 0; /* Importante para que o flex funcione corretamente */
    }
    
    @media (max-width: 600px) {
      #root {
        padding: 8px;
      }
      
      .connection-form, .form-row {
        flex-direction: column;
      }
      
      .username-input {
        width: 100%;
      }
      
      .message {
        max-width: 90%;
      }
      
      .emoji-picker {
        grid-template-columns: repeat(6, 1fr);
        max-width: 240px;
      }
      
      .nav-tab {
        padding: 10px 12px;
        font-size: 13px;
      }
      
      /* Ajustes para mobile */
      .message-container {
        max-height: calc(100vh - 350px);
      }
    }
    
    @media (min-width: 800px) {
      #root {
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
      }
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.1/peerjs.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const emojiList = [
      'ðŸ˜€', 'ðŸ˜‚', 'ðŸ¤£', 'ðŸ˜Š', 'ðŸ˜', 'ðŸ¥°', 'ðŸ˜˜', 'ðŸ˜Ž', 'ðŸ™‚', 'ðŸ˜‰', 
      'ðŸ˜¢', 'ðŸ˜­', 'ðŸ˜¡', 'ðŸ¤¬', 'ðŸ˜±', 'ðŸ˜°', 'ðŸ˜¨', 'ðŸ˜³', 'ðŸ¤”', 'ðŸ¤—',
      'ðŸ‘', 'ðŸ‘Ž', 'ðŸ‘Œ', 'âœŒï¸', 'ðŸ¤ž', 'ðŸ‘Š', 'âœŠ', 'ðŸ™Œ', 'ðŸ‘', 'ðŸ¤',
      'â¤ï¸', 'ðŸ’‹', 'ðŸ’•', 'ðŸ’ž', 'ðŸ’“', 'ðŸ’—', 'ðŸ’–', 'ðŸ’˜', 'ðŸ’', 'ðŸ’”',
      'ðŸŽ‚', 'ðŸŽ‰', 'ðŸŽŠ', 'ðŸŽ', 'âœ¨', 'ðŸŒŸ', 'ðŸ’«', 'â­', 'ðŸŽ¯', 'ðŸ†',
      'ðŸ¶', 'ðŸ±', 'ðŸ­', 'ðŸ°', 'ðŸ¦Š', 'ðŸ»', 'ðŸ¼', 'ðŸ¨', 'ðŸ¦', 'ðŸ®',
      'ðŸŽ', 'ðŸ•', 'ðŸ”', 'ðŸŒ®', 'ðŸ°', 'ðŸ¦', 'ðŸ©', 'ðŸ«', 'â˜•', 'ðŸº',
      'âš½', 'ðŸ€', 'ðŸˆ', 'âš¾', 'ðŸŽ¾', 'ðŸ', 'ðŸ‰', 'ðŸŽ±', 'ðŸ“', 'ðŸ¸',
      'ðŸŽµ', 'ðŸŽ¸', 'ðŸŽ¹', 'ðŸŽ·', 'ðŸŽº', 'ðŸŽ¤', 'ðŸŽ§', 'ðŸŽ¬', 'ðŸŽ­', 'ðŸŽ®',
      'ðŸš—', 'ðŸš•', 'ðŸš™', 'ðŸšŒ', 'ðŸš‘', 'ðŸš’', 'âœˆï¸', 'ðŸš€', 'ðŸš', 'â›µ',
      'ðŸ’¼', 'ðŸ’»', 'ðŸ“±', 'ðŸ“·', 'ðŸ”‹', 'ðŸ’¡', 'ðŸ”', 'ðŸ”‘', 'ðŸ’°', 'ðŸ’³'
    ];

    const EmojiPicker = ({ onSelectEmoji, isOpen, onClose }) => {
      const pickerRef = useRef(null);
      
      useEffect(() => {
        const handleClickOutside = (event) => {
          if (pickerRef.current && !pickerRef.current.contains(event.target) && isOpen) {
            onClose();
          }
        };
        
        document.addEventListener('mousedown', handleClickOutside);
        return () => {
          document.removeEventListener('mousedown', handleClickOutside);
        };
      }, [isOpen, onClose]);
      
      if (!isOpen) return null;
      
      return (
        <div className="emoji-picker" ref={pickerRef}>
          <div className="emoji-grid">
            {emojiList.map((emoji, index) => (
              <div 
                key={index} 
                className="emoji-item" 
                onClick={() => onSelectEmoji(emoji)}
              >
                {emoji}
              </div>
            ))}
          </div>
        </div>
      );
    };

    const generatePeerId = () => {
      const chars = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';
      const length = 6;
      let result = '';
      
      const randomValues = new Uint8Array(length);
      window.crypto.getRandomValues(randomValues);
      
      for (let i = 0; i < length; i++) {
        result += chars.charAt(randomValues[i] % chars.length);
      }
      
      return result;
    };

    const getInitials = (name) => {
      if (!name) return '?';
      return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
    };

    const App = () => {
      const [activeTab, setActiveTab] = useState('contacts');
      
      return (
        <div style={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="header">
            <h1>Bate Papo P2P ðŸ’¬</h1>
          </div>
          
          <div className="nav-tabs">
            <div 
              className={`nav-tab ${activeTab === 'contacts' ? 'active' : ''}`}
              onClick={() => setActiveTab('contacts')}
            >
              <i className="fas fa-address-book"></i> Contatos
            </div>
            <div 
              className={`nav-tab ${activeTab === 'chat' ? 'active' : ''}`}
              onClick={() => setActiveTab('chat')}
            >
              <i className="fas fa-comments"></i> Chat
            </div>
          </div>
          
          {activeTab === 'contacts' ? <ContactsList setActiveTab={setActiveTab} /> : <ChatClient />}
        </div>
      );
    };

    const ContactsList = ({ setActiveTab }) => {
      const [contacts, setContacts] = useState([]);
      const [newContactName, setNewContactName] = useState('');
      const [newContactId, setNewContactId] = useState('');
      const [contactsStatus, setContactsStatus] = useState({});
      const [checkingStatus, setCheckingStatus] = useState(null);
      
      useEffect(() => {
        const savedContacts = localStorage.getItem('batepapo-contacts');
        if (savedContacts) {
          try {
            const parsedContacts = JSON.parse(savedContacts);
            setContacts(parsedContacts);
            const initialStatus = {};
            parsedContacts.forEach(contact => {
              initialStatus[contact.id] = 'unknown';
            });
            setContactsStatus(initialStatus);
          } catch (err) {
            console.error("Erro ao carregar contatos:", err);
            setContacts([]);
          }
        }
        
        const savedPeerId = localStorage.getItem('batepapo-peer-id');
        if (!savedPeerId) {
          const newId = generatePeerId();
          localStorage.setItem('batepapo-peer-id', newId);
        }
      }, []);
      
      useEffect(() => {
        localStorage.setItem('batepapo-contacts', JSON.stringify(contacts));
      }, [contacts]);
      
      const addContact = () => {
        if (!newContactName.trim() || !newContactId.trim()) {
          alert("Preencha o nome e o ID do contato!");
          return;
        }
        
        if (contacts.some(contact => contact.peerId === newContactId.trim())) {
          alert("JÃ¡ existe um contato com este ID!");
          return;
        }
        
        const newContact = {
          id: Date.now().toString(),
          name: newContactName.trim(),
          peerId: newContactId.trim(),
          createdAt: new Date().toISOString()
        };
        
        setContacts(prev => [...prev, newContact]);
        setNewContactName('');
        setNewContactId('');
      };
      
      const removeContact = (contactId) => {
        if (confirm("Tem certeza que deseja remover este contato?")) {
          setContacts(prev => prev.filter(contact => contact.id !== contactId));
        }
      };
      
      const startChat = (contactId) => {
        const contact = contacts.find(c => c.id === contactId);
        if (!contact) return;
        
        setCheckingStatus(contactId);
        
        checkContactStatus(contact.peerId, (isOnline) => {
          setCheckingStatus(null);
          
          setContactsStatus(prev => ({
            ...prev,
            [contactId]: isOnline ? 'online' : 'offline'
          }));
          
          if (isOnline) {
            localStorage.setItem('batepapo-target-peer-id', contact.peerId);
            setActiveTab('chat');
          } else {
            alert(`${contact.name} estÃ¡ offline no momento. Tente novamente mais tarde.`);
          }
        });
      };
      
      const checkContactStatus = (contactPeerId, callback) => {
        if (!peerRef.current) {
          const tempPeerId = localStorage.getItem('batepapo-peer-id');
          if (!tempPeerId) {
            const newId = generatePeerId();
            localStorage.setItem('batepapo-peer-id', newId);
          }
          
          initPeer(() => {
            checkConnectionStatus(contactPeerId, callback);
          });
        } else {
          checkConnectionStatus(contactPeerId, callback);
        }
      };
      
      const peerRef = useRef(null);
      
      const initPeer = (callback) => {
        const tempPeerId = localStorage.getItem('batepapo-peer-id');
        
        const peer = new Peer(tempPeerId, {
          host: '0.peerjs.com',
          port: 443,
          secure: true,
          config: {
            iceServers: [
              { urls: 'stun:stun.l.google.com:19302' },
              { urls: 'stun:stun1.l.google.com:19302' }
            ]
          },
          debug: 1
        });
        
        peer.on('open', (id) => {
          console.log("Peer inicializado com ID:", id);
          peerRef.current = peer;
          
          if (callback) callback();
        });
        
        peer.on('error', (err) => {
          console.error("Erro no peer:", err);
          if (callback) callback();
        });
      };
      
      const checkConnectionStatus = (contactPeerId, callback) => {
        try {
          console.log("Verificando status do contato:", contactPeerId);
          
          const connectionTimeout = setTimeout(() => {
            console.log("Timeout na conexÃ£o, contato offline");
            if (callback) callback(false);
          }, 5000);
          
          const conn = peerRef.current.connect(contactPeerId, {
            reliable: true
          });
          
          conn.on('open', () => {
            console.log("ConexÃ£o estabelecida, contato online");
            clearTimeout(connectionTimeout);
            
            setTimeout(() => {
              conn.close();
            }, 500);
            
            if (callback) callback(true);
          });
          
          conn.on('error', (err) => {
            console.error("Erro na conexÃ£o:", err);
            clearTimeout(connectionTimeout);
            if (callback) callback(false);
          });
        } catch (err) {
          console.error("Erro ao verificar status:", err);
          if (callback) callback(false);
        }
      };
      
      useEffect(() => {
        if (!peerRef.current) {
          initPeer();
        }
        
        return () => {
          if (peerRef.current) {
            try {
              peerRef.current.destroy();
            } catch (e) {
              console.error("Erro ao destruir peer:", e);
            }
          }
        };
      }, []);
      
      return (
        <div style={{ display: 'flex', flexDirection: 'column', height: '100%' }}>
          <div className="add-contact-form">
            <h3 style={{margin: '0 0 8px 0', fontSize: '16px'}}>
              <i className="fas fa-user-plus"></i> Adicionar Novo Contato
            </h3>
            <div className="form-row">
              <input
                type="text"
                placeholder="Nome do contato"
                value={newContactName}
                onChange={(e) => setNewContactName(e.target.value)}
              />
              <input
                type="text"
                placeholder="ID P2P do contato"
                value={newContactId}
                onChange={(e) => setNewContactId(e.target.value)}
              />
            </div>
            <div className="form-row">
              <button 
                className="add-contact-button" 
                onClick={addContact}
                disabled={!newContactName.trim() || !newContactId.trim()}
              >
                <i className="fas fa-plus-circle"></i> Adicionar Contato
              </button>
            </div>
          </div>
          
          <div className="contacts-container" style={{maxHeight: 'calc(100vh - 250px)', overflowY: 'auto'}}>
            <h3 style={{margin: '0 0 12px 0', fontSize: '16px', display: 'flex', alignItems: 'center', gap: '8px', position: 'sticky', top: 0, background: '#f8faff', padding: '5px 0', zIndex: 1}}>
              <i className="fas fa-address-book"></i> Meus Contatos ({contacts.length})
            </h3>
            
            {contacts.length === 0 ? (
              <div className="empty-contacts">
                <div className="empty-illustration">
                  <i className="far fa-address-book"></i>
                </div>
                <div>VocÃª ainda nÃ£o tem contatos</div>
                <div style={{fontSize: '13px', maxWidth: '300px', margin: '0 auto'}}>
                  Adicione contatos usando o ID P2P deles para comeÃ§ar a conversar!
                </div>
              </div>
            ) : (
              <div className="contact-list">
                {contacts.map(contact => (
                  <div 
                    className={`contact-item ${checkingStatus === contact.id ? 'checking' : ''}`} 
                    key={contact.id} 
                    onClick={() => startChat(contact.id)}
                  >
                    <div className="contact-avatar">
                      {getInitials(contact.name)}
                    </div>
                    <div className="contact-info">
                      <div className="contact-name">{contact.name}</div>
                      <div className="contact-id">{contact.peerId}</div>
                    </div>
                    <div className="contact-actions">
                      <div 
                        className={`contact-status ${contactsStatus[contact.id] === 'online' ? 'online' : ''}`}
                        title={`Status: ${contactsStatus[contact.id] === 'online' ? 'Online' : contactsStatus[contact.id] === 'offline' ? 'Offline' : 'Desconhecido'}`}
                      >
                        <i className="fas fa-circle"></i>
                      </div>
                      <div 
                        className="contact-action delete" 
                        onClick={(e) => {
                          e.stopPropagation();
                          removeContact(contact.id);
                        }}
                        title="Remover contato"
                      >
                        <i className="fas fa-trash-alt"></i>
                      </div>
                    </div>
                    
                    {checkingStatus === contact.id && (
                      <div className="status-overlay">
                        <div>Verificando status...</div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    };

    const ChatClient = () => {
      const [username, setUsername] = useState('');
      const [peerId, setPeerId] = useState('');
      const [targetPeerId, setTargetPeerId] = useState('');
      const [connectionStatus, setConnectionStatus] = useState('desconectado');
      const [messages, setMessages] = useState([]);
      const [newMessage, setNewMessage] = useState('');
      const [isConnected, setIsConnected] = useState(false);
      const [showEmojiPicker, setShowEmojiPicker] = useState(false);
      
      const connectionRef = useRef(null);
      const peerRef = useRef(null);
      const messagesEndRef = useRef(null);
      const messageContainerRef = useRef(null);
      const messageInputRef = useRef(null);

      useEffect(() => {
        const savedPeerId = localStorage.getItem('batepapo-peer-id');
        if (savedPeerId) {
          setPeerId(savedPeerId);
        } else {
          const newId = generatePeerId();
          localStorage.setItem('batepapo-peer-id', newId);
          setPeerId(newId);
        }
        
        const savedUsername = localStorage.getItem('batepapo-username');
        if (savedUsername) {
          setUsername(savedUsername);
        }
        
        const savedTargetPeerId = localStorage.getItem('batepapo-target-peer-id');
        if (savedTargetPeerId) {
          setTargetPeerId(savedTargetPeerId);
        }
      }, []);

      useEffect(() => {
        if (messageContainerRef.current) {
          messageContainerRef.current.scrollTop = messageContainerRef.current.scrollHeight;
        }
      }, [messages]);

      useEffect(() => {
        if (!peerId) return;

        const initPeer = () => {
          if (peerRef.current) {
            try {
              peerRef.current.destroy();
            } catch (err) {
              console.error("Erro ao destruir peer existente:", err);
            }
          }

          const peer = new Peer(peerId, {
            host: '0.peerjs.com',
            port: 443,
            secure: true,
            config: {
              iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
              ]
            },
            debug: 1
          });

          peer.on('open', (id) => {
            console.log("Peer inicializado com ID:", id);
          });

          peer.on('connection', (conn) => {
            console.log("ConexÃ£o recebida de:", conn.peer);
            
            conn.on('open', () => {
              console.log("ConexÃ£o aberta com:", conn.peer);
              setConnectionStatus('conectado');
              setIsConnected(true);
              connectionRef.current = conn;
              
              const welcomeMsg = {
                id: Date.now(),
                text: `${conn.peer} conectou ao chat ðŸ‘‹`,
                isSystem: true,
                timestamp: new Date().toISOString()
              };
              
              setMessages(prev => [...prev, welcomeMsg]);
            });
            
            conn.on('data', (data) => {
              console.log("Dados recebidos:", data);
              handleIncomingData(data, conn.peer);
            });
            
            conn.on('close', () => {
              console.log("ConexÃ£o fechada com:", conn.peer);
              if (connectionRef.current && connectionRef.current.peer === conn.peer) {
                setConnectionStatus('desconectado');
                setIsConnected(false);
                connectionRef.current = null;
                
                const goodbyeMsg = {
                  id: Date.now(),
                  text: `${conn.peer} desconectou do chat ðŸ‘‹`,
                  isSystem: true,
                  timestamp: new Date().toISOString()
                };
                
                setMessages(prev => [...prev, goodbyeMsg]);
              }
            });
            
            conn.on('error', (err) => {
              console.error("Erro na conexÃ£o:", err);
              if (connectionRef.current && connectionRef.current.peer === conn.peer) {
                setConnectionStatus('erro');
                setIsConnected(false);
                connectionRef.current = null;
              }
            });
          });

          peer.on('error', (err) => {
            console.error("Erro no peer:", err);
            setConnectionStatus('erro');
            setIsConnected(false);
          });

          peerRef.current = peer;
        };

        initPeer();

        return () => {
          if (peerRef.current) {
            try {
              peerRef.current.destroy();
            } catch (e) {
              console.error("Erro ao destruir peer:", e);
            }
          }
        };
      }, [peerId]);

      const connectToPeer = () => {
        if (!peerRef.current || !targetPeerId || !username.trim()) {
          alert("Preencha seu nome de usuÃ¡rio e o ID do contato!");
          return;
        }

        localStorage.setItem('batepapo-username', username);

        setConnectionStatus('conectando');

        try {
          const conn = peerRef.current.connect(targetPeerId, {
            reliable: true
          });

          conn.on('open', () => {
            console.log("Conectado ao peer:", targetPeerId);
            setConnectionStatus('conectado');
            setIsConnected(true);
            connectionRef.current = conn;

            const welcomeMsg = {
              type: 'message',
              message: `${username} entrou no chat ðŸ‘‹`,
              sender: username,
              timestamp: new Date().toISOString(),
              system: true
            };
            conn.send(welcomeMsg);
            
            setMessages(prev => [
              ...prev,
              {
                id: Date.now(),
                text: `Conectado a ${targetPeerId} ðŸ‘‹`,
                isSystem: true,
                timestamp: new Date().toISOString()
              }
            ]);
          });

          conn.on('data', (data) => {
            console.log("Dados recebidos:", data);
            handleIncomingData(data, targetPeerId);
          });

          conn.on('close', () => {
            console.log("ConexÃ£o fechada");
            setConnectionStatus('desconectado');
            setIsConnected(false);
            connectionRef.current = null;
            
            setMessages(prev => [
              ...prev,
              {
                id: Date.now(),
                text: `Desconectado de ${targetPeerId} ðŸ‘‹`,
                isSystem: true,
                timestamp: new Date().toISOString()
              }
            ]);
          });

          conn.on('error', (err) => {
            console.error("Erro na conexÃ£o:", err);
            setConnectionStatus('erro');
            setIsConnected(false);
            connectionRef.current = null;
          });
        } catch (err) {
          console.error("Erro ao conectar:", err);
          setConnectionStatus('erro');
          setIsConnected(false);
          alert(`Erro ao conectar: ${err.message}`);
        }
      };

      const disconnectFromPeer = () => {
        if (connectionRef.current) {
          try {
            const goodbyeMsg = {
              type: 'message',
              message: `${username} saiu do chat ðŸ‘‹`,
              sender: username,
              timestamp: new Date().toISOString(),
              system: true
            };
            connectionRef.current.send(goodbyeMsg);
            
            connectionRef.current.close();
            connectionRef.current = null;
            setConnectionStatus('desconectado');
            setIsConnected(false);
          } catch (err) {
            console.error("Erro ao desconectar:", err);
          }
        }
      };

      const handleIncomingData = (data, senderId) => {
        console.log("Processando dados recebidos:", data);
        
        if (data.type === 'message') {
          const newMsg = {
            id: Date.now() + Math.random().toString(36).substr(2, 9),
            text: data.message || data.text,
            sender: data.sender || data.senderName,
            isSystem: data.system,
            timestamp: data.timestamp || new Date().toISOString(),
            isSelf: false
          };
          
          setMessages(prev => [...prev, newMsg]);
        } else if (data.type === 'file-start' || data.type === 'audio-start') {
          const format = data.type === 'file-start' ? 'arquivo' : 'Ã¡udio';
          const fileName = data.fileName || `${format}.dat`;
          
          const newMsg = {
            id: Date.now() + Math.random().toString(36).substr(2, 9),
            text: `Enviou um ${format}${data.fileName ? `: ${data.fileName}` : ''}`,
            sender: data.sender || data.senderName,
            isSystem: false,
            timestamp: data.timestamp || new Date().toISOString(),
            isSelf: false
          };
          
          setMessages(prev => [...prev, newMsg]);
        } else if (data.type === 'file-chunk' || data.type === 'audio-chunk') {
          return;
        }
      };

      const handleEmojiSelect = (emoji) => {
        console.log("Emoji selecionado:", emoji);
        setNewMessage(prev => prev + emoji);
        setShowEmojiPicker(false);
        setTimeout(() => {
          if (messageInputRef.current) {
            messageInputRef.current.focus();
          }
        }, 100);
      };

      const sendMessage = () => {
        if (!connectionRef.current || !newMessage.trim()) return;

        const messageData = {
          type: 'message',
          text: newMessage.trim(),
          message: newMessage.trim(),
          sender: username,
          senderName: username,
          timestamp: new Date().toISOString(),
          direct: true
        };

        try {
          console.log("Enviando mensagem:", messageData);
          connectionRef.current.send(messageData);
          
          const newMsg = {
            id: Date.now() + Math.random().toString(36).substr(2, 9),
            text: newMessage.trim(),
            sender: username,
            timestamp: new Date().toISOString(),
            isSelf: true
          };
          
          setMessages(prev => [...prev, newMsg]);
          setNewMessage('');
        } catch (err) {
          console.error("Erro ao enviar mensagem:", err);
          alert("NÃ£o foi possÃ­vel enviar a mensagem. Verifique sua conexÃ£o.");
        }
      };

      // Modificado para usar a classe chat-wrapper
      return (
        <div className="chat-wrapper">
          <div className="connection-status">
            <span className={`status-indicator status-${isConnected ? 'connected' : connectionStatus === 'conectando' ? 'connecting' : 'disconnected'}`}></span>
            {isConnected ? 'Conectado' : connectionStatus === 'conectando' ? 'Conectando...' : 'Desconectado'}
          </div>

          <div className="connection-form">
            <div style={{display: 'flex', flexDirection: 'column', gap: '8px', width: '100%'}}>
              <div style={{display: 'flex', gap: '8px', width: '100%'}}>
                <input
                  type="text"
                  className="username-input"
                  placeholder="Seu nome"
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  disabled={isConnected}
                />
                <span style={{padding: '8px', fontWeight: 'bold'}}>Seu ID: {peerId}</span>
              </div>
              <div style={{display: 'flex', gap: '8px', width: '100%'}}>
                <input
                  type="text"
                  placeholder="ID do contato P2P"
                  value={targetPeerId}
                  onChange={(e) => setTargetPeerId(e.target.value)}
                  disabled={isConnected}
                  style={{flex: 1}}
                />
                {!isConnected ? (
                  <button 
                    className="connection-button" 
                    onClick={connectToPeer}
                    disabled={!username.trim() || !targetPeerId.trim() || connectionStatus === 'conectando'}
                  >
                    Conectar
                  </button>
                ) : (
                  <button 
                    className="connection-button disconnect" 
                    onClick={disconnectFromPeer}
                  >
                    Desconectar
                  </button>
                )}
              </div>
            </div>
          </div>

          <div className="message-container" ref={messageContainerRef}>
            {messages.length === 0 ? (
              <div className="empty-message">
                {isConnected ? 'Sem mensagens. Seja o primeiro a dizer olÃ¡! ðŸ‘‹' : 'Conecte-se a um contato P2P para iniciar o chat ðŸš€'}
              </div>
            ) : (
              messages.map((msg) => (
                <div 
                  key={msg.id} 
                  className={msg.isSystem ? "system-message" : `message ${msg.isSelf ? 'sent' : 'received'}`}
                >
                  {!msg.isSystem && !msg.isSelf && (
                    <div className="message-sender">{msg.sender}</div>
                  )}
                  <div>{msg.text}</div>
                </div>
              ))
            )}
            <div ref={messagesEndRef} />
          </div>

          <div className="input-container">
            <button 
              className="emoji-button" 
              onClick={() => setShowEmojiPicker(!showEmojiPicker)}
              disabled={!isConnected}
              title="Inserir emoji"
            >
              <i className="far fa-smile"></i>
            </button>

            <input
              type="text"
              className="message-input"
              placeholder={isConnected ? "Digite sua mensagem..." : "Conecte-se para enviar mensagens"}
              value={newMessage}
              onChange={(e) => setNewMessage(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
              disabled={!isConnected}
              ref={messageInputRef}
            />
            <button 
              className="send-button" 
              onClick={sendMessage}
              disabled={!isConnected || !newMessage.trim()}
            >
              <i className="fas fa-paper-plane"></i>
            </button>

            {showEmojiPicker && (
              <EmojiPicker 
                isOpen={showEmojiPicker} 
                onSelectEmoji={handleEmojiSelect}
                onClose={() => setShowEmojiPicker(false)}
              />
            )}
          </div>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</head>
<body>
  <div id="root"></div>
</body>
</html>
