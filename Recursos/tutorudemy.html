<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìö O Mundo da Matem√°tica - Plataforma Interativa com IA</title>
    <script src="https://js.puter.com/v2/"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)']],
                displayMath: [['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <!-- CSS permanece inalterado -->
    <style>
        /* Seu CSS original aqui (omitido para brevidade, mas deve ser mantido como est√° no seu c√≥digo) */
    </style>
</head>
<body>
    <!-- HTML permanece inalterado, exceto pela adi√ß√£o do bot√£o "Tentar Novamente" -->
    <div class="container">
        <!-- Menu Lateral -->
        <div class="sidebar">
            <!-- Seu HTML do menu lateral aqui (mantido como est√° no c√≥digo original) -->
        </div>

        <!-- √Årea Principal -->
        <div class="main-content">
            <div class="header">
                <h2 id="topic-title">üéØ Selecione uma aula para come√ßar</h2>
                <p id="topic-description">Escolha uma aula no menu lateral para gerar quest√µes personalizadas com IA e conversar com o tutor inteligente</p>
            </div>

            <div class="content-area">
                <!-- Se√ß√£o do Quiz -->
                <div class="quiz-section">
                    <!-- Tela de Boas-vindas -->
                    <div id="welcome-screen" class="welcome-screen">
                        <h2>üöÄ Bem-vindo ao Mundo da Matem√°tica!</h2>
                        <p>
                            Nossa plataforma revolucion√°ria combina intelig√™ncia artificial avan√ßada com educa√ß√£o matem√°tica personalizada. 
                            Explore 21 se√ß√µes com 218 aulas cuidadosamente estruturadas, gere quest√µes inteligentes e converse com nosso tutor IA em tempo real!
                        </p>
                        <div style="display: flex; justify-content: center; gap: 25px; margin-top: 40px;">
                            <div style="text-align: center; padding: 25px; background: #e3f2fd; border-radius: 15px; flex: 1;">
                                <div style="font-size: 28px; margin-bottom: 15px;">üß†</div>
                                <strong>IA Avan√ßada</strong><br>
                                <small>Quest√µes geradas por IA</small>
                            </div>
                            <div style="text-align: center; padding: 25px; background: #f3e5f5; border-radius: 15px; flex: 1;">
                                <div style="font-size: 28px; margin-bottom: 15px;">üí¨</div>
                                <strong>Tutor Inteligente</strong><br>
                                <small>Chat contextual</small>
                            </div>
                            <div style="text-align: center; padding: 25px; background: #e8f5e8; border-radius: 15px; flex: 1;">
                                <div style="font-size: 28px; margin-bottom: 15px;">üéØ</div>
                                <strong>Personalizado</strong><br>
                                <small>5 a 50 quest√µes</small>
                            </div>
                        </div>
                    </div>

                    <!-- Configura√ß√£o do Quiz -->
                    <div id="quiz-setup" class="quiz-setup" style="display: none;">
                        <h3>üéØ Configurar Quiz Inteligente</h3>
                        <div class="form-group">
                            <label for="question-count">Quantidade de Quest√µes:</label>
                            <select id="question-count">
                                <option value="5">5 quest√µes</option>
                                <option value="10">10 quest√µes</option>
                                <option value="15">15 quest√µes</option>
                                <option value="20" selected>20 quest√µes</option>
                                <option value="25">25 quest√µes</option>
                                <option value="30">30 quest√µes</option>
                                <option value="40">40 quest√µes</option>
                                <option value="50">50 quest√µes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="difficulty-level">N√≠vel de Dificuldade:</label>
                            <select id="difficulty-level">
                                <option value="facil">F√°cil</option>
                                <option value="medio" selected>M√©dio</option>
                                <option value="dificil">Dif√≠cil</option>
                            </select>
                        </div>
                        <div style="text-align: center; margin-top: 30px;">
                            <button class="btn btn-primary" onclick="startQuiz()">
                                üöÄ Gerar Quest√µes com IA
                            </button>
                            <button class="btn btn-warning" onclick="startQuiz()" style="display: none;" id="retry-btn">
                                üîÑ Tentar Novamente
                            </button>
                        </div>
                    </div>

                    <!-- √Årea do Quiz -->
                    <div id="quiz-area" style="display: none;">
                        <div class="quiz-container">
                            <div class="quiz-header">
                                <div>
                                    <h3 id="quiz-topic-title">Quiz de Matem√°tica</h3>
                                    <div class="quiz-progress">
                                        <div class="quiz-progress-bar" id="progress-bar"></div>
                                    </div>
                                    <small id="progress-text">Quest√£o 1 de 20</small>
                                </div>
                                <div style="text-align: right;">
                                    <div id="score-display" style="font-size: 18px; font-weight: bold;">
                                        ‚úÖ 0 | ‚ùå 0
                                    </div>
                                    <button class="btn btn-warning" onclick="resetQuiz()" style="margin-top: 10px; padding: 10px 20px; font-size: 14px;">
                                        üîÑ Novo Quiz
                                    </button>
                                </div>
                            </div>

                            <div class="question-container">
                                <div class="question-number" id="question-number">Quest√£o 1</div>
                                <div class="question-text" id="question-text">Carregando quest√£o...</div>
                                <div class="options-container" id="options-container">
                                    <!-- Op√ß√µes ser√£o inseridas aqui -->
                                </div>
                                <div class="explanation" id="explanation">
                                    <h4>üí° Explica√ß√£o:</h4>
                                    <p id="explanation-text"></p>
                                </div>
                                <div style="text-align: center; margin-top: 30px;">
                                    <button class="btn btn-success" id="next-btn" onclick="nextQuestion()" style="display: none;">
                                        Pr√≥xima Quest√£o ‚Üí
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resultados Finais -->
                    <div id="quiz-results" class="quiz-results" style="display: none;">
                        <h2>üéâ Quiz Conclu√≠do!</h2>
                        <div class="result-score" id="final (continua como no original)
                    </div>
                </div>

                <!-- Se√ß√£o do Chat -->
                <div class="chat-section" id="chat-section">
                    <div class="chat-container">
                        <div class="chat-header">
                            <span>üí¨</span>
                            <span>Tutor IA - Matem√°tica</span>
                        </div>
                        
                        <div class="chat-messages" id="chat-messages">
                            <div class="message system">
                                üëã Ol√°! Sou seu tutor de matem√°tica. Tire suas d√∫vidas sobre a quest√£o atual ou qualquer conceito matem√°tico!
                            </div>
                        </div>
                        
                        <div class="typing-indicator" id="typing-indicator">
                            <span>Tutor IA est√° digitando</span>
                            <div class="typing-dots">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                        
                        <div class="chat-input-area">
                            <div class="chat-input-container">
                                <textarea 
                                    id="chat-input" 
                                    class="chat-input" 
                                    placeholder="Digite sua pergunta sobre matem√°tica..."
                                    rows="1"></textarea>
                                <button id="chat-send-btn" class="chat-send-btn" onclick="sendChatMessage()">
                                    ‚û§
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Indicador de Status -->
    <div class="status-indicator" id="status-indicator">
        Gerando quest√µes...
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" style="display: none;">
        <div class="loading-box">
            <div class="spinner"></div>
            <h2>Aguarde um momento...</h2>
            <p>A Intelig√™ncia Artificial est√° gerando suas quest√µes personalizadas. Isso pode levar alguns segundos.</p>
        </div>
    </div>

    <script>
        // Estado da aplica√ß√£o
        let currentTopic = null;
        let currentTopicTitle = null;
        let currentGradeText = null;
        let questions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let score = { correct: 0, incorrect: 0 };
        let selectedAnswer = null;
        let questionCount = 20;
        let difficulty = 'medio';
        let isAnswered = false;
        let chatHistory = [];
        const questionCache = new Map(); // Cache para quest√µes

        // Elementos DOM
        const elements = {
            welcomeScreen: document.getElementById('welcome-screen'),
            quizSetup: document.getElementById('quiz-setup'),
            quizArea: document.getElementById('quiz-area'),
            quizResults: document.getElementById('quiz-results'),
            chatSection: document.getElementById('chat-section'),
            topicTitle: document.getElementById('topic-title'),
            topicDescription: document.getElementById('topic-description'),
            statusIndicator: document.getElementById('status-indicator'),
            loadingOverlay: document.getElementById('loading-overlay'),
            chatMessages: document.getElementById('chat-messages'),
            chatInput: document.getElementById('chat-input'),
            chatSendBtn: document.getElementById('chat-send-btn'),
            typingIndicator: document.getElementById('typing-indicator'),
            retryBtn: document.getElementById('retry-btn')
        };

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            showWelcomeScreen();
        });

        function setupEventListeners() {
            // Menu lateral
            document.querySelectorAll('.grade-header').forEach(header => {
                header.addEventListener('click', function() {
                    this.classList.toggle('active');
                    this.nextElementSibling.classList.toggle('active');
                });
            });

            document.querySelectorAll('.topic-item').forEach(item => {
                item.addEventListener('click', () => selectTopic(item));
            });

            // Configura√ß√µes do quiz
            document.getElementById('question-count').addEventListener('change', function() {
                questionCount = parseInt(this.value);
            });
            
            document.getElementById('difficulty-level').addEventListener('change', function() {
                difficulty = this.value;
            });

            // Chat
            elements.chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });

            elements.chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        }

        function showLoading() {
            elements.loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            elements.loadingOverlay.style.display = 'none';
        }

        function selectTopic(element) {
            // Remove sele√ß√£o anterior
            document.querySelectorAll('.topic-item.selected').forEach(item => item.classList.remove('selected'));
            element.classList.add('selected');
            
            // Atualiza vari√°veis globais
            currentTopic = element.dataset.topic;
            currentTopicTitle = element.textContent.trim();
            const gradeHeader = element.closest('.grade-section').querySelector('.grade-header');
            currentGradeText = gradeHeader.querySelector('div > span:last-of-type').textContent.trim();
            
            // Atualiza interface
            elements.topicTitle.textContent = `üìö ${currentTopicTitle}`;
            elements.topicDescription.textContent = `Se√ß√£o: ${currentGradeText} ‚Ä¢ Pronto para gerar quest√µes e conversar com o tutor IA`;
            
            // Reinicia chat
            resetChat();
            
            showQuizSetup();
            elements.retryBtn.style.display = 'none'; // Esconde o bot√£o "Tentar Novamente" ao selecionar novo t√≥pico
        }

        function showWelcomeScreen() {
            hideAllScreens();
            elements.welcomeScreen.style.display = 'block';
            elements.chatSection.style.display = 'none';
        }

        function showQuizSetup() {
            hideAllScreens();
            elements.quizSetup.style.display = 'block';
            elements.chatSection.style.display = 'none';
        }

        function hideAllScreens() {
            elements.welcomeScreen.style.display = 'none';
            elements.quizSetup.style.display = 'none';
            elements.quizArea.style.display = 'none';
            elements.quizResults.style.display = 'none';
        }

        function showStatus(message, type = 'info') {
            const indicator = elements.statusIndicator;
            indicator.textContent = message;
            indicator.className = `status-indicator show ${type}`;
            setTimeout(() => indicator.classList.remove('show'), 4000);
        }

        async function generateQuestionsWithAI() {
            const cacheKey = `${currentTopic}-${difficulty}-${questionCount}`;
            
            // Verifica cache primeiro
            if (questionCache.has(cacheKey)) {
                showStatus(`‚úÖ Usando ${questionCount} quest√µes do cache para "${currentTopicTitle}"!`, 'success');
                return questionCache.get(cacheKey);
            }

            const prompt = `Voc√™ √© um especialista em matem√°tica. Crie EXATAMENTE ${questionCount} quest√µes de m√∫ltipla escolha sobre "${currentTopicTitle}" da se√ß√£o "${currentGradeText}".

IMPORTANTE: As quest√µes devem ser especificamente sobre o t√≥pico "${currentTopicTitle}", n√£o quest√µes gen√©ricas de matem√°tica.

CARACTER√çSTICAS DAS QUEST√ïES:
- N√≠vel: ${difficulty}
- Todas devem abordar conceitos espec√≠ficos de "${currentTopicTitle}"
- 4 alternativas cada (A, B, C, D)
- Apenas 1 resposta correta
- Explica√ß√£o pedag√≥gica detalhada (m√≠nimo 50 caracteres)
- Use LaTeX: \\( \\) para f√≥rmulas inline, \\[ \\] para f√≥rmulas em bloco
- Cada quest√£o deve conter pelo menos uma palavra-chave relacionada a "${currentTopicTitle}"

EXEMPLOS DE QUEST√ïES PARA "${currentTopicTitle}":
${getTopicSpecificExamples(currentTopic, difficulty)}

RESPONDA APENAS COM O JSON (sem texto adicional):
{
    "questions": [
        {
            "question": "Quest√£o espec√≠fica sobre ${currentTopicTitle}...",
            "options": ["Op√ß√£o A", "Op√ß√£o B", "Op√ß√£o C", "Op√ß√£o D"],
            "correct": 0,
            "explanation": "Explica√ß√£o detalhada..."
        }
    ]
}

Gere ${questionCount} quest√µes agora:`;

            try {
                showStatus(`ü§ñ Gerando ${questionCount} quest√µes espec√≠ficas sobre "${currentTopicTitle}"...`, 'info');
                showLoading();

                const response = await puter.ai.chat([{ role: 'user', content: prompt }]);
                let content = response.message.content.trim();

                // Remove poss√≠veis marca√ß√µes de c√≥digo (```json ... ```)
                content = content.replace(/^```json\n|\n```$/g, '');

                // Tenta parsear o JSON
                let jsonData = JSON.parse(content);

                // Verifica se o JSON cont√©m a chave 'questions'
                if (!jsonData.questions || !Array.isArray(jsonData.questions)) {
                    throw new Error('Resposta da IA n√£o cont√©m um array de quest√µes v√°lido');
                }

                // Valida cada quest√£o
                const validQuestions = jsonData.questions.filter(q => {
                    // Verifica estrutura b√°sica
                    if (!q.question || !q.options || !Array.isArray(q.options) || q.options.length !== 4 ||
                        typeof q.correct !== 'number' || q.correct < 0 || q.correct >= 4 || !q.explanation) {
                        return false;
                    }

                    // Verifica relev√¢ncia (cont√©m palavra-chave do t√≥pico)
                    const topicKeywords = currentTopicTitle.toLowerCase().split(' ');
                    const questionText = q.question.toLowerCase();
                    const hasKeyword = topicKeywords.some(keyword => questionText.includes(keyword));

                    // Verifica se as op√ß√µes s√£o distintas
                    const uniqueOptions = new Set(q.options);
                    const hasUniqueOptions = uniqueOptions.size === 4;

                    // Verifica tamanho m√≠nimo da explica√ß√£o
                    const hasDetailedExplanation = q.explanation.length >= 50;

                    return hasKeyword && hasUniqueOptions && hasDetailedExplanation;
                });

                if (validQuestions.length < questionCount) {
                    console.warn(`A IA gerou apenas ${validQuestions.length} quest√µes v√°lidas. Complementando com fallback.`);
                    showStatus(`‚ö†Ô∏è Apenas ${validQuestions.length} quest√µes v√°lidas geradas. Usando quest√µes padr√£o...`, 'error');
                    elements.retryBtn.style.display = 'inline-block'; // Mostra bot√£o "Tentar Novamente"
                    const fallbackQuestions = generateTopicSpecificQuestions();
                    validQuestions.push(...fallbackQuestions.slice(0, questionCount - validQuestions.length));
                }

                if (validQuestions.length === 0) {
                    throw new Error('Nenhuma quest√£o v√°lida gerada pela IA ou pelo fallback');
                }

                // Armazena no cache
                questionCache.set(cacheKey, validQuestions.slice(0, questionCount));
                
                showStatus(`‚úÖ ${validQuestions.length} quest√µes geradas para "${currentTopicTitle}"!`, 'success');
                return validQuestions.slice(0, questionCount);

            } catch (error) {
                console.error('Erro ao gerar quest√µes:', error);
                showStatus('‚ö†Ô∏è Erro ao gerar quest√µes. Usando quest√µes padr√£o...', 'error');
                elements.retryBtn.style.display = 'inline-block'; // Mostra bot√£o "Tentar Novamente"
                const fallbackQuestions = generateTopicSpecificQuestions();
                questionCache.set(cacheKey, fallbackQuestions);
                return fallbackQuestions;
            } finally {
                hideLoading();
            }
        }

        function getTopicSpecificExamples(topic, difficulty) {
            const examples = {
                'series-numericas-infinitas': `Quest√µes sobre converg√™ncia, diverg√™ncia, s√©ries geom√©tricas, s√©ries harm√¥nicas, testes de converg√™ncia. Exemplo: "Qual √© a soma da s√©rie \\( \\sum_{n=0}^{\\infty} \\frac{1}{3^n} \\)?"`,
                'teorema-resto-chines': `Quest√µes sobre sistemas de congru√™ncias, n√∫meros coprimos, aplica√ß√µes do teorema. Exemplo: "Resolva \\( x \\equiv 1 \\pmod{3}, x \\equiv 2 \\pmod{5} \\)."`,
                'numeros-primos-mersenne': `Quest√µes sobre n√∫meros de Mersenne, primalidade, f√≥rmula 2^p - 1. Exemplo: "Qual n√∫mero de Mersenne √© dado por \\( 2^5 - 1 \\)?"`,
                'fibonacci-natureza': `Quest√µes sobre sequ√™ncia de Fibonacci, propor√ß√£o √°urea, padr√µes na natureza. Exemplo: "Qual √© o 10¬∫ termo da sequ√™ncia de Fibonacci?"`,
                'geometria-fractal-natureza': `Quest√µes sobre fractais, dimens√£o fractal, auto-similaridade. Exemplo: "Qual √© a dimens√£o fractal de um floco de neve de Koch?"`,
                'estatistica-descritiva': `Quest√µes sobre m√©dia, mediana, moda, desvio padr√£o, quartis. Exemplo: "Calcule a mediana dos dados: 3, 7, 1, 9, 5."`,
                'probabilidade-dados': `Quest√µes sobre eventos, probabilidade condicional, regra do produto. Exemplo: "Qual a probabilidade de tirar um 6 em um dado justo?"`,
                'teorema-pitagoras': `Quest√µes sobre o teorema de Pit√°goras e trigonometria b√°sica. Exemplo: "Em um tri√¢ngulo ret√¢ngulo com catetos 3 e 4, qual √© a hipotenusa?"`,
                'teorema-binomial': `Quest√µes sobre expans√£o binomial e coeficientes. Exemplo: "Qual √© o coeficiente de \\( x^2 \\) em \\( (x + 1)^4 \\)?"`,
                'numeros-complexos': `Quest√µes sobre n√∫meros complexos, forma polar, opera√ß√µes. Exemplo: "Qual √© o m√≥dulo de \\( 3 + 4i \\)?"`,
                // Adicione mais t√≥picos conforme necess√°rio
                'default': `Quest√µes conceituais e pr√°ticas espec√≠ficas do t√≥pico "${currentTopicTitle}". Exemplo: "Explique um conceito fundamental de ${currentTopicTitle}."`
            };
            
            return examples[topic] || examples['default'];
        }

        function generateTopicSpecificQuestions() {
            const topicQuestions = {
                'series-numericas-infinitas': [
                    {
                        question: "Qual √© a soma da s√©rie geom√©trica infinita \\( \\sum_{n=0}^{\\infty} \\frac{1}{2^n} \\)?",
                        options: ["1", "2", "1/2", "Infinito"],
                        correct: 1,
                        explanation: "Para uma s√©rie geom√©trica \\( \\sum_{n=0}^{\\infty} ar^n \\) com \\( |r| < 1 \\), a soma √© \\( \\frac{a}{1-r} \\). Aqui, \\( a = 1 \\) e \\( r = \\frac{1}{2} \\), ent√£o a soma √© \\( \\frac{1}{1-\\frac{1}{2}} = 2 \\)."
                    },
                    {
                        question: "A s√©rie harm√¥nica \\( \\sum_{n=1}^{\\infty} \\frac{1}{n} \\) √©:",
                        options: ["Convergente para 1", "Convergente para e", "Divergente", "Convergente para œÄ"],
                        correct: 2,
                        explanation: "A s√©rie harm√¥nica \\( \\sum_{n=1}^{\\infty} \\frac{1}{n} = 1 + \\frac{1}{2} + \\frac{1}{3} + \\frac{1}{4} + ... \\) √© divergente, pois sua soma tende ao infinito."
                    },
                    {
                        question: "Qual teste pode ser usado para determinar a converg√™ncia da s√©rie \\( \\sum_{n=1}^{\\infty} \\frac{1}{n^2} \\)?",
                        options: ["Teste da diverg√™ncia", "Teste da integral", "Teste da raz√£o", "Teste da raiz"],
                        correct: 1,
                        explanation: "O teste da integral pode ser usado, pois \\( \\int_1^\\infty \\frac{1}{x^2} dx \\) converge para 1, indicando que a s√©rie \\( \\sum_{n=1}^{\\infty} \\frac{1}{n^2} \\) tamb√©m converge."
                    }
                ],
                'teorema-resto-chines': [
                    {
                        question: "Se \\( x \\equiv 2 \\pmod{3} \\) e \\( x \\equiv 3 \\pmod{5} \\), qual √© o menor valor positivo de x?",
                        options: ["8", "11", "14", "17"],
                        correct: 0,
                        explanation: "Usando o Teorema do Resto Chin√™s: x = 3k + 2 para algum k. Substituindo na segunda congru√™ncia: \\( 3k + 2 \\equiv 3 \\pmod{5} \\), ent√£o \\( 3k \\equiv 1 \\pmod{5} \\). O inverso modular de 3 m√≥dulo 5 √© 2, pois \\( 3 \\cdot 2 = 6 \\equiv 1 \\pmod{5} \\). Assim, \\( k \\equiv 2 \\pmod{5} \\), e \\( x = 3 \\cdot 2 + 2 = 8 \\)."
                    },
                    {
                        question: "Qual √© a solu√ß√£o de \\( x \\equiv 1 \\pmod{4} \\) e \\( x \\equiv 2 \\pmod{7} \\)?",
                        options: ["9", "15", "29", "37"],
                        correct: 2,
                        explanation: "Escrevemos \\( x = 4k + 1 \\). Substitu√≠mos na segunda congru√™ncia: \\( 4k + 1 \\equiv 2 \\pmod{7} \\), ou \\( 4k \\equiv 1 \\pmod{7} \\). O inverso de 4 m√≥dulo 7 √© 2, pois \\( 4 \\cdot 2 = 8 \\equiv 1 \\pmod{7} \\). Assim, \\( k \\equiv 2 \\pmod{7} \\), ent√£o \\( x = 4 \\cdot 2 + 1 = 9 \\). Como o m√≥dulo LCM(4,7) = 28, a solu√ß√£o geral √© \\( x \\equiv 9 \\pmod{28} \\), e a pr√≥xima solu√ß√£o positiva √© \\( 9 + 28 = 29 \\)."
                    }
                ],
                'fibonacci-natureza': [
                    {
                        question: "Qual √© o oitavo termo da sequ√™ncia de Fibonacci, come√ßando com \\( F_1 = 1, F_2 = 1 \\)?",
                        options: ["13", "21", "34", "55"],
                        correct: 1,
                        explanation: "A sequ√™ncia de Fibonacci √©: \\( 1, 1, 2, 3, 5, 8, 13, 21, ... \\). O oitavo termo √© \\( F_8 = 21 \\)."
                    },
                    {
                        question: "Qual √© a raz√£o entre dois termos consecutivos da sequ√™ncia de Fibonacci √† medida que \\( n \\) cresce?",
                        options: ["\\( \\sqrt{2} \\)", "\\( \\frac{1 + \\sqrt{5}}{2} \\)", "\\( e \\)", "\\( \\pi \\)"],
                        correct: 1,
                        explanation: "A raz√£o entre termos consecutivos da sequ√™ncia de Fibonacci, \\( F_{n+1}/F_n \\), converge para a propor√ß√£o √°urea \\( \\phi = \\frac{1 + \\sqrt{5}}{2} \\approx 1,618 \\) √† medida que \\( n \\) tende ao infinito."
                    }
                ],
                'teorema-pitagoras': [
                    {
                        question: "Em um tri√¢ngulo ret√¢ngulo com catetos de comprimento 3 e 4, qual √© o comprimento da hipotenusa?",
                        options: ["5", "6", "7", "8"],
                        correct: 0,
                        explanation: "Pelo Teorema de Pit√°goras, \\( a^2 + b^2 = c^2 \\), onde \\( a \\) e \\( b \\) s√£o os catetos e \\( c \\) √© a hipotenusa. Assim, \\( 3^2 + 4^2 = 9 + 16 = 25 \\), e \\( c = \\sqrt{25} = 5 \\)."
                    }
                ],
                'numeros-complexos': [
                    {
                        question: "Qual √© o m√≥dulo do n√∫mero complexo \\( 3 + 4i \\)?",
                        options: ["5", "7", "25", "16"],
                        correct: 0,
                        explanation: "O m√≥dulo de um n√∫mero complexo \\( a + bi \\) √© dado por \\( \\sqrt{a^2 + b^2} \\). Para \\( 3 + 4i \\), temos \\( \\sqrt{3^2 + 4^2} = \\sqrt{9 + 16} = \\sqrt{25} = 5 \\)."
                    }
                ]
                // Adicione mais t√≥picos conforme necess√°rio
            };
            
            let selectedQuestions = topicQuestions[currentTopic] || [];
            
            // Se n√£o h√° quest√µes espec√≠ficas, gera quest√µes padr√£o baseadas no t√≥pico
            if (selectedQuestions.length === 0) {
                selectedQuestions = [];
                for (let i = 1; i <= questionCount; i++) {
                    selectedQuestions.push({
                        question: `Quest√£o ${i} sobre ${currentTopicTitle}: Qual √© um conceito fundamental de ${currentTopicTitle}?`,
                        options: [
                            `Conceito A relacionado a ${currentTopicTitle}`,
                            `Conceito B relacionado a ${currentTopicTitle}`,
                            `Conceito C relacionado a ${currentTopicTitle}`,
                            `Conceito D relacionado a ${currentTopicTitle}`
                        ],
                        correct: 0,
                        explanation: `Esta quest√£o aborda um conceito fundamental de ${currentTopicTitle}. Para dominar este t√≥pico, estude os conceitos b√°sicos e suas aplica√ß√µes pr√°ticas.`
                    });
                }
            }
            
            // Ajusta o n√∫mero de quest√µes
            while (selectedQuestions.length < questionCount) {
                selectedQuestions = [...selectedQuestions, ...selectedQuestions];
            }
            
            return selectedQuestions.slice(0, questionCount);
        }

        async function startQuiz() {
            if (!currentTopic) {
                alert('Por favor, selecione uma aula primeiro!');
                return;
            }
            
            showLoading();
            try {
                questions = await generateQuestionsWithAI();
                
                if (!questions || questions.length === 0) {
                    alert('N√£o foi poss√≠vel gerar as quest√µes. Tente novamente.');
                    elements.retryBtn.style.display = 'inline-block';
                    return;
                }
                
                // Reinicia estado do quiz
                currentQuestionIndex = 0;
                userAnswers = [];
                score = { correct: 0, incorrect: 0 };
                
                // Mostra quiz e chat
                hideAllScreens();
                elements.quizArea.style.display = 'block';
                elements.chatSection.style.display = 'flex';
                
                updateQuizHeader();
                displayQuestion();
                
                // Atualiza chat com contexto
                addChatMessage('system', `üí° Quiz iniciado sobre "${currentTopicTitle}". Pode me perguntar sobre qualquer conceito ou quest√£o!`);

            } finally {
                hideLoading();
            }
        }

        function updateQuizHeader() {
            document.getElementById('quiz-topic-title').textContent = `üìö ${currentTopicTitle}`;
            updateProgress();
            updateScore();
        }

        function updateProgress() {
            const progress = ((currentQuestionIndex) / questions.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('progress-text').textContent = `Quest√£o ${currentQuestionIndex + 1} de ${questions.length}`;
        }

        function updateScore() {
            document.getElementById('score-display').innerHTML = `‚úÖ ${score.correct} | ‚ùå ${score.incorrect}`;
        }

        function displayQuestion() {
            if (currentQuestionIndex >= questions.length) {
                showResults();
                return;
            }
            
            const question = questions[currentQuestionIndex];
            document.getElementById('question-number').textContent = `Quest√£o ${currentQuestionIndex + 1}`;
            document.getElementById('question-text').innerHTML = question.question;
            
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.innerHTML = `
                    <div class="option-letter">${String.fromCharCode(65 + index)}</div>
                    <div>${option}</div>
                `;
                optionDiv.addEventListener('click', () => selectAnswer(index, optionDiv));
                optionsContainer.appendChild(optionDiv);
            });
            
            selectedAnswer = null;
            isAnswered = false;
            document.getElementById('explanation').classList.remove('show');
            document.getElementById('next-btn').style.display = 'none';
            updateProgress();
            
            // Renderiza f√≥rmulas matem√°ticas
            if (window.MathJax) {
                MathJax.typesetPromise([document.getElementById('question-text'), optionsContainer]).catch(err => console.log(err));
            }
        }

        function selectAnswer(answerIndex, optionElement) {
            if (isAnswered) return;
            isAnswered = true;
            
            const question = questions[currentQuestionIndex];
            const isCorrect = answerIndex === question.correct;
            
            // Marca todas as op√ß√µes
            const options = document.querySelectorAll('.option');
            options.forEach((option, index) => {
                option.style.pointerEvents = 'none';
                if (index === question.correct) {
                    option.classList.add('correct');
                } else if (index === answerIndex && !isCorrect) {
                    option.classList.add('incorrect');
                }
            });
            
            // Atualiza pontua√ß√£o
            if (isCorrect) {
                score.correct++;
                showStatus('‚úÖ Resposta correta!', 'success');
            } else {
                score.incorrect++;
                showStatus('‚ùå Resposta incorreta', 'error');
            }
            
            userAnswers.push({ 
                questionIndex: currentQuestionIndex, 
                selectedAnswer: answerIndex, 
                correct: isCorrect 
            });
            
            // Mostra explica√ß√£o
            document.getElementById('explanation-text').innerHTML = question.explanation;
            document.getElementById('explanation').classList.add('show');
            document.getElementById('next-btn').style.display = 'inline-block';
            updateScore();
            
            // Renderiza f√≥rmulas matem√°ticas na explica√ß√£o
            if (window.MathJax) {
                MathJax.typesetPromise([document.getElementById('explanation')]).catch(err => console.log(err));
            }
        }

        function nextQuestion() {
            currentQuestionIndex++;
            displayQuestion();
        }

        function showResults() {
            hideAllScreens();
            elements.quizResults.style.display = 'block';
            elements.chatSection.style.display = 'flex';
            
            const percentage = Math.round((score.correct / questions.length) * 100);
            const finalScoreEl = document.getElementById('final-score');
            const resultMessageEl = document.getElementById('result-message');
            
            finalScoreEl.textContent = `${percentage}%`;
            
            if (percentage >= 80) {
                finalScoreEl.className = 'result-score excellent';
                resultMessageEl.textContent = 'üéâ Excelente! Voc√™ domina este t√≥pico!';
            } else if (percentage >= 60) {
                finalScoreEl.className = 'result-score good';
                resultMessageEl.textContent = 'üëç Bom trabalho! Continue praticando!';
            } else {
                finalScoreEl.className = 'result-score needs-improvement';
                resultMessageEl.textContent = 'üìö Continue estudando. A pr√°tica leva √† perfei√ß√£o!';
            }
            
            document.getElementById('correct-count').textContent = score.correct;
            document.getElementById('incorrect-count').textContent = score.incorrect;
            document.getElementById('total-count').textContent = questions.length;
            
            // Atualiza chat
            addChatMessage('system', `üéØ Quiz finalizado! Voc√™ acertou ${score.correct} de ${questions.length} quest√µes (${percentage}%). Parab√©ns!`);
        }

        function restartSameTopic() {
            if (currentTopic) {
                startQuiz();
            }
        }

        function resetQuiz() {
            currentTopic = null;
            currentTopicTitle = null;
            currentGradeText = null;
            
            document.querySelectorAll('.topic-item.selected').forEach(item => item.classList.remove('selected'));
            elements.topicTitle.textContent = 'üéØ Selecione uma aula para come√ßar';
            elements.topicDescription.textContent = 'Escolha uma aula no menu lateral para gerar quest√µes personalizadas com IA e conversar com o tutor inteligente';
            
            resetChat();
            showWelcomeScreen();
        }

        // === SISTEMA DE CHAT ===
        
        function resetChat() {
            chatHistory = [];
            elements.chatMessages.innerHTML = `
                <div class="message system">
                    üëã Ol√°! Sou seu tutor de matem√°tica. Tire suas d√∫vidas sobre a quest√£o atual ou qualquer conceito matem√°tico!
                </div>
            `;
        }

        function addChatMessage(type, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = content;
            elements.chatMessages.appendChild(messageDiv);
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            
            // Renderiza f√≥rmulas matem√°ticas no chat
            if (window.MathJax && type === 'assistant') {
                MathJax.typesetPromise([messageDiv]).catch(err => console.log(err));
            }
        }

        async function sendChatMessage() {
            const message = elements.chatInput.value.trim();
            if (!message) return;
            
            // Adiciona mensagem do usu√°rio
            addChatMessage('user', message);
            elements.chatInput.value = '';
            elements.chatInput.style.height = 'auto';
            
            // Desabilita bot√£o e mostra indicador
            elements.chatSendBtn.disabled = true;
            elements.typingIndicator.style.display = 'flex';
            
            try {
                // Constr√≥i contexto
                let context = `Voc√™ √© um tutor de matem√°tica especializado. `;
                
                if (currentTopic && currentTopicTitle) {
                    context += `O estudante est√° estudando "${currentTopicTitle}" na se√ß√£o "${currentGradeText}". `;
                }
                
                if (questions.length > 0 && currentQuestionIndex < questions.length) {
                    const currentQuestion = questions[currentQuestionIndex];
                    context += `A quest√£o atual √©: "${currentQuestion.question}" com op√ß√µes: ${currentQuestion.options.join(', ')}. `;
                }
                
                context += `Responda de forma clara, pedag√≥gica e encorajadora. Use exemplos quando apropriado. Use nota√ß√£o LaTeX para f√≥rmulas matem√°ticas entre \\( \\) para inline e \\[ \\] para bloco.`;
                
                // Monta hist√≥rico da conversa
                const chatMessages = [
                    { role: 'system', content: context },
                    ...chatHistory,
                    { role: 'user', content: message }
                ];
                
                // Chama IA
                const response = await puter.ai.chat(chatMessages);
                const aiResponse = response.message.content;
                
                // Adiciona resposta da IA
                addChatMessage('assistant', aiResponse);
                
                // Atualiza hist√≥rico
                chatHistory.push({ role: 'user', content: message });
                chatHistory.push({ role: 'assistant', content: aiResponse });
                
                // Mant√©m apenas √∫ltimas 10 trocas
                if (chatHistory.length > 20) {
                    chatHistory = chatHistory.slice(-20);
                }
                
            } catch (error) {
                console.error('Erro no chat:', error);
                addChatMessage('assistant', 'Desculpe, ocorreu um erro. Tente novamente!');
            } finally {
                elements.chatSendBtn.disabled = false;
                elements.typingIndicator.style.display = 'none';
            }
        }
    </script>
</body>
</html>
