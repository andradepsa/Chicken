<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gerador de Artigo Cient√≠fico ABNT</title>
    <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.42.0/build/docxtemplater.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Arial&display=swap');
        body { background-color: #e0e0e0; font-family: Arial, sans-serif; padding: 20px; }
        .main-container { display: flex; justify-content: center; align-items: flex-start; gap: 20px; }
        
        @page {
            size: A4;
            margin-top: 3cm;
            margin-bottom: 2cm;
            margin-left: 3cm;
            margin-right: 2cm;
            @bottom-center {
                content: element(footer);
                font-family: Arial, sans-serif;
                font-size: 10pt;
                color: #000;
                text-align: center;
            }
        }
        #footer { position: running(footer); font-family: Arial, sans-serif; font-size: 10pt; text-align: center; width: 100%; display: none; }

        @media print {
            body { background-color: #fff; padding: 0; margin: 0; }
            .control-panel, #reference-modal, #save-controls { display: none !important; }
            .page-container { box-shadow: none; margin: 0; padding: 0; width: 100%; min-height: auto; border: none; }
            .email-autor { display: none !important; }
            #footer { display: block; }
        }
        
        .control-panel { position: sticky; top: 20px; width: 400px; background: #f9f9f9; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 10; }
        .control-panel h2 { margin-top: 0; text-align: center; color: #333; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group button, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        .control-panel button { background-color: #1a73e8; color: white; font-weight: bold; cursor: pointer; }
        .control-panel button:hover { background-color: #1765cc; }
        .control-panel button:disabled { background-color: #999; cursor: not-allowed; }
        #interactive-controls button { margin-top: 10px; }
        #continueBtn { background-color: #28a745; }
        #continueBtn:hover { background-color: #218838; }
        #concludeBtn { background-color: #fd7e14; }
        #concludeBtn:hover { background-color: #e8681b; }
        #finalizeBtn { background-color: #ffc107; color: black; }
        #finalizeBtn:hover { background-color: #e0a800; }
        #finishBtn { background-color: #dc3545; }
        #finishBtn:hover { background-color: #c82333; }
        #testApiBtn { background-color: #17a2b8; margin-bottom: 10px; }
        #testApiBtn:hover { background-color: #138496; }
        #status { font-weight: bold; text-align: center; margin-top: 10px; min-height: 20px; font-size: 12px; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        .api-config { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin: 10px 0; border-radius: 4px; }
        .api-config.active { background: #e7f3ff; border-color: #0066cc; }
        .fallback-info { background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin: 10px 0; border-radius: 4px; font-size: 12px; }
        
        .page-container { width: 21cm; min-height: 29.7cm; padding: 3cm 2cm 2cm 3cm; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.5); box-sizing: border-box; }
        
        .abnt-content { font-family: Arial, sans-serif; font-size: 12pt; line-height: 1.5; text-align: justify; }
        .nome-universidade { text-align: center; font-size: 12pt; font-weight: bold; margin-bottom: 2em; }
        .titulo-trabalho { font-size: 14pt; text-align: center; font-weight: bold; text-transform: none; margin-bottom: 2em; }
        .autor { text-align: center; font-size: 12pt; margin-bottom: 1em; }
        .autor sup { font-size: 10pt; }
        .email-autor { text-align: left; font-size: 10pt; margin-top: 2em; border-top: 1px solid #000; padding-top: 10px; }
        .resumo-titulo { font-weight: bold; text-align: left; font-size: 12pt; margin-top: 2em; margin-bottom: 1em; }
        .resumo-texto { text-align: justify; margin-bottom: 1em; }
        .palavras-chave { text-align: left; margin-bottom: 2em; }
        .palavras-chave strong { font-weight: bold; }
        .abstract-titulo { font-weight: bold; font-style: italic; text-align: left; font-size: 12pt; margin-top: 1em; margin-bottom: 1em; }
        .keywords { text-align: left; margin-bottom: 2em; }
        .keywords strong { font-weight: bold; font-style: italic; }
        .section-title { font-weight: bold; text-transform: uppercase; text-align: left; font-size: 12pt; margin-top: 2em; margin-bottom: 1em; }
        .abnt-content p { margin-bottom: 1.5em; cursor: pointer; text-indent: 1.25cm; line-height: 1.5; text-align: justify; }
        .abnt-content p:hover { background-color: #f0f8ff; }
        .no-indent { text-indent: 0 !important; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 700px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .modal-content h3 { margin-top: 0; }
        .modal-content ul { list-style: none; padding: 0; }
        .modal-content li { margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .modal-content li label { cursor: pointer; font-size: 14px; line-height: 1.4; }
        .modal-content button { margin-top: 10px; background: #1a73e8; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        .modal-content button:hover { background: #1765cc; }
        .modal-content .close-btn { background: #dc3545; }
        .modal-content .close-btn:hover { background: #c82333; }
        .search-info { background: #e8f4f8; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 13px; }
        .no-results { background: #fff3cd; padding: 15px; border-radius: 4px; color: #856404; }
        .duplicate-warning { background: #f8d7da; padding: 10px; border-radius: 4px; margin-bottom: 10px; color: #721c24; font-size: 12px; }
        .citation-example { background: #e7f3ff; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 12px; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="control-panel">
            <div id="initial-form">
                <h2>üéì Gerador de Artigo ABNT</h2>
                
                <div class="form-group">
                    <label>Universidade:</label>
                    <input id="universidade" type="text" value="Universidade Federal">
                </div>
                <div class="form-group">
                    <label>T√≠tulo do Trabalho:</label>
                    <input id="titulo" type="text" placeholder="T√≠tulo do seu artigo cient√≠fico">
                </div>
                <div class="form-group">
                    <label>Autor(es):</label>
                    <input id="autor" type="text" placeholder="Nome Sobrenome">
                </div>
                <div class="form-group">
                    <label>Email do Autor:</label>
                    <input id="email" type="email" value="seu.email@exemplo.com">
                </div>

                <div class="form-group">
                    <label>ü§ñ Modo de Gera√ß√£o:</label>
                    <select id="apiProvider">
                        <option value="gemini">Google Gemini (Recomendado)</option>
                        <option value="offline">Modo Offline (Sempre funciona)</option>
                        <option value="custom">Inserir texto manualmente</option>
                    </select>
                </div>

                <div id="gemini-config" class="api-config active">
                    <label>üîë Chave API Gemini:</label>
                    <input id="geminiApiKey" type="password" placeholder="Cole sua chave AIzaSy...">
                    <button id="testApiBtn">üß™ Testar API</button>
                    <div class="fallback-info">
                        üí° <strong>Problemas com API?</strong><br>
                        ‚Ä¢ Regenere a chave no Google AI Studio<br>
                        ‚Ä¢ Aguarde 10 minutos ap√≥s criar<br>
                        ‚Ä¢ Use modo offline como backup
                    </div>
                </div>

                <div id="offline-config" class="api-config" style="display: none;">
                    <label>üìù Tema/√Årea do artigo:</label>
                    <input id="tema" type="text" placeholder="Ex: Intelig√™ncia Artificial, Educa√ß√£o, Tecnologia">
                    <div class="fallback-info">
                        ‚úÖ <strong>Modo Offline:</strong> Gera conte√∫do usando templates acad√™micos pr√©-definidos. Sempre funciona!
                    </div>
                </div>

                <div id="custom-config" class="api-config" style="display: none;">
                    <label>‚úèÔ∏è Seu pr√≥prio texto de introdu√ß√£o:</label>
                    <textarea id="customText" rows="4" placeholder="Digite ou cole seu pr√≥prio par√°grafo de introdu√ß√£o..."></textarea>
                    <div class="fallback-info">
                        ‚úèÔ∏è <strong>Modo Manual:</strong> Use seu pr√≥prio texto ou conte√∫do de outras IAs.
                    </div>
                </div>

                <button id="startBtn">üöÄ Iniciar Artigo Cient√≠fico</button>
                
                <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;">
                    ‚úÖ Sistema AUTOR-DATA + Bibliografia autom√°tica<br>
                    ‚úÖ Formata√ß√£o ABNT rigorosa + M√∫ltiplas op√ß√µes
                </div>
            </div>
            
            <div id="interactive-controls" style="display: none;">
                <h2>üìù Modo Interativo</h2>
                <p>Trabalhando em: <strong id="current-section-name"></strong></p>
                <button id="continueBtn">‚ûï Adicionar Par√°grafo</button>
                <button id="concludeBtn">üîö Finalizar Se√ß√£o</button>
                <button id="finalizeBtn">‚è≠ Pr√≥xima Se√ß√£o</button>
                <button id="finishBtn" style="display: none;">‚úÖ Finalizar Artigo</button>
                <div style="text-align: center; margin-top: 10px; font-size: 11px; color: #666;">
                    üí° Clique nos par√°grafos para adicionar refer√™ncias
                </div>
            </div>

            <div id="save-controls" style="margin-top: 20px; border-top: 1px solid #ccc; padding-top: 15px;">
                <h2>üíæ Salvar Artigo</h2>
                <div class="form-group">
                    <button id="savePdfBtn">üìÑ Salvar como PDF</button>
                </div>
                <div class="form-group">
                  
                </div>
            </div>

            <div id="status" class="info">
                üéØ Escolha o modo de gera√ß√£o e preencha os dados
            </div>
        </div>
        
        <div class="page-container">
            <div class="abnt-content" id="content-output">
                <p style="text-align:center; color: #777; padding-top: 0;">
                    <!-- INSTRU√á√ïES ADICIONADAS AQUI -->
                    üìÑ <strong>Para Come√ßar:</strong><br><br>
                    <strong>1. Preencha os Dados:</strong> T√≠tulo e Autor s√£o essenciais.<br>
                    <strong>2. Escolha o Modo de Gera√ß√£o:</strong> Para o modo <strong>Gemini</strong>, voc√™ precisa de uma <strong>Chave API</strong> do Google AI Studio.<br>
                    <strong>3. Inicie o Artigo:</strong> Clique no bot√£o <strong>üöÄ Iniciar Artigo Cient√≠fico</strong>.<br><br>
                    ---<br><br>
                    ‚úÖ Formata√ß√£o ABNT rigorosa<br>
                    ‚úÖ Sistema AUTOR-DATA autom√°tico<br>
                    ‚úÖ M√∫ltiplas op√ß√µes de gera√ß√£o
                </p>
            </div>
            <div id="footer"></div>
        </div>
        
        <div id="reference-modal" class="modal">
            <div class="modal-content">
                <h3>üìö Adicionar Refer√™ncias AUTOR-DATA</h3>
                <div class="citation-example">
                    <strong>üìñ Exemplo de cita√ß√£o no par√°grafo:</strong><br>
                    "...crucial para o avan√ßo cient√≠fico e tecnol√≥gico (SILVA; SANTOS, 2023)."<br>
                    <em>As refer√™ncias ser√£o automaticamente adicionadas √† bibliografia final.</em>
                </div>
                <div id="search-info" class="search-info" style="display: none;"></div>
                <div id="duplicate-warning" class="duplicate-warning" style="display: none;"></div>
                <p>Selecione as refer√™ncias para adicionar ao final do par√°grafo:</p>
                <ul id="reference-list"></ul>
                <button id="add-references-btn">‚úÖ Adicionar ao Final do Par√°grafo</button>
                <button class="close-btn" id="close-modal-btn">‚ùå Fechar</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO DA API (MANTENHA SUA CHAVE AQUI) ---
        const GEMINI_API_KEY = "CHAVE AQUI";
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;

        // --- ELEMENTOS DA UI ---
        const elements = {
            apiProvider: document.getElementById('apiProvider'),
            testApiBtn: document.getElementById('testApiBtn'),
            startBtn: document.getElementById('startBtn'),
            continueBtn: document.getElementById('continueBtn'),
            concludeBtn: document.getElementById('concludeBtn'),
            finalizeBtn: document.getElementById('finalizeBtn'),
            finishBtn: document.getElementById('finishBtn'),
            outputDiv: document.getElementById('content-output'),
            statusDiv: document.getElementById('status'),
            currentSectionNameSpan: document.getElementById('current-section-name'),
            referenceModal: document.getElementById('reference-modal'),
            referenceList: document.getElementById('reference-list'),
            addReferencesBtn: document.getElementById('add-references-btn'),
            closeModalBtn: document.getElementById('close-modal-btn'),
            searchInfoDiv: document.getElementById('search-info'),
            duplicateWarningDiv: document.getElementById('duplicate-warning'),
            savePdfBtn: document.getElementById('savePdfBtn'),
            saveDocBtn: document.getElementById('saveDocBtn'),
            footerDiv: document.getElementById('footer'),
            geminiConfig: document.getElementById('gemini-config'),
            offlineConfig: document.getElementById('offline-config'),
            customConfig: document.getElementById('custom-config')
        };

        // --- ESTADO DA APLICA√á√ÉO ---
        let userInputs = {};
        let articleContent = { introducao: [], desenvolvimento: [], conclusao: [] };
        let finalReferences = []; 
        let currentParagraphId = null;
        let currentSection = 'introducao';
        let sectionOrder = ['introducao', 'desenvolvimento', 'conclusao'];
        let apiTested = false;

        // --- TEMPLATES OFFLINE ---
        const offlineTemplates = {
            'inteligencia artificial': {
                intro: 'A intelig√™ncia artificial representa uma das mais significativas revolu√ß√µes tecnol√≥gicas da era contempor√¢nea, transformando fundamentalmente a maneira como processamos informa√ß√µes e automatizamos tarefas complexas. O desenvolvimento de sistemas inteligentes capazes de simular capacidades cognitivas humanas tem impacto direto em diversas √°reas do conhecimento, desde a medicina e educa√ß√£o at√© a ind√∫stria e servi√ßos financeiros. A crescente integra√ß√£o de algoritmos de aprendizado de m√°quina e redes neurais artificiais em aplica√ß√µes cotidianas evidencia a necessidade de compreender profundamente os mecanismos, potencialidades e desafios inerentes a essa tecnologia emergente.',
                desenvolvimento: 'Os sistemas de intelig√™ncia artificial baseiam-se em complexos algoritmos matem√°ticos que permitem o processamento e an√°lise de grandes volumes de dados de forma automatizada. Atrav√©s de t√©cnicas como aprendizado supervisionado, n√£o supervisionado e por refor√ßo, esses sistemas desenvolvem a capacidade de reconhecer padr√µes, fazer predi√ß√µes e tomar decis√µes com graus crescentes de autonomia. A implementa√ß√£o de redes neurais profundas tem revolucionado √°reas como reconhecimento de imagens, processamento de linguagem natural e an√°lise preditiva, demonstrando resultados que frequentemente superam a performance humana em tarefas espec√≠ficas.',
                conclusao: 'A intelig√™ncia artificial configura-se como um campo de conhecimento em constante expans√£o, com potencial para transformar significativamente a sociedade contempor√¢nea. Os avan√ßos tecnol√≥gicos observados nas √∫ltimas d√©cadas evidenciam a necessidade de desenvolvimento de frameworks √©ticos e regulat√≥rios adequados para garantir o uso respons√°vel dessas tecnologias. O futuro da intelig√™ncia artificial depender√° da capacidade de equilibrar inova√ß√£o tecnol√≥gica com considera√ß√µes sociais, econ√¥micas e √©ticas, promovendo o desenvolvimento sustent√°vel e inclusivo da sociedade digital.'
            },
            'educacao': {
                intro: 'A educa√ß√£o constitui um dos pilares fundamentais para o desenvolvimento humano e social, desempenhando papel crucial na forma√ß√£o de indiv√≠duos capazes de contribuir efetivamente para a sociedade. No contexto contempor√¢neo, caracterizado por r√°pidas transforma√ß√µes tecnol√≥gicas e sociais, os sistemas educacionais enfrentam desafios sem precedentes que demandam abordagens inovadoras e adaptativas. A necessidade de preparar estudantes para um mercado de trabalho em constante evolu√ß√£o, aliada √†s demandas por inclus√£o e equidade, torna imperativo o repensar das pr√°ticas pedag√≥gicas tradicionais e a incorpora√ß√£o de metodologias que promovam o desenvolvimento de compet√™ncias do s√©culo XXI.',
                desenvolvimento: 'As metodologias ativas de ensino-aprendizagem emergem como alternativas promissoras para superar as limita√ß√µes dos modelos educacionais tradicionais centrados na transmiss√£o passiva de conhecimento. Estrat√©gias como aprendizagem baseada em problemas, sala de aula invertida e gamifica√ß√£o proporcionam aos estudantes oportunidades de participa√ß√£o ativa no processo educativo, favorecendo o desenvolvimento do pensamento cr√≠tico e da capacidade de resolu√ß√£o de problemas. A integra√ß√£o de tecnologias digitais no ambiente educacional amplia as possibilidades de personaliza√ß√£o do ensino, permitindo a adapta√ß√£o dos conte√∫dos e metodologias √†s necessidades individuais dos estudantes.',
                conclusao: 'A transforma√ß√£o dos sistemas educacionais representa um desafio complexo que requer o engajamento de m√∫ltiplos atores sociais, incluindo educadores, gestores, estudantes e a comunidade em geral. A implementa√ß√£o bem-sucedida de inova√ß√µes educacionais depende n√£o apenas de recursos tecnol√≥gicos e metodol√≥gicos, mas tamb√©m de mudan√ßas culturais e estruturais que favore√ßam a cria√ß√£o de ambientes de aprendizagem mais din√¢micos e inclusivos. O futuro da educa√ß√£o ser√° constru√≠do atrav√©s da colabora√ß√£o entre tradi√ß√£o e inova√ß√£o, preservando os valores educacionais essenciais enquanto se adapta √†s demandas de um mundo em constante transforma√ß√£o.'
            },
            'tecnologia': {
                intro: 'O desenvolvimento tecnol√≥gico contempor√¢neo caracteriza-se por uma acelera√ß√£o sem precedentes na cria√ß√£o e implementa√ß√£o de solu√ß√µes inovadoras que transformam fundamentalmente os processos sociais, econ√¥micos e culturais da humanidade. A converg√™ncia de diferentes tecnologias emergentes, incluindo computa√ß√£o qu√¢ntica, biotecnologia, nanotecnologia e sistemas de comunica√ß√£o avan√ßados, estabelece um novo paradigma de possibilidades que redefine os limites do conhecimento e da capacidade humana. Esta revolu√ß√£o tecnol√≥gica demanda uma compreens√£o aprofundada dos impactos, oportunidades e desafios associados √† integra√ß√£o dessas inova√ß√µes no tecido social contempor√¢neo.',
                desenvolvimento: 'A implementa√ß√£o de tecnologias disruptivas em diversos setores da economia tem demonstrado potencial significativo para otimiza√ß√£o de processos, redu√ß√£o de custos operacionais e cria√ß√£o de novos modelos de neg√≥cio. A digitaliza√ß√£o de servi√ßos tradicionais, a automa√ß√£o de processos industriais e o desenvolvimento de plataformas de comunica√ß√£o global exemplificam como as inova√ß√µes tecnol√≥gicas podem gerar valor econ√¥mico e social. Paralelamente, surgem quest√µes relacionadas √† seguran√ßa cibern√©tica, privacidade de dados e impactos no mercado de trabalho, exigindo o desenvolvimento de pol√≠ticas p√∫blicas e regulamenta√ß√µes adequadas para maximizar benef√≠cios e minimizar riscos.',
                conclusao: 'O futuro tecnol√≥gico da sociedade depende fundamentalmente da capacidade de equilibrar inova√ß√£o e responsabilidade social, garantindo que os avan√ßos cient√≠ficos e tecnol√≥gicos contribuam para o bem-estar coletivo e o desenvolvimento sustent√°vel. A constru√ß√£o de um ambiente tecnol√≥gico inclusivo e √©tico requer a participa√ß√£o ativa de diferentes stakeholders, incluindo pesquisadores, empres√°rios, gestores p√∫blicos e cidad√£os. Atrav√©s da colabora√ß√£o multidisciplinar e do estabelecimento de princ√≠pios √©ticos s√≥lidos, ser√° poss√≠vel direcionar o progresso tecnol√≥gico para a cria√ß√£o de um futuro mais pr√≥spero e equitativo para toda a humanidade.'
            }
        };

        // --- FUN√á√ïES AUXILIARES ---
        function log(message, type = 'info') {
            elements.statusDiv.className = type;
            elements.statusDiv.innerHTML = `
                <div>${getStatusIcon(type)} ${message}</div>
                <div style="font-size: 10px; margin-top: 5px; opacity: 0.7;">
                    ${new Date().toLocaleTimeString()}
                </div>
            `;
        }

        function getStatusIcon(type) {
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            return icons[type] || '‚ÑπÔ∏è';
        }

        // Switch entre modos de API
        elements.apiProvider.addEventListener('change', () => {
            const provider = elements.apiProvider.value;
            elements.geminiConfig.style.display = provider === 'gemini' ? 'block' : 'none';
            elements.offlineConfig.style.display = provider === 'offline' ? 'block' : 'none';
            elements.customConfig.style.display = provider === 'custom' ? 'block' : 'none';
            
            // Reset API test status when switching
            apiTested = provider !== 'gemini';
        });

        // --- FUN√á√ÉO PRINCIPAL DA API GEMINI (MANTENDO SUA L√ìGICA) ---
        async function callGeminiAPI(prompt, retry = true) {
            try {
                log('Gerando conte√∫do √∫nico...', 'info');
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                if (!response.ok) {
                    if (response.status === 429 && retry) {
                        log('Aguardando API...', 'warning');
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        return callGeminiAPI(prompt, false);
                    }
                    throw new Error(`Erro na API: ${response.status}`);
                }

                const data = await response.json();
                if (!data.candidates || !data.candidates[0]?.content?.parts[0]?.text) {
                    throw new Error('Resposta inv√°lida da API');
                }

                return data.candidates[0].content.parts[0].text.trim();
            } catch (error) {
                console.error('Erro na API:', error);
                log('‚ö†Ô∏è Erro ao gerar conte√∫do. Verifique a conex√£o ou tente novamente.', 'error');
                return null;
            }
        }

        // --- FUN√á√ÉO TESTE DA API ---
        async function testGeminiAPI() {
            try {
                log('üß™ Testando conex√£o com API...', 'info');
                const testPrompt = "Responda apenas: API funcionando";
                const result = await callGeminiAPI(testPrompt);
                
                if (result) {
                    log('‚úÖ API funcionando perfeitamente!', 'success');
                    apiTested = true;
                    return true;
                } else {
                    throw new Error('Resposta vazia');
                }
            } catch (error) {
                log(`‚ùå Erro na API: ${error.message}`, 'error');
                apiTested = false;
                return false;
            }
        }

        // --- FUN√á√ÉO PARA MODO OFFLINE ---
        function generateOfflineContent(tema, secao) {
            const temaLower = tema.toLowerCase();
            let template = null;

            // Busca o template mais pr√≥ximo
            for (const [key, value] of Object.entries(offlineTemplates)) {
                if (temaLower.includes(key) || key.includes(temaLower)) {
                    template = value;
                    break;
                }
            }

            // Fallback para IA gen√©rico se n√£o encontrar
            if (!template) {
                template = offlineTemplates['tecnologia'];
            }

            const secaoNames = ['intro', 'desenvolvimento', 'conclusao'];
            return template[secaoNames[secao]] || template.intro;
        }

        // --- SUAS FUN√á√ïES ORIGINAIS DE REFER√äNCIAS (MANTIDAS) ---
        function extractRelevantTerms(text, title = '') {
            const stopwords = [
                'a', 'o', 'as', 'os', 'de', 'da', 'do', 'das', 'dos', 'e', 'em', 'para', 'com', 'no', 'na', 'nos', 'nas', 
                'um', 'uma', 'uns', 'umas', 'que', 'se', 'por', 'mais', 'como', 'ou', 'ao', 'aos', '√†', '√†s', 'pelo', 
                'pela', 'pelos', 'pelas', 'este', 'esta', 'estes', 'estas', 'esse', 'essa', 'esses', 'essas', 'aquele', 
                'aquela', 'aqueles', 'aquelas', 'seu', 'sua', 'seus', 'suas', 'nosso', 'nossa', 'nossos', 'nossas',
                'ser', 'ter', 'estar', 'fazer', 'partir', 'acordo', 'meio', 'forma', 'caso', 'vez', 'exemplo',
                'atrav√©s', 'durante', 'sobre', 'quando', 'onde', 'porque', 'assim', 'tamb√©m', 'ainda', 'apenas',
                'pode', 'podem', 'deve', 'devem', 'tem', 't√™m', 's√£o', 'foram', 'sendo', 'sido', 'artigo', 'trabalho'
            ];
            
            const combinedText = `${title} ${text}`.toLowerCase();
            const cleanText = combinedText.replace(/[^\w\s√°√©√≠√≥√∫√¢√™√Æ√¥√ª√†√®√¨√≤√π√£√µ√ß]/g, ' ');
            
            const words = cleanText
                .split(/\s+/)
                .filter(word => 
                    word.length > 3 && 
                    !stopwords.includes(word) &&
                    !/^\d+$/.test(word)
                )
                .reduce((acc, word) => {
                    acc[word] = (acc[word] || 0) + 1;
                    return acc;
                }, {});
            
            return Object.entries(words)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 6)
                .map(([word]) => word);
        }

        function createSearchQueries(text, title) {
            const relevantTerms = extractRelevantTerms(text, title);
            const queries = [];
            
            if (relevantTerms.length >= 2) {
                queries.push(relevantTerms.slice(0, 3).join(' '));
            }
            
            if (title && relevantTerms.length > 0) {
                const titleTerms = extractRelevantTerms(title).slice(0, 2);
                queries.push([...titleTerms, ...relevantTerms.slice(0, 2)].join(' '));
            }
            
            if (title && queries.length === 0) {
                queries.push(title);
            }
            
            if (queries.length === 0) {
                queries.push('artificial intelligence research');
            }
            
            return queries;
        }

        async function fetchParagraphReferences(paragraphText, articleTitle) {
            log('Buscando refer√™ncias acad√™micas...', 'info');
            
            try {
                const queries = createSearchQueries(paragraphText, articleTitle);
                let allReferences = [];
                
                elements.searchInfoDiv.innerHTML = `
                    <strong>üîç An√°lise:</strong><br>
                    Termos-chave: <em>${extractRelevantTerms(paragraphText, articleTitle).join(', ')}</em><br>
                    Consultas: <em>${queries.join(' | ')}</em>
                `;
                elements.searchInfoDiv.style.display = 'block';
                
                for (const query of queries) {
                    if (allReferences.length >= 10) break;
                    
                    let attempts = 0;
                    const maxAttempts = 3;
                    while (attempts < maxAttempts) {
                        try {
                            const url = `https://api.semanticscholar.org/graph/v1/paper/search?query=${encodeURIComponent(query)}&limit=15&fields=title,authors,year,abstract,url,citationCount`;
                            const response = await fetch(url, { signal: AbortSignal.timeout(10000) });
                            
                            if (!response.ok) {
                                attempts++;
                                if (attempts === maxAttempts) continue;
                                await new Promise(resolve => setTimeout(resolve, 1000));
                                continue;
                            }
                            
                            const data = await response.json();
                            const papers = data.data || [];
                            
                            const scoredPapers = papers
                                .filter(paper => 
                                    paper.title && 
                                    paper.authors && 
                                    paper.authors.length > 0 &&
                                    paper.year >= 2010
                                )
                                .map(paper => {
                                    let score = 0;
                                    const titleLower = paper.title.toLowerCase();
                                    const abstractLower = (paper.abstract || '').toLowerCase();
                                    const queryTerms = query.toLowerCase().split(' ');
                                    
                                    queryTerms.forEach(term => {
                                        if (titleLower.includes(term)) score += 3;
                                        if (abstractLower.includes(term)) score += 1;
                                    });
                                    
                                    if (paper.citationCount) {
                                        score += Math.min(paper.citationCount / 100, 2);
                                    }
                                    
                                    if (paper.year >= 2020) score += 1;
                                    
                                    return { ...paper, relevanceScore: score };
                                })
                                .filter(paper => paper.relevanceScore > 0)
                                .sort((a, b) => b.relevanceScore - a.relevanceScore);
                            
                            allReferences.push(...scoredPapers.slice(0, 8));
                            break;
                        } catch (error) {
                            console.warn(`Erro na busca (tentativa ${attempts + 1}):`, error);
                            attempts++;
                            if (attempts === maxAttempts) {
                                console.error(`Falha ap√≥s ${maxAttempts} tentativas para a query: ${query}`);
                            }
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                }
                
                const uniqueReferences = allReferences
                    .filter((paper, index, self) => 
                        index === self.findIndex(p => p.paperId === paper.paperId)
                    )
                    .slice(0, 10);
                
                elements.searchInfoDiv.innerHTML = `
                    <strong>‚úÖ Resultado:</strong><br>
                    ${uniqueReferences.length} refer√™ncias encontradas
                `;
                
                log(`${uniqueReferences.length} refer√™ncias encontradas!`, 'success');
                
                return uniqueReferences.map(paper => ({
                    id: paper.paperId,
                    title: paper.title,
                    authors: paper.authors.map(author => author.name),
                    year: paper.year || 's.d.',
                    abstract: paper.abstract || '',
                    url: paper.url || `https://www.semanticscholar.org/paper/${paper.paperId}`,
                    citationCount: paper.citationCount || 0
                }));
                
            } catch (error) {
                console.error('Erro ao buscar refer√™ncias:', error);
                log('‚ö†Ô∏è Erro na busca de refer√™ncias. Tente novamente ou continue sem refer√™ncias.', 'error');
                elements.searchInfoDiv.innerHTML = `
                    <strong>‚ùå Erro:</strong><br>
                    Falha ao buscar refer√™ncias. Verifique a conex√£o com a internet ou tente novamente.
                `;
                return [];
            }
        }

        async function openReferenceModal(paragraphId, paragraphText, articleTitle) {
            currentParagraphId = paragraphId;
            elements.duplicateWarningDiv.style.display = 'none';
            
            if (!paragraphText.trim() && !articleTitle) {
                elements.referenceList.innerHTML = '<div class="no-results">‚ö†Ô∏è Conte√∫do insuficiente.</div>';
                elements.addReferencesBtn.disabled = true;
                elements.referenceModal.style.display = 'flex';
                return;
            }
            
            elements.referenceList.innerHTML = '<p>üîç Buscando refer√™ncias...</p>';
            elements.addReferencesBtn.disabled = true;
            elements.referenceModal.style.display = 'flex';
            
            const references = await fetchParagraphReferences(paragraphText, articleTitle);
            
            if (references.length === 0) {
                elements.referenceList.innerHTML = `
                    <div class="no-results">
                        <strong>‚ùå Nenhuma refer√™ncia encontrada</strong><br>
                        Verifique a conex√£o com a internet ou tente novamente.
                    </div>
                `;
                elements.addReferencesBtn.disabled = true;
            } else {
                const existingRefs = references.filter(ref => {
                    return finalReferences.some(existingRef => existingRef.id === ref.id);
                });
                
                if (existingRefs.length > 0) {
                    elements.duplicateWarningDiv.innerHTML = `
                        ‚ö†Ô∏è ${existingRefs.length} refer√™ncia(s) j√° foram usadas (podem ser reutilizadas).
                    `;
                    elements.duplicateWarningDiv.style.display = 'block';
                }
                
                elements.referenceList.innerHTML = references.map((ref, index) => {
                    const isAlreadyUsed = finalReferences.some(existingRef => existingRef.id === ref.id);
                    
                    return `
                        <li style="${isAlreadyUsed ? 'background-color: #f8f9fa;' : ''}">
                            <input type="checkbox" id="ref-${index}" value="${index}">
                            <label for="ref-${index}">
                                <strong>${ref.authors[0]}${ref.authors.length > 1 ? ' et al.' : ''} (${ref.year})</strong>
                                ${isAlreadyUsed ? '<span style="color: #6c757d;"> [J√Å USADA]</span>' : ''}<br>
                                <em>${ref.title}</em><br>
                                <small style="color: #666;">
                                    ${ref.abstract ? ref.abstract.substring(0, 120) + '...' : 'Sem resumo'}
                                    ${ref.citationCount ? ` | ${ref.citationCount} cita√ß√µes` : ''}
                                </small>
                            </label>
                        </li>
                    `;
                }).join('');
                elements.addReferencesBtn.disabled = false;
            }
        }

        async function addSelectedReferences() {
            const selectedIndices = Array.from(document.querySelectorAll('#reference-list input:checked'))
                .map(input => parseInt(input.value));
            
            if (selectedIndices.length === 0) {
                alert('Selecione pelo menos uma refer√™ncia.');
                return;
            }

            const paragraphElement = document.querySelector(`p[data-id="${currentParagraphId}"]`);
            const originalText = paragraphElement.textContent.trim();
            const references = await fetchParagraphReferences(originalText, userInputs.titulo);
            
            let cleanText = originalText.replace(/\s*\([A-Z√Ä-√ô\s;,\d\-]+\)\s*\.?$/g, '').trim();
            
            const selectedRefs = selectedIndices.map(index => references[index]);
            
            const citations = selectedRefs.map(ref => {
                const authors = ref.authors;
                if (authors.length === 1) {
                    const lastName = authors[0].split(' ').pop().toUpperCase();
                    return `${lastName}, ${ref.year}`;
                } else if (authors.length === 2) {
                    const lastName1 = authors[0].split(' ').pop().toUpperCase();
                    const lastName2 = authors[1].split(' ').pop().toUpperCase();
                    return `${lastName1}; ${lastName2}, ${ref.year}`;
                } else {
                    const lastName1 = authors[0].split(' ').pop().toUpperCase();
                    return `${lastName1} et al., ${ref.year}`;
                }
            });
            
            const finalText = `${cleanText} (${citations.join('; ')}).`;
            
            paragraphElement.textContent = finalText;
            
            const [sectionKey, indexStr] = currentParagraphId.split('-');
            const paragraphIndex = parseInt(indexStr);
            if (articleContent[sectionKey] && articleContent[sectionKey][paragraphIndex] !== undefined) {
                articleContent[sectionKey][paragraphIndex] = finalText;
            }
            
            selectedRefs.forEach(ref => {
                if (!finalReferences.some(existingRef => existingRef.id === ref.id)) {
                    finalReferences.push(ref);
                }
            });
            
            displayABNTDocument();
            elements.referenceModal.style.display = 'none';
            
            log(`‚úÖ ${selectedIndices.length} refer√™ncia(s) adicionada(s) ao par√°grafo!`, 'success');
        }

        function formatarReferenciasABNT() {
            const sortedReferences = [...finalReferences].sort((a, b) => {
                const lastNameA = a.authors[0].split(' ').pop().toUpperCase();
                const lastNameB = b.authors[0].split(' ').pop().toUpperCase();
                return lastNameA.localeCompare(lastNameB);
            });
            
            return sortedReferences
                .map(ref => {
                    const authors = ref.authors.map(author => {
                        const names = author.split(' ');
                        const lastName = names.pop().toUpperCase();
                        const firstNames = names.join(' ');
                        return `${lastName}, ${firstNames}`;
                    });
                    
                    const authorsStr = authors.length > 3 
                        ? `${authors[0]} et al.`
                        : authors.join('; ');
                    
                    return `${authorsStr}. <em>${ref.title}</em>. ${ref.year}. Dispon√≠vel em: ${ref.url}. Acesso em: jun. 2025.`;
                })
                .join('<br><br>');
        }

        async function generateResumoAndAbstract() {
            log('Gerando resumo autom√°tico...', 'info');
            
            const allContent = Object.values(articleContent).flat().join(' ');
            const titulo = userInputs.titulo;
            
            if (!allContent || allContent.length < 100) {
                log('‚ö†Ô∏è Conte√∫do insuficiente para gerar resumo.', 'warning');
                return;
            }
            
            try {
                const resumoPrompt = `
                Baseado no t√≠tulo "${titulo}" e conte√∫do "${allContent}", 
                escreva um resumo acad√™mico de 150-200 palavras seguindo ABNT:
                - Foco tem√°tico, objetivo, m√©todo, resultados e conclus√µes
                - N√ÉO use primeira pessoa
                - Linguagem formal
                - N√ÉO inclua cita√ß√µes
                `;
                
                const resumo = await callGeminiAPI(resumoPrompt);
                if (resumo) {
                    // CORRE√á√ÉO: Remove o t√≠tulo "Resumo" ou "**Resumo**:" do in√≠cio do texto gerado pela IA.
                    userInputs.resumo = resumo.replace(/^(?:\*\*)?Resumo(?:\*\*)?:?\s*/i, '').trim();
                    
                    const palavrasPrompt = `Com base no t√≠tulo "${titulo}" e resumo "${userInputs.resumo}", extraia 6 palavras-chave em portugu√™s. Formato: Palavra1, Palavra2, Palavra3, Palavra4, Palavra5, Palavra6`;
                    const palavrasChave = await callGeminiAPI(palavrasPrompt);
                    
                    if (palavrasChave) {
                        userInputs.palavrasChave = palavrasChave.replace(/\.$/, '');
                        
                        const abstractPrompt = `Traduza para ingl√™s acad√™mico: "${userInputs.resumo}"`;
                        const abstract = await callGeminiAPI(abstractPrompt);
                        
                        if (abstract) {
                            // CORRE√á√ÉO: Remove o t√≠tulo "Abstract" ou "**Abstract**:" do in√≠cio do texto gerado pela IA.
                            userInputs.abstract = abstract.replace(/^(?:\*\*)?Abstract(?:\*\*)?:?\s*/i, '').trim();
                            
                            const keywordsPrompt = `
                            Traduza a express√£o "${palavrasChave}" para o ingl√™s, mantendo exatamente as mesmas 6 palavras-chave, mas em ingl√™s acad√™mico.
                            Sua resposta deve conter APENAS as 6 palavras-chave traduzidas, separadas por v√≠rgula, sem v√≠rgula no final da √∫ltima palavra.
                            N√ÉO inclua explica√ß√µes, n√∫meros ou qualquer texto adicional.

                            Exemplo de formato desejado: Keyword1, Keyword2, Keyword3, Keyword4, Keyword5, Keyword6

                            Palavras-chave para traduzir: "${palavrasChave}"
                            `;
                            
                            const keywords = await callGeminiAPI(keywordsPrompt);
                            
                            if (keywords) {
                                userInputs.keywords = keywords;
                                displayABNTDocument();
                                log('‚úÖ Resumo e abstract gerados!', 'success');
                                return;
                            }
                        }
                    }
                }
                
                log('‚ö†Ô∏è Erro ao gerar resumo. Continue editando o artigo.', 'warning');
                
            } catch (error) {
                console.error('Erro:', error);
                log('‚ö†Ô∏è Erro ao gerar resumo. Verifique a conex√£o ou tente novamente.', 'error');
            }
        }

        function displayABNTDocument() {
            let content = `
                <div class="nome-universidade no-indent">${userInputs.universidade || ''}</div>
                <div class="titulo-trabalho no-indent">${userInputs.titulo || ''}</div>
                <div class="autor no-indent">${userInputs.autor || ''}<sup>1</sup></div>
            `;
            
            if (userInputs.resumo) {
                content += `
                    <div class="resumo-titulo no-indent">Resumo</div>
                    <div class="resumo-texto no-indent">${userInputs.resumo}</div>
                `;
                if (userInputs.palavrasChave) {
                    content += `<div class="palavras-chave no-indent"><strong>Palavras-chave:</strong> ${userInputs.palavrasChave}.</div>`;
                }
                
                if (userInputs.abstract) {
                    content += `
                        <div class="abstract-titulo no-indent">Abstract</div>
                        <div class="resumo-texto no-indent">${userInputs.abstract}</div>
                    `;
                    if (userInputs.keywords) {
                        content += `<div class="keywords no-indent"><strong>Keywords:</strong> ${userInputs.keywords}.</div>`;
                    }
                }
            }
            
            const sections = [
                { name: 'INTRODU√á√ÉO', key: 'introducao' },
                { name: 'DESENVOLVIMENTO', key: 'desenvolvimento' },
                { name: 'CONCLUS√ÉO', key: 'conclusao' }
            ];
            
            sections.forEach(section => {
                if (articleContent[section.key].length > 0) {
                    content += `<div class="section-title no-indent">${section.name}</div>`;
                    articleContent[section.key].forEach((text, index) => {
                        const paragraphId = `${section.key}-${index}`;
                        content += `<p data-id="${paragraphId}" title="üí° Clique para adicionar refer√™ncias">${text}</p>`;
                    });
                }
            });
            
            if (finalReferences.length > 0) {
                content += '<div class="section-title no-indent">REFER√äNCIAS</div>';
                content += `<div class="no-indent" style="text-align: left;">${formatarReferenciasABNT()}</div>`;
            }
            
            if (userInputs.email) {
                content += `<div class="email-autor"><sup>1</sup> ${userInputs.universidade || ''}, ${userInputs.email}</div>`;
            }
            
            elements.outputDiv.innerHTML = content;
            
            // Definir o rodap√©
            elements.footerDiv.innerHTML = `${userInputs.universidade || 'Institui√ß√£o de Ensino'}, ${userInputs.email || 'email@exemplo.com'}, jun.2025`;
        }

        // --- EVENTOS PRINCIPAIS ---
        
        // Teste da API
        elements.testApiBtn.addEventListener('click', testGeminiAPI);

        // Iniciar artigo
        elements.startBtn.addEventListener('click', async () => {
            userInputs = {
                universidade: document.getElementById('universidade').value,
                titulo: document.getElementById('titulo').value,
                autor: document.getElementById('autor').value,
                email: document.getElementById('email').value
            };
            
            if (!userInputs.titulo || !userInputs.autor) {
                log('‚ùå Preencha t√≠tulo e autor.', 'error');
                return;
            }

            const provider = elements.apiProvider.value;
            
            // Valida√ß√µes espec√≠ficas por modo
            if (provider === 'gemini' && !apiTested) {
                log('‚ö†Ô∏è Teste a API primeiro', 'warning');
                return;
            }
            
            if (provider === 'custom') {
                const customText = document.getElementById('customText').value.trim();
                if (!customText) {
                    log('‚ö†Ô∏è Digite seu texto personalizado', 'warning');
                    return;
                }
            }

            elements.startBtn.disabled = true;
            log('üîÑ Iniciando artigo...', 'info');

            try {
                let content = '';

                if (provider === 'gemini') {
                    // Corrigir t√≠tulo e gerar sugest√µes
                    const titlePrompt = `
                    Com base no t√≠tulo "${userInputs.titulo}", fa√ßa o seguinte:
                    1. Corrija gramaticalmente o t√≠tulo original, mantendo exatamente o mesmo significado e tema, ajustando apenas erros gramaticais, ortogr√°ficos ou de estilo para uma linguagem acad√™mica clara e formal, sem criar um novo t√≠tulo.
                    2. Gere 9 sugest√µes de t√≠tulos acad√™micos baseados no mesmo significado e tema do t√≠tulo original, com linguagem formal, variando perspectivas ou enfoques, mas mantendo a ess√™ncia do tema.
                    Formato da resposta:
                    T√≠tulo Corrigido: [T√≠tulo corrigido gramaticalmente]
                    Sugest√µes de T√≠tulos:
                    1. [T√≠tulo 1]
                    2. [T√≠tulo 2]
                    3. [T√≠tulo 3]
                    4. [T√≠tulo 4]
                    5. [T√≠tulo 5]
                    6. [T√≠tulo 6]
                    7. [T√≠tulo 7]
                    8. [T√≠tulo 8]
                    9. [T√≠tulo 9]
                    `;
                    
                    log('Corrigindo t√≠tulo e gerando sugest√µes...', 'info');
                    const titleResponse = await callGeminiAPI(titlePrompt);
                    let correctedTitle = userInputs.titulo;
                    let suggestions = [];
                    
                    if (titleResponse) {
                        const lines = titleResponse.split('\n');
                        lines.forEach(line => {
                            if (line.startsWith('T√≠tulo Corrigido:')) {
                                correctedTitle = line.replace('T√≠tulo Corrigido:', '').trim();
                            } else if (line.match(/^\d+\.\s/)) {
                                suggestions.push(line.replace(/^\d+\.\s/, '').trim());
                            }
                        });
                    }

                    userInputs.titulo = correctedTitle;

                    log(`T√≠tulo Corrigido: ${correctedTitle}`, 'success');
                    
                    // Gerar introdu√ß√£o
                    const prompt = `
                    Escreva um par√°grafo acad√™mico de introdu√ß√£o para o artigo com o t√≠tulo "${userInputs.titulo}".
                    - Deve ter entre 80 e 120 palavras.
                    - Use linguagem formal e acad√™mica.
                    - N√£o inclua cita√ß√µes.
                    - O par√°grafo deve contextualizar o tema e justificar a import√¢ncia da pesquisa.
                    `;
                    
                    content = await callGeminiAPI(prompt);
                    
                } else if (provider === 'offline') {
                    const tema = document.getElementById('tema').value.trim() || userInputs.titulo;
                    content = generateOfflineContent(tema, 0);
                    
                } else if (provider === 'custom') {
                    content = document.getElementById('customText').value.trim();
                }

                if (!content) {
                    throw new Error('Conte√∫do vazio gerado');
                }

                articleContent.introducao.push(content);
                displayABNTDocument();
                
                document.getElementById('initial-form').style.display = 'none';
                document.getElementById('interactive-controls').style.display = 'block';
                elements.currentSectionNameSpan.textContent = 'Introdu√ß√£o';
                
                log('‚úÖ Artigo iniciado com sucesso!', 'success');

            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
                
                // Fallback autom√°tico para offline se Gemini falhar
                if (provider === 'gemini') {
                    log('üîÑ Tentando modo offline...', 'warning');
                    setTimeout(() => {
                        elements.apiProvider.value = 'offline';
                        elements.apiProvider.dispatchEvent(new Event('change'));
                        document.getElementById('tema').value = userInputs.titulo;
                    }, 2000);
                }
                
            } finally {
                elements.startBtn.disabled = false;
            }
        });

        // Continuar se√ß√£o
        elements.continueBtn.addEventListener('click', async () => {
            const provider = elements.apiProvider.value;
            
            elements.continueBtn.disabled = true;
            log('üîÑ Adicionando par√°grafo...', 'info');

            try {
                let content = '';

                if (provider === 'gemini') {
                    const sectionNames = { 'introducao': 'introdu√ß√£o', 'desenvolvimento': 'desenvolvimento', 'conclusao': 'conclus√£o' };
                    const sectionName = sectionNames[currentSection];
                    const fullArticleText = Object.values(articleContent).flat().join(' ');
                    
                    const prompt = `
                    Artigo: "${userInputs.titulo}"
                    Conte√∫do j√° escrito: "${fullArticleText}"

                    Sua tarefa √© escrever o PR√ìXIMO par√°grafo para a se√ß√£o de "${sectionName}".
                    
                    **Instru√ß√£o Cr√≠tica: O novo par√°grafo deve ser 100% √öNICO.**
                    - **N√ÉO REPITA** frases, ideias ou argumentos j√° presentes no "Conte√∫do j√° escrito".
                    - Introduza um novo ponto de vista, um novo dado, um exemplo espec√≠fico ou aprofunde um conceito de forma original.
                    - Mantenha a linguagem formal e acad√™mica.
                    - Tamanho: 80-120 palavras.
                    - N√£o use cita√ß√µes nem palavras de finaliza√ß√£o de se√ß√£o.
                    `;
                    
                    content = await callGeminiAPI(prompt);
                    
                } else if (provider === 'offline') {
                    const tema = document.getElementById('tema').value.trim() || userInputs.titulo;
                    const currentIndex = sectionOrder.indexOf(currentSection);
                    content = generateOfflineContent(tema, currentIndex);
                    
                } else if (provider === 'custom') {
                    content = prompt(`Digite o pr√≥ximo par√°grafo para a se√ß√£o ${currentSection}:`);
                }

                if (content) {
                    articleContent[currentSection].push(content);
                    displayABNTDocument();
                    log('‚úÖ Par√°grafo √∫nico adicionado!', 'success');
                }

            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
            } finally {
                elements.continueBtn.disabled = false;
            }
        });

        // Finalizar se√ß√£o
        elements.concludeBtn.addEventListener('click', async () => {
            const provider = elements.apiProvider.value;
            
            elements.concludeBtn.disabled = true;
            log('üîÑ Finalizando se√ß√£o...', 'info');

            try {
                let content = '';

                if (provider === 'gemini') {
                    const sectionNames = { 'introducao': 'introdu√ß√£o', 'desenvolvimento': 'desenvolvimento', 'conclusao': 'conclus√£o' };
                    const sectionName = sectionNames[currentSection];
                    const fullArticleText = Object.values(articleContent).flat().join(' ');

                    const prompt = `
                    Artigo: "${userInputs.titulo}"
                    Conte√∫do j√° escrito: "${fullArticleText}"

                    Sua tarefa √© escrever um par√°grafo de **FINALIZA√á√ÉO** para a se√ß√£o de "${sectionName}".

                    **Instru√ß√£o Cr√≠tica: O par√°grafo deve ser √öNICO e conclusivo.**
                    - **N√ÉO REPITA** o que j√° foi dito. Em vez disso, sintetize as ideias principais da se√ß√£o de uma nova maneira.
                    - Use conectivos de conclus√£o (ex: "Portanto", "Dessa forma", "Em suma").
                    - O par√°grafo deve amarrar os pontos discutidos na se√ß√£o sem introduzir informa√ß√£o totalmente nova.
                    - Tamanho: 80-120 palavras.
                    - N√£o use cita√ß√µes.
                    `;
                    
                    content = await callGeminiAPI(prompt);
                    
                } else if (provider === 'offline') {
                    const tema = document.getElementById('tema').value.trim() || userInputs.titulo;
                    const currentIndex = sectionOrder.indexOf(currentSection);
                    content = generateOfflineContent(tema, currentIndex);
                    
                } else if (provider === 'custom') {
                    content = prompt(`Digite o par√°grafo de finaliza√ß√£o para a se√ß√£o ${currentSection}:`);
                }

                if (content) {
                    articleContent[currentSection].push(content);
                    displayABNTDocument();
                    log('‚úÖ Par√°grafo de finaliza√ß√£o adicionado!', 'success');
                }

            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
            } finally {
                elements.concludeBtn.disabled = false;
            }
        });

        // Pr√≥xima se√ß√£o
        elements.finalizeBtn.addEventListener('click', async () => {
            const currentIndex = sectionOrder.indexOf(currentSection);
            
            if (currentIndex < sectionOrder.length - 1) {
                currentSection = sectionOrder[currentIndex + 1];
                const sectionDisplayNames = { 'desenvolvimento': 'Desenvolvimento', 'conclusao': 'Conclus√£o' };
                const sectionDisplayName = sectionDisplayNames[currentSection];
                elements.currentSectionNameSpan.textContent = sectionDisplayName;
                
                // Auto-gerar primeiro par√°grafo da nova se√ß√£o
                const provider = elements.apiProvider.value;
                
                try {
                    let content = '';

                    if (provider === 'gemini') {
                        const fullArticleText = Object.values(articleContent).flat().join(' ');

                        const prompt = `
                        Artigo: "${userInputs.titulo}"
                        Conte√∫do j√° escrito nas se√ß√µes anteriores: "${fullArticleText}"

                        Sua tarefa √© escrever o par√°grafo **INICIAL** da nova se√ß√£o: "${sectionDisplayName}".

                        **Instru√ß√£o Cr√≠tica: Este par√°grafo deve ser uma transi√ß√£o e introdu√ß√£o √öNICA.**
                        - Conecte-se brevemente com a se√ß√£o anterior, mas **N√ÉO REPITA** o que foi dito.
                        - Apresente claramente o que ser√° abordado NESTA nova se√ß√£o.
                        - Evite frases gen√©ricas. Seja espec√≠fico sobre os t√≥picos do ${sectionDisplayName}.
                        - Tamanho: 80-120 palavras.
                        - N√£o use cita√ß√µes.
                        `;
                        
                        content = await callGeminiAPI(prompt);
                        
                    } else if (provider === 'offline') {
                        const tema = document.getElementById('tema').value.trim() || userInputs.titulo;
                        content = generateOfflineContent(tema, currentIndex + 1);
                        
                    } else if (provider === 'custom') {
                        content = prompt(`Digite o par√°grafo inicial para a se√ß√£o ${sectionDisplayName}:`);
                    }
                    
                    if (content) {
                        articleContent[currentSection].push(content);
                        displayABNTDocument();
                        log(`‚úÖ ${sectionDisplayName} iniciada!`, 'success');
                    }
                    
                } catch (error) {
                    log(`‚ö†Ô∏è Erro ao gerar ${sectionDisplayName}. Continue manualmente.`, 'warning');
                }
                
            } else {
                elements.finalizeBtn.style.display = 'none';
                elements.continueBtn.disabled = true;
                elements.concludeBtn.disabled = true;
                
                // Gerar resumo apenas se usar Gemini
                if (elements.apiProvider.value === 'gemini') {
                    await generateResumoAndAbstract();
                }
                
                elements.finishBtn.style.display = 'block';
            }
        });

        // Finalizar artigo
        elements.finishBtn.addEventListener('click', () => {
            const totalRefs = finalReferences.length;
            const totalParagraphs = Object.values(articleContent).flat().length;
            
            alert(`üéâ Artigo ABNT finalizado!\n\nüìä Estat√≠sticas:\n‚Ä¢ ${totalParagraphs} par√°grafos √∫nicos\n‚Ä¢ ${totalRefs} refer√™ncias AUTOR-DATA\n‚Ä¢ Formata√ß√£o ABNT rigorosa\n\nüíæ Agora voc√™ pode usar os bot√µes "Salvar como PDF" ou "Salvar como DOCX".`);
            log(`üéì Artigo conclu√≠do: ${totalParagraphs} par√°grafos, ${totalRefs} refer√™ncias!`, 'success');
        });

        // Eventos de clique nos par√°grafos para adicionar refer√™ncias
        elements.outputDiv.addEventListener('click', (e) => {
            e.stopPropagation();
            const paragraph = e.target.closest('p[data-id]');
            if (paragraph) {
                const paragraphId = paragraph.dataset.id;
                const paragraphText = paragraph.textContent.replace(/\s*\([A-Z√Ä-√ô\s;,\d\-]+\)\s*\.?$/g, '').trim();
                openReferenceModal(paragraphId, paragraphText, userInputs.titulo);
            }
        });

        // Eventos do modal de refer√™ncias
        elements.addReferencesBtn.addEventListener('click', addSelectedReferences);
        elements.closeModalBtn.addEventListener('click', () => { 
            elements.referenceModal.style.display = 'none'; 
        });
        elements.referenceModal.addEventListener('click', (e) => { 
            if (e.target === elements.referenceModal) { 
                elements.referenceModal.style.display = 'none'; 
            } 
        });

        // --- EVENTOS PARA SALVAR ---
        elements.savePdfBtn.addEventListener('click', () => {
            alert('A caixa de di√°logo de impress√£o ser√° aberta.\n\nPara salvar como PDF com a formata√ß√£o correta:\n1. Em "Destino", escolha "Salvar como PDF".\n2. Em "Mais configura√ß√µes", DESMARQUE a op√ß√£o "Cabe√ßalhos e rodap√©s".\nO rodap√© personalizado ser√° inclu√≠do automaticamente.\nAs margens ABNT j√° est√£o configuradas.');
            window.print();
        });

        elements.saveDocBtn.addEventListener('click', () => {
            window.open('https://www.ilovepdf.com/pt/pdf_para_word', '_blank');
        });

        function generateWordHTML() {
            return `<!DOCTYPE html>
<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
<head>
    <meta charset="utf-8">
    <title>${userInputs.titulo}</title>
    <!--[if gte mso 9]>
    <xml>
        <w:WordDocument>
            <w:View>Print</w:View>
            <w:Zoom>90</w:Zoom>
            <w:DoNotPromptForConvert/>
            <w:DoNotShowInsertionsAndDeletions/>
        </w:WordDocument>
    </xml>
    <![endif]-->
    <style>
        @page {
            margin: 3cm 2cm 2cm 3cm;
            size: A4;
        }
        body {
            font-family: 'Times New Roman', serif;
            font-size: 12pt;
            line-height: 1.5;
            margin: 0;
            padding: 0;
        }
        .center { text-align: center; }
        .bold { font-weight: bold; }
        .italic { font-style: italic; }
        .justify { text-align: justify; }
        .uppercase { text-transform: uppercase; }
        .paragraph {
            text-align: justify;
            text-indent: 1.25cm;
            margin-bottom: 12pt;
            line-height: 1.5;
        }
        .no-indent {
            text-indent: 0 !important;
        }
        .section-title {
            font-weight: bold;
            text-transform: uppercase;
            margin-top: 24pt;
            margin-bottom: 12pt;
            text-indent: 0;
        }
        .reference {
            text-align: justify;
            margin-bottom: 12pt;
            padding-left: 1cm;
            text-indent: -1cm;
            line-height: 1.5;
        }
        .footer {
            border-top: 1pt solid black;
            padding-top: 10pt;
            margin-top: 40pt;
            font-size: 10pt;
        }
    </style>
</head>
<body>
    <div class="center bold">${userInputs.universidade}</div>
    <br>
    <div class="center bold" style="font-size: 14pt;">${userInputs.titulo}</div>
    <br>
    <div class="center">${userInputs.autor}<sup>1</sup></div>
    <br><br>

    ${userInputs.resumo ? `
    <div class="bold">Resumo</div>
    <div class="justify no-indent">${userInputs.resumo}</div>
    <div class="no-indent"><strong>Palavras-chave:</strong> ${userInputs.palavrasChave}.</div>
    <br>

    <div class="bold italic">Abstract</div>
    <div class="justify no-indent">${userInputs.abstract}</div>
    <div class="no-indent italic"><strong>Keywords:</strong> ${userInputs.keywords}.</div>
    <br><br>
    ` : ''}

    ${generateSectionsHTML()}

    ${finalReferences.length > 0 ? `
    <div class="section-title">REFER√äNCIAS</div>
    ${generateReferencesHTML()}
    ` : ''}

    <div class="footer">
        <sup>1</sup> ${userInputs.universidade}, ${userInputs.email}
    </div>
</body>
</html>`;
        }

        function generateSectionsHTML() {
            const sections = [
                { name: 'INTRODU√á√ÉO', key: 'introducao' },
                { name: 'DESENVOLVIMENTO', key: 'desenvolvimento' },
                { name: 'CONCLUS√ÉO', key: 'conclusao' }
            ];

            let html = '';
            sections.forEach(section => {
                if (articleContent[section.key].length > 0) {
                    html += `<div class="section-title">${section.name}</div>`;
                    articleContent[section.key].forEach(text => {
                        html += `<div class="paragraph">${text}</div>`;
                    });
                }
            });
            return html;
        }

        function generateReferencesHTML() {
            const sortedRefs = [...finalReferences].sort((a, b) => {
                const lastNameA = a.authors[0].split(' ').pop().toUpperCase();
                const lastNameB = b.authors[0].split(' ').pop().toUpperCase();
                return lastNameA.localeCompare(lastNameB);
            });

            return sortedRefs.map(ref => {
                const authors = ref.authors.map(author => {
                    const names = author.split(' ');
                    const lastName = names.pop().toUpperCase();
                    const firstNames = names.join(' ');
                    return `${lastName}, ${firstNames}`;
                });

                const authorsStr = authors.length > 3 ? `${authors[0]} et al.` : authors.join('; ');
                return `<div class="reference">${authorsStr}. <em>${ref.title}</em>. ${ref.year}. Dispon√≠vel em: ${ref.url}. Acesso em: jun. 2025.</div>`;
            }).join('');
        }

        function generateRTFContent() {
            const rtfHeader = `{\\rtf1\\ansi\\deff0 {\\fonttbl {\\f0 Times New Roman;}}`;
            const rtfFooter = `}`;
            
            let content = `\\f0\\fs24`; // Times New Roman, 12pt
            
            // Universidade
            content += `\\qc\\b ${userInputs.universidade}\\b0\\par\\par`;
            
            // T√≠tulo  
            content += `\\qc\\b\\fs28 ${userInputs.titulo}\\b0\\fs24\\par\\par`;
            
            // Autor
            content += `\\qc ${userInputs.autor}\\super 1\\nosupersub\\par\\par\\par`;
            
            // Resumo
            if (userInputs.resumo) {
                content += `\\ql\\b Resumo\\b0\\par`;
                content += `\\qj ${userInputs.resumo}\\par`;
                content += `\\ql\\b Palavras-chave:\\b0 ${userInputs.palavrasChave}.\\par\\par`;
                
                content += `\\ql\\b\\i Abstract\\b0\\i0\\par`;
                content += `\\qj ${userInputs.abstract}\\par`;
                content += `\\ql\\b\\i Keywords:\\b0\\i0 ${userInputs.keywords}.\\par\\par\\par`;
            }
            
            // Se√ß√µes
            const sections = [
                { name: 'INTRODU√á√ÉO', key: 'introducao' },
                { name: 'DESENVOLVIMENTO', key: 'desenvolvimento' },
                { name: 'CONCLUS√ÉO', key: 'conclusao' }
            ];
            
            sections.forEach(section => {
                if (articleContent[section.key].length > 0) {
                    content += `\\ql\\b ${section.name}\\b0\\par\\par`;
                    articleContent[section.key].forEach(text => {
                        content += `\\qj\\fi708 ${text.replace(/&/g, '\\&')}\\par\\par`;
                    });
                }
            });
            
            // Refer√™ncias
            if (finalReferences.length > 0) {
                content += `\\ql\\b REFER√äNCIAS\\b0\\par\\par`;
                const sortedRefs = [...finalReferences].sort((a, b) => {
                    const lastNameA = a.authors[0].split(' ').pop().toUpperCase();
                    const lastNameB = b.authors[0].split(' ').pop().toUpperCase();
                    return lastNameA.localeCompare(lastNameB);
                });
                
                sortedRefs.forEach(ref => {
                    const authors = ref.authors.map(author => {
                        const names = author.split(' ');
                        const lastName = names.pop().toUpperCase();
                        const firstNames = names.join(' ');
                        return `${lastName}, ${firstNames}`;
                    });
                    const authorsStr = authors.length > 3 ? `${authors[0]} et al.` : authors.join('; ');
                    content += `\\qj\\li567\\fi-567 ${authorsStr}. \\i ${ref.title}\\i0. ${ref.year}. Dispon√≠vel em: ${ref.url}. Acesso em: jun. 2025.\\par\\par`;
                });
            }
            
            // Rodap√©
            content += `\\par\\par\\brdrt\\brdrs\\brdrw10\\par`;
            content += `\\fs20\\super 1\\nosupersub ${userInputs.universidade}, ${userInputs.email}\\fs24`;
            
            return rtfHeader + content + rtfFooter;
        }

        // --- INICIALIZA√á√ÉO ---
        log('üéØ Preencha os dados e escolha o modo de gera√ß√£o', 'info');

        // Configurar estado inicial dos elementos
        elements.startBtn.disabled = false;
    </script>
</body>
</html>