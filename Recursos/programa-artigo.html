<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gerador de Artigo Científico com IA do Puter</title>
    <script src="https://js.puter.com/v2/"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Arial&display=swap');
        body { background-color: #e0e0e0; font-family: Arial, sans-serif; padding: 20px; }
        .main-container { display: flex; justify-content: center; align-items: flex-start; gap: 20px; }
        
        @page { size: A4; margin: 3cm 2cm 2cm 3cm; }
        #footer { position: running(footer); font-family: Arial, sans-serif; font-size: 10pt; text-align: center; width: 100%; display: none; }

        @media print {
            body { background-color: #fff; padding: 0; margin: 0; }
            .control-panel, .modal, #save-controls { display: none !important; }
            .page-container { box-shadow: none; margin: 0; padding: 0; width: 100%; min-height: auto; border: none; }
            .email-autor { display: none !important; }
            #footer { display: block; }
        }
        
        .control-panel { position: sticky; top: 20px; width: 400px; background: #f9f9f9; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 10; }
        .control-panel h2 { margin-top: 0; text-align: center; color: #333; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group button { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        .control-panel button { background-color: #1a73e8; color: white; font-weight: bold; cursor: pointer; }
        .control-panel button:hover { background-color: #1765cc; }
        .control-panel button:disabled { background-color: #999; cursor: not-allowed; }
        #interactive-controls button { margin-top: 10px; }
        #continueBtn { background-color: #28a745; } #continueBtn:hover { background-color: #218838; }
        #concludeBtn { background-color: #fd7e14; } #concludeBtn:hover { background-color: #e8681b; }
        #finalizeBtn { background-color: #ffc107; color: black; } #finalizeBtn:hover { background-color: #e0a800; }
        #finishBtn { background-color: #dc3545; } #finishBtn:hover { background-color: #c82333; }

        #status { font-weight: bold; text-align: center; margin-top: 10px; min-height: 20px; font-size: 12px; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        .page-container { width: 21cm; min-height: 29.7cm; padding: 3cm 2cm 2cm 3cm; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.5); box-sizing: border-box; }
        
        .abnt-content { font-family: Arial, sans-serif; font-size: 12pt; line-height: 1.5; text-align: justify; }
        .nome-universidade { text-align: center; font-size: 12pt; font-weight: bold; margin-bottom: 2em; }
        .titulo-trabalho { font-size: 14pt; text-align: center; font-weight: bold; text-transform: none; margin-bottom: 2em; }
        .autor { text-align: center; font-size: 12pt; margin-bottom: 1em; }
        .autor sup { font-size: 10pt; }
        .email-autor { text-align: left; font-size: 10pt; margin-top: 2em; border-top: 1px solid #000; padding-top: 10px; }
        .resumo-titulo { font-weight: bold; text-align: left; font-size: 12pt; margin-top: 2em; margin-bottom: 1em; }
        .resumo-texto { text-align: justify; margin-bottom: 1em; }
        .palavras-chave { text-align: left; margin-bottom: 2em; } .palavras-chave strong { font-weight: bold; }
        .abstract-titulo { font-weight: bold; font-style: italic; text-align: left; font-size: 12pt; margin-top: 1em; margin-bottom: 1em; }
        .keywords { text-align: left; margin-bottom: 2em; } .keywords strong { font-weight: bold; font-style: italic; }
        .section-title { font-weight: bold; text-transform: uppercase; text-align: left; font-size: 12pt; margin-top: 2em; margin-bottom: 1em; }
        .abnt-content p { margin-bottom: 1.5em; cursor: pointer; text-indent: 1.25cm; line-height: 1.5; text-align: justify; }
        .abnt-content p:hover { background-color: #f0f8ff; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 750px; max-width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; flex-direction: column; }
        .modal-content h3 { margin-top: 0; color: #1a73e8;}
        .modal-content ul { list-style: none; padding: 0; }
        .modal-content li { margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .modal-content li label { cursor: pointer; font-size: 14px; line-height: 1.4; }
        
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
        .modal-actions button { width: auto; padding: 10px 20px; }

        #regenerate-topics-btn { background-color: #fd7e14; }
        #regenerate-topics-btn:hover { background-color: #e8681b; }
        #confirm-topic-btn { background-color: #28a745; }
        #confirm-topic-btn:hover { background-color: #218838; }

        .modal-content button.close-btn { background: #dc3545; }
        .modal-content button.close-btn:hover { background: #c82333; }

        .citation-example { background: #e7f3ff; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 12px; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="control-panel">
            <div id="initial-form">
                <h2>🎓 Gerador de Artigo ABNT</h2>
                <p style="text-align:center; font-size:12px; margin-top:-10px; margin-bottom:20px; color:#6f42c1;"><strong>Powered by Puter.ai</strong></p>
                
                <div class="form-group">
                    <label>Universidade:</label>
                    <input id="universidade" type="text" value="Universidade Federal">
                </div>
                <div class="form-group">
                    <label>Título do Trabalho:</label>
                    <input id="titulo" type="text" placeholder="Escreva sua ideia de tema aqui">
                </div>
                <div class="form-group">
                    <label>Autor(es):</label>
                    <input id="autor" type="text" placeholder="Nome Sobrenome">
                </div>
                <div class="form-group">
                    <label>Email do Autor:</label>
                    <input id="email" type="email" value="seu.email@exemplo.com">
                </div>

                <button id="startBtn">🚀 Iniciar e Otimizar Tema</button>
            </div>
            
            <div id="interactive-controls" style="display: none;">
                 <!-- ... conteúdo inalterado ... -->
            </div>

            <div id="save-controls" style="margin-top: 20px; border-top: 1px solid #ccc; padding-top: 15px;">
                 <!-- ... conteúdo inalterado ... -->
            </div>

            <div id="status" class="info">
                🎯 Preencha os dados e clique em "Iniciar"
            </div>
        </div>
        
        <div class="page-container">
            <div class="abnt-content" id="content-output">
                 <!-- ... conteúdo inalterado ... -->
            </div>
            <div id="footer"></div>
        </div>
        
        <div id="reference-modal" class="modal">
             <!-- ... conteúdo inalterado ... -->
        </div>

        <!-- MODAL DE SUGESTÕES DE TEMA (MODIFICADO) -->
        <div id="topic-suggestion-modal" class="modal">
            <div class="modal-content">
                <h3>✨ Sugestões para o seu Tema</h3>
                <p>Analisamos sua ideia e preparamos algumas opções. Escolha a melhor para continuar ou gere novas sugestões.</p>
                <div id="topic-list" style="margin: 20px 0; flex-grow: 1;">
                    <!-- Conteúdo preenchido via JavaScript -->
                </div>
                <div class="modal-actions">
                    <button id="regenerate-topics-btn">🔄 Gerar Outros Temas</button>
                    <button id="confirm-topic-btn">✅ Confirmar e Iniciar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ELEMENTOS DA UI (COM NOVA ADIÇÃO) ---
        const elements = {
            startBtn: document.getElementById('startBtn'),
            // ... outros elementos
            topicSuggestionModal: document.getElementById('topic-suggestion-modal'),
            topicListDiv: document.getElementById('topic-list'),
            confirmTopicBtn: document.getElementById('confirm-topic-btn'),
            regenerateTopicsBtn: document.getElementById('regenerate-topics-btn'), // NOVO BOTÃO
        };

        // --- ESTADO DA APLICAÇÃO (COM NOVA ADIÇÃO) ---
        let userInputs = {};
        let articleContent = { introducao: [], desenvolvimento: [], conclusao: [] };
        let finalReferences = []; 
        let currentParagraphId = null;
        let currentSection = 'introducao';
        let sectionOrder = ['introducao', 'desenvolvimento', 'conclusao'];
        let currentModalReferences = [];
        let originalUserTitle = ''; // NOVO: Guarda o tema original do usuário

        // --- FUNÇÃO DE GERAÇÃO COM PUTER AI ---
        async function callPuterAI(prompt) {
             try {
                log('🤖 Gerando conteúdo com a IA do Puter...', 'info');
                const response = await puter.ai.chat([{ role: 'user', content: prompt }]);
                if (!response || !response.message || !response.message.content) throw new Error('Resposta inválida da IA.');
                return response.message.content.trim();
            } catch (error) {
                console.error('Erro na IA do Puter:', error);
                const message = (error.message || 'Erro desconhecido.').toLowerCase().includes('user cancelled') 
                    ? '⚠️ Autenticação cancelada.' 
                    : `❌ Erro ao gerar conteúdo: ${error.message}`;
                log(message, 'error');
                throw error;
            }
        }

        // --- FUNÇÕES AUXILIARES DE FEEDBACK ---
        function log(message, type = 'info') {
            elements.statusDiv.className = type;
            elements.statusDiv.innerHTML = `<div>${getStatusIcon(type)} ${message}</div><div style="font-size: 10px; margin-top: 5px; opacity: 0.7;">${new Date().toLocaleTimeString()}</div>`;
        }
        function getStatusIcon(type) {
            const icons = { success: '✅', error: '❌', warning: '⚠️', info: 'ℹ️' };
            return icons[type] || 'ℹ️';
        }

        // --- LÓGICA DE CORREÇÃO E SUGESTÃO DE TEMAS ---
        async function refineAndSuggestTopics(title) {
            log('Analisando tema e gerando sugestões...', 'info');
            const prompt = `
                Analise o tema para um artigo: "${title}".
                1. Corrija-o para ser um título acadêmico claro e impactante.
                2. Gere 9 temas alternativos criativos com base na ideia principal.
                Retorne sua resposta APENAS no formato JSON, com as chaves "corrected_title" e "suggestions".
            `;
            try {
                const response = await callPuterAI(prompt);
                const jsonString = response.substring(response.indexOf('{'), response.lastIndexOf('}') + 1);
                return JSON.parse(jsonString);
            } catch (error) {
                log('⚠️ Não foi possível gerar sugestões. Usando o tema original.', 'warning');
                return { corrected_title: title, suggestions: [] };
            }
        }

        function populateAndShowTopicModal(topicData, originalTitle) {
            let html = `
                <p style="background-color:#f0f8ff; padding:10px; border-radius:4px; border-left: 4px solid #1a73e8;">
                    <strong>Sua ideia original:</strong> <em>${originalTitle}</em>
                </p>
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; margin-top:15px;">
                    <div style="margin-bottom:12px;">
                        <input type="radio" id="topic-0" name="topic-choice" value="${topicData.corrected_title}" checked>
                        <label for="topic-0" style="font-weight:bold; color:#0c5460;">${topicData.corrected_title} (Sugestão Corrigida)</label>
                    </div>
            `;
            topicData.suggestions.forEach((suggestion, index) => {
                html += `
                    <div style="margin-bottom:12px;">
                        <input type="radio" id="topic-${index + 1}" name="topic-choice" value="${suggestion}">
                        <label for="topic-${index + 1}">${suggestion}</label>
                    </div>
                `;
            });
            html += '</div>';
            elements.topicListDiv.innerHTML = html;
            elements.topicSuggestionModal.style.display = 'flex';
        }

        // --- LÓGICA DE REFERÊNCIAS, GERAÇÃO DE CONTEÚDO, ETC. (sem alterações) ---
        // ... (todas as outras funções como displayABNTDocument, fetchParagraphReferences, etc. permanecem aqui) ...
        function displayABNTDocument() { /* ... código sem alterações ... */ }
        async function proceedWithArticleGeneration() { /* ... código sem alterações ... */ }

        // --- EVENTOS E FLUXO PRINCIPAL (MODIFICADO) ---
        
        // 1. Botão Iniciar
        elements.startBtn.addEventListener('click', async () => {
            userInputs = {
                universidade: document.getElementById('universidade').value,
                titulo: document.getElementById('titulo').value,
                autor: document.getElementById('autor').value,
                email: document.getElementById('email').value
            };
            if (!userInputs.titulo || !userInputs.autor) {
                log('❌ Preencha título e autor.', 'error');
                return;
            }
            originalUserTitle = userInputs.titulo; // Salva o tema original
            elements.startBtn.disabled = true;

            try {
                const topicData = await refineAndSuggestTopics(originalUserTitle);
                populateAndShowTopicModal(topicData, originalUserTitle);
            } catch (error) {
                log('❌ Erro ao otimizar tema. Iniciando com o original.', 'error');
                await proceedWithArticleGeneration(); // Falha na sugestão, continua com o original
            } finally {
                elements.startBtn.disabled = false;
            }
        });

        // 2. Botão de Confirmação no Modal
        elements.confirmTopicBtn.addEventListener('click', () => {
            const selectedTopic = document.querySelector('input[name="topic-choice"]:checked').value;
            userInputs.titulo = selectedTopic;
            document.getElementById('titulo').value = selectedTopic; // Atualiza o campo na UI
            
            elements.topicSuggestionModal.style.display = 'none';
            log(`✅ Tema selecionado: "${selectedTopic}"`, 'success');

            proceedWithArticleGeneration(); // Inicia a geração do artigo
        });
        
        // 3. NOVO: Botão para Gerar Mais Temas
        elements.regenerateTopicsBtn.addEventListener('click', async () => {
            elements.regenerateTopicsBtn.disabled = true;
            elements.confirmTopicBtn.disabled = true;
            log('🔄 Gerando novas sugestões de temas...', 'info');

            try {
                // Chama a IA novamente com o título ORIGINAL
                const newTopicData = await refineAndSuggestTopics(originalUserTitle);
                
                // Repopula o modal com a nova lista
                populateAndShowTopicModal(newTopicData, originalUserTitle);
                log('✨ Novas sugestões prontas! Escolha a melhor.', 'success');
            } catch (error) {
                log('❌ Erro ao gerar novas sugestões.', 'error');
            } finally {
                elements.regenerateTopicsBtn.disabled = false;
                elements.confirmTopicBtn.disabled = false;
            }
        });

        // --- INICIALIZAÇÃO ---
        log('🎯 Preencha os dados e clique em "Iniciar"', 'info');

        // Cole aqui o restante das suas funções JS que não foram alteradas
        // (como handleSectionGeneration, finalizeBtn, savePdfBtn, etc.)
        // Para fins de completude, vou adicioná-las abaixo.
        
        async function proceedWithArticleGeneration() {
            try {
                const prompt = `Escreva um parágrafo acadêmico de introdução para o artigo "${userInputs.titulo}". O parágrafo deve ter entre 80-120 palavras, usar linguagem formal e contextualizar o tema, sem citações.`;
                const content = await callPuterAI(prompt);
                
                articleContent.introducao.push(content);
                displayABNTDocument();
                
                document.getElementById('initial-form').style.display = 'none';
                document.getElementById('interactive-controls').style.display = 'block';
                elements.currentSectionNameSpan.textContent = 'Introdução';
                log('✅ Artigo iniciado com sucesso!', 'success');
            } catch (error) {
                elements.startBtn.disabled = false;
            }
        }
        function displayABNTDocument() {
            let content = `
                <div class="nome-universidade">${userInputs.universidade || ''}</div>
                <div class="titulo-trabalho">${userInputs.titulo || ''}</div>
                <div class="autor">${userInputs.autor || ''}<sup>1</sup></div>
            `;
            if (userInputs.resumo) {
                content += `<div class="resumo-titulo">Resumo</div><div class="resumo-texto">${userInputs.resumo}</div>`;
                if (userInputs.palavrasChave) content += `<div class="palavras-chave"><strong>Palavras-chave:</strong> ${userInputs.palavrasChave}</div>`;
                if (userInputs.abstract) content += `<div class="abstract-titulo">Abstract</div><div class="resumo-texto">${userInputs.abstract}</div>`;
                if (userInputs.keywords) content += `<div class="keywords"><strong>Keywords:</strong> ${userInputs.keywords}.</div>`;
            }
            const sections = [{ name: 'INTRODUÇÃO', key: 'introducao' }, { name: 'DESENVOLVIMENTO', key: 'desenvolvimento' }, { name: 'CONCLUSÃO', key: 'conclusao' }];
            sections.forEach(section => {
                if (articleContent[section.key].length > 0) {
                    content += `<div class="section-title">${section.name}</div>`;
                    articleContent[section.key].forEach((text, index) => {
                        content += `<p data-id="${section.key}-${index}" title="💡 Clique para adicionar referências">${text}</p>`;
                    });
                }
            });
            if (finalReferences.length > 0) {
                content += `<div class="section-title">REFERÊNCIAS</div><div style="text-align: left;">${formatarReferenciasABNT()}</div>`;
            }
            if (userInputs.email) {
                content += `<div class="email-autor"><sup>1</sup> ${userInputs.universidade || ''}, ${userInputs.email}</div>`;
            }
            elements.outputDiv.innerHTML = content;
            elements.footerDiv.innerHTML = `${userInputs.universidade || 'Instituição'}, jun. 2025`;
        }

        function formatarReferenciasABNT() {
             const sortedReferences = [...finalReferences].sort((a, b) => a.authors[0].split(' ').pop().toUpperCase().localeCompare(b.authors[0].split(' ').pop().toUpperCase()));
            return sortedReferences.map(ref => {
                const authors = ref.authors.map(author => {
                    const names = author.split(' ');
                    const lastName = names.pop().toUpperCase();
                    return `${lastName}, ${names.join(' ')}`;
                });
                const authorStr = authors.length > 3 ? `${authors[0]} et al.` : authors.join('; ');
                return `${authorStr}. <strong>${ref.title}</strong>. ${ref.year}. Disponível em: <${ref.url}>. Acesso em: ${new Date().toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' })}.`;
            }).join('<br><br>');
        }
    </script>
</body>
</html>
