<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gerador de Artigo Cient√≠fico com IA do Puter</title>
    <!-- A √∫nica biblioteca necess√°ria para a funcionalidade do Puter -->
    <script src="https://js.puter.com/v2/"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Arial&display=swap');
        body { background-color: #e0e0e0; font-family: Arial, sans-serif; padding: 20px; }
        .main-container { display: flex; justify-content: center; align-items: flex-start; gap: 20px; }
        
        @page {
            size: A4;
            margin-top: 3cm;
            margin-bottom: 2cm;
            margin-left: 3cm;
            margin-right: 2cm;
            @bottom-center {
                content: element(footer);
                font-family: Arial, sans-serif;
                font-size: 10pt;
                color: #000;
                text-align: center;
            }
        }
        #footer { position: running(footer); font-family: Arial, sans-serif; font-size: 10pt; text-align: center; width: 100%; display: none; }

        @media print {
            body { background-color: #fff; padding: 0; margin: 0; }
            .control-panel, #reference-modal, #topic-suggestion-modal, #save-controls, #paragraph-start-modal { display: none !important; }
            .page-container { box-shadow: none; margin: 0; padding: 0; width: 100%; min-height: auto; border: none; }
            .email-autor { display: none !important; }
            #footer { display: block; }
        }
        
        .control-panel { position: sticky; top: 20px; width: 400px; background: #f9f9f9; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 10; }
        .control-panel h2 { margin-top: 0; text-align: center; color: #333; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group button, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        .control-panel button { background-color: #1a73e8; color: white; font-weight: bold; cursor: pointer; }
        .control-panel button:hover { background-color: #1765cc; }
        .control-panel button:disabled { background-color: #999; cursor: not-allowed; }
        #interactive-controls button { margin-top: 10px; }
        
        #inicioBtn { background-color: #28a745; }
        #inicioBtn:hover { background-color: #218838; }
        #meioBtn { background-color: #007bff; }
        #meioBtn:hover { background-color: #0056b3; }
        #fimBtn { background-color: #dc3545; }
        #fimBtn:hover { background-color: #c82333; }
        #rewriteBtn { background-color: #fd7e14; }
        #rewriteBtn:hover { background-color: #e8681b; }

        .page-counter { 
            background-color: #e8f4fd; 
            padding: 10px; 
            border-radius: 4px; 
            margin-bottom: 15px; 
            text-align: center; 
            font-weight: bold; 
            color: #0c5460; 
            border: 1px solid #bee5eb;
        }

        #status { font-weight: bold; text-align: center; margin-top: 10px; min-height: 20px; font-size: 12px; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        .page-container { width: 21cm; min-height: 29.7cm; padding: 3cm 2cm 2cm 3cm; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.5); box-sizing: border-box; }
        
        .abnt-content { font-family: Arial, sans-serif; font-size: 12pt; line-height: 1.5; text-align: justify; }
        .nome-universidade { text-align: center; font-size: 12pt; font-weight: bold; margin-bottom: 2em; }
        .titulo-trabalho { font-size: 14pt; text-align: center; font-weight: bold; text-transform: none; margin-bottom: 2em; }
        .autor { text-align: center; font-size: 12pt; margin-bottom: 1em; }
        .autor sup { font-size: 10pt; }
        .email-autor { text-align: left; font-size: 10pt; margin-top: 2em; border-top: 1px solid #000; padding-top: 10px; }
        .resumo-titulo { font-weight: bold; text-align: left; font-size: 12pt; margin-top: 2em; margin-bottom: 1em; }
        .resumo-texto { text-align: justify; margin-bottom: 1em; }
        .palavras-chave { text-align: left; margin-bottom: 2em; }
        .palavras-chave strong { font-weight: bold; }
        .abstract-titulo { font-weight: bold; font-style: italic; text-align: left; font-size: 12pt; margin-top: 1em; margin-bottom: 1em; }
        .keywords { text-align: left; margin-bottom: 2em; }
        .keywords strong { font-weight: bold; font-style: italic; }
        .section-title { font-weight: bold; text-transform: uppercase; text-align: left; font-size: 12pt; margin-top: 2em; margin-bottom: 1em; }
        .abnt-content p { margin-bottom: 1.5em; cursor: pointer; text-indent: 1.25cm; line-height: 1.5; text-align: justify; }
        .abnt-content p:hover { background-color: #f0f8ff; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 700px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .modal-content h3 { margin-top: 0; }
        .modal-content ul { list-style: none; padding: 0; }
        .modal-content li { margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .modal-content li label { cursor: pointer; font-size: 14px; line-height: 1.4; }
        .modal-content button { margin-top: 10px; background: #1a73e8; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        .modal-content button:hover { background: #1765cc; }
        .modal-content .close-btn { background: #dc3545; }
        .modal-content .close-btn:hover { background: #c82333; }
        .search-info { background: #e8f4f8; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 13px; }
        .no-results { background: #fff3cd; padding: 15px; border-radius: 4px; color: #856404; }
        .duplicate-warning { background: #f8d7da; padding: 10px; border-radius: 4px; margin-bottom: 10px; color: #721c24; font-size: 12px; }
        .citation-example { background: #e7f3ff; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 12px; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="control-panel">
            <div id="initial-form">
                <h2>üéì Gerador de Artigo ABNT</h2>
                <p style="text-align:center; font-size:12px; margin-top:-10px; margin-bottom:20px; color:#6f42c1;"><strong>Powered by Puter.ai</strong></p>
                
                <div class="form-group">
                    <label>Universidade:</label>
                    <input id="universidade" type="text" value="Universidade Federal">
                </div>
                <div class="form-group">
                    <label>T√≠tulo do Trabalho:</label>
                    <input id="titulo" type="text" placeholder="Escreva um tema, mesmo que com erros">
                </div>
                <div class="form-group">
                    <label>Autor(es):</label>
                    <input id="autor" type="text" placeholder="Nome Sobrenome">
                </div>
                <div class="form-group">
                    <label>Email do Autor:</label>
                    <input id="email" type="email" value="seu.email@exemplo.com">
                </div>
                <div class="form-group">
                    <label>N√≠vel de Forma√ß√£o:</label>
                    <select id="nivel-formacao">
                        <option value="Graduando">Graduando (cursando gradua√ß√£o)</option>
                        <option value="Graduado">Graduado (formado)</option>
                        <option value="Especialista">Especialista (p√≥s-gradua√ß√£o lato sensu)</option>
                        <option value="Especializando">Especializando (cursando especializa√ß√£o)</option>
                        <option value="Mestrando">Mestrando (cursando mestrado)</option>
                        <option value="Mestre">Mestre (formado)</option>
                        <option value="Doutorando">Doutorando (cursando doutorado)</option>
                        <option value="Doutor">Doutor (formado)</option>
                        <option value="P√≥s-Doutor">P√≥s-Doutor</option>
                    </select>
                </div>

                <button id="startBtn">üöÄ Iniciar e Otimizar Tema</button>
                
                <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;">
                    ‚úÖ IA ir√° corrigir seu tema e sugerir alternativas<br>
                    ‚úÖ Formata√ß√£o ABNT rigorosa
                </div>
            </div>
            
            <div id="interactive-controls" style="display: none;">
                <h2>üìù Controle de Escrita</h2>
                
                <div class="page-counter">
                    üìÑ P√°ginas: <span id="page-count">1</span>
                </div>
                
                <p>Se√ß√£o atual: <strong id="current-section-name"></strong></p>
                
                <button id="inicioBtn">üåü IN√çCIO</button>
                <button id="meioBtn">üìù MEIO</button>
                <button id="fimBtn">üéØ FIM</button>
                <button id="rewriteBtn" style="display: none; background-color: #fd7e14;">‚úèÔ∏è REESCREVER</button>
                
                <div style="text-align: center; margin-top: 10px; font-size: 11px; color: #666;">
                    üí° Clique nos par√°grafos para adicionar refer√™ncias<br>
                    üîç Sistema anti-repeti√ß√£o ativado
                </div>
            </div>

            <div id="save-controls" style="margin-top: 20px; border-top: 1px solid #ccc; padding-top: 15px;">
                <h2>üíæ Salvar Artigo</h2>
                <div class="form-group">
                    <button id="savePdfBtn">üìÑ Salvar como PDF</button>
                </div>
            </div>

            <div id="status" class="info">
                üéØ Preencha os dados e clique em "Iniciar"
            </div>
        </div>
        
        <div class="page-container">
            <div class="abnt-content" id="content-output">
                <p style="text-align:center; color: #777; padding-top: 0;">
                    üìÑ <strong>Para Come√ßar:</strong><br><br>
                    <strong>1. Preencha os Dados:</strong> T√≠tulo e Autor s√£o essenciais.<br>
                    <strong>2. Clique em "Iniciar e Otimizar Tema":</strong> Nossa IA ir√° analisar, corrigir e sugerir melhorias para o seu tema.<br>
                    <strong>3. Autentica√ß√£o:</strong> Se necess√°rio, uma janela de login do Puter aparecer√°.<br><br>
                    ---<br><br>
                    ‚úÖ Gera√ß√£o de conte√∫do com a IA do Puter<br>
                    üîç Sistema avan√ßado anti-repeti√ß√£o
                </p>
            </div>
            <div id="footer"></div>
        </div>
        
        <div id="reference-modal" class="modal">
            <div class="modal-content">
                <h3>üìö Adicionar Refer√™ncias AUTOR-DATA</h3>
                <div class="citation-example">
                    <strong>üìñ Exemplo de cita√ß√£o no par√°grafo:</strong><br>
                    "...crucial para o avan√ßo cient√≠fico e tecnol√≥gico (SILVA; SANTOS, 2023)."<br>
                    <em>As refer√™ncias ser√£o automaticamente adicionadas √† bibliografia final.</em>
                </div>
                <div id="search-info" class="search-info" style="display: none;"></div>
                <div id="duplicate-warning" class="duplicate-warning" style="display: none;"></div>
                <p>Selecione as refer√™ncias para adicionar ao final do par√°grafo:</p>
                <ul id="reference-list"></ul>
                <button id="add-references-btn">‚úÖ Adicionar ao Final do Par√°grafo</button>
                <button class="close-btn" id="close-modal-btn">‚ùå Fechar</button>
            </div>
        </div>

        <div id="topic-suggestion-modal" class="modal">
            <div class="modal-content">
                <h3>‚ú® Sugest√µes para o seu Tema</h3>
                <p>Analisamos seu tema para aprimor√°-lo. Escolha a melhor op√ß√£o abaixo para continuar:</p>
                <div id="topic-list" style="margin: 20px 0;">
                </div>
                <button id="confirm-topic-btn">‚úÖ Confirmar Tema e Iniciar</button>
            </div>
        </div>

        <div id="paragraph-start-modal" class="modal">
            <div class="modal-content">
                <h3 id="paragraph-modal-title">üìù Escolha como iniciar o pr√≥ximo par√°grafo</h3>
                <p style="background-color:#e8f4f8; padding:10px; border-radius:4px; margin-bottom:15px;">
                    <strong>üí° Dica:</strong> Selecione a introdu√ß√£o que melhor se encaixa no desenvolvimento da sua ideia.
                </p>
                <div id="paragraph-starts-list" style="margin: 20px 0; max-height: 400px; overflow-y: auto;">
                </div>
                <button id="generate-paragraph-btn" disabled>‚úÖ Escrever Par√°grafo com Esta Introdu√ß√£o</button>
                <button class="close-btn" id="close-paragraph-modal-btn">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // --- ELEMENTOS DA UI ---
        const elements = {
            startBtn: document.getElementById('startBtn'),
            inicioBtn: document.getElementById('inicioBtn'),
            meioBtn: document.getElementById('meioBtn'),
            fimBtn: document.getElementById('fimBtn'),
            rewriteBtn: document.getElementById('rewriteBtn'),
            outputDiv: document.getElementById('content-output'),
            statusDiv: document.getElementById('status'),
            currentSectionNameSpan: document.getElementById('current-section-name'),
            pageCountSpan: document.getElementById('page-count'),
            referenceModal: document.getElementById('reference-modal'),
            referenceList: document.getElementById('reference-list'),
            addReferencesBtn: document.getElementById('add-references-btn'),
            closeModalBtn: document.getElementById('close-modal-btn'),
            searchInfoDiv: document.getElementById('search-info'),
            duplicateWarningDiv: document.getElementById('duplicate-warning'),
            savePdfBtn: document.getElementById('savePdfBtn'),
            footerDiv: document.getElementById('footer'),
            topicSuggestionModal: document.getElementById('topic-suggestion-modal'),
            topicListDiv: document.getElementById('topic-list'),
            confirmTopicBtn: document.getElementById('confirm-topic-btn'),
            paragraphStartModal: document.getElementById('paragraph-start-modal'),
            paragraphModalTitle: document.getElementById('paragraph-modal-title'),
            paragraphStartsList: document.getElementById('paragraph-starts-list'),
            generateParagraphBtn: document.getElementById('generate-paragraph-btn'),
            closeParagraphModalBtn: document.getElementById('close-paragraph-modal-btn'),
        };

        // --- ESTADO DA APLICA√á√ÉO ---
        let userInputs = {};
        let articleContent = { introducao: [], desenvolvimento: [], conclusao: [] };
        let finalReferences = []; 
        let currentParagraphId = null;
        let currentSection = 'introducao';
        let sectionOrder = ['introducao', 'desenvolvimento', 'conclusao'];
        let currentModalReferences = [];
        let usedPhrases = new Set();
        let lastParagraphIndex = -1;
        let sessionActive = false;
        let selectedParagraphStart = '';
        let currentGenerationPhase = ''; 

        // --- FUN√á√ÉO DE GERA√á√ÉO COM PUTER AI ---
        async function callPuterAI(prompt) {
            try {
                log('ü§ñ Gerando conte√∫do com a IA do Puter...', 'info');
                const response = await puter.ai.chat([{ role: 'user', content: prompt }]);
                
                if (!response || !response.message || !response.message.content) {
                    throw new Error('Resposta inv√°lida da IA do Puter.');
                }
                
                return response.message.content.trim();
            } catch (error) {
                console.error('Erro na IA do Puter:', error);
                if (error.message && error.message.toLowerCase().includes('user cancelled')) {
                    log('‚ö†Ô∏è Autentica√ß√£o cancelada. N√£o √© poss√≠vel gerar conte√∫do.', 'warning');
                } else {
                    log(`‚ùå Erro ao gerar conte√∫do: ${error.message || 'Erro desconhecido.'}`, 'error');
                }
                throw error;
            }
        }

        // --- SISTEMA ANTI-REPETI√á√ÉO ---
        function extractKeyPhrases(text) {
            const cleanText = text.replace(/\([^)]*\)/g, '').replace(/[.,;:!?]/g, '').toLowerCase();
            const words = cleanText.split(/\s+/).filter(word => word.length > 3);
            const phrases = [];
            
            for (let i = 0; i < words.length - 1; i++) {
                phrases.push(words.slice(i, i + 2).join(' ')); 
                if (i < words.length - 2) phrases.push(words.slice(i, i + 3).join(' ')); 
                if (i < words.length - 3) phrases.push(words.slice(i, i + 4).join(' '));
                if (i < words.length - 4) phrases.push(words.slice(i, i + 5).join(' '));
                if (i < words.length - 5) phrases.push(words.slice(i, i + 6).join(' '));
            }
            
            const conceptPatterns = [
                /matem√°tica.*disciplina/gi, /capacita.*indiv√≠duos/gi, /pensamento.*cr√≠tico/gi,
                /an√°lise.*cr√≠tica/gi, /racioc√≠nio.*l√≥gico/gi, /resolu√ß√£o.*problemas/gi,
                /dessa forma/gi, /al√©m disso/gi, /ao trabalhar/gi, /essa abordagem/gi
            ];
            
            conceptPatterns.forEach(pattern => {
                const matches = text.match(pattern);
                if (matches) {
                    matches.forEach(match => phrases.push(match.toLowerCase()));
                }
            });
            
            return phrases;
        }

        function extractUsedConcepts(text) {
            const genericConcepts = [
                'linguagem universal', 'forma√ß√£o de habilidades', 'capacita indiv√≠duos', 
                'interpretar dados', 'tomada de decis√µes', 'racioc√≠nio l√≥gico',
                'pensamento cr√≠tico', 'resolu√ß√£o de problemas', 'an√°lise cr√≠tica',
                'sistemas complexos', 'interdisciplinar', 'inova√ß√£o', 'criatividade',
                'compet√™ncias essenciais', 'modelagem', 'abstra√ß√£o', 'generaliza√ß√£o',
                'investiga√ß√£o', 'experimenta√ß√£o', 'autonomia intelectual',
                'flexibilidade cognitiva', 'argumenta√ß√£o', 'fundamentar decis√µes',
                'desenvolvimento', 'sociedade', 'impacto', 'import√¢ncia',
                'contribui√ß√£o', 'benef√≠cios', 'vantagens', 'processo',
                'metodologia', 'abordagem', 'estrat√©gia', 'implementa√ß√£o'
            ];
            
            const specificPhrases = [];
            const sentences = text.split('.').slice(0, 5);
            sentences.forEach(sentence => {
                const words = sentence.toLowerCase().split(' ').filter(w => w.length > 4);
                if (words.length >= 3) {
                    specificPhrases.push(words.slice(0, 3).join(' '));
                }
            });
            
            const usedConcepts = genericConcepts.filter(concept => 
                text.toLowerCase().includes(concept.toLowerCase())
            );
            
            return [...new Set([...usedConcepts, ...specificPhrases])];
        }

        function addPhrasesToMemory(text) {
            const phrases = extractKeyPhrases(text);
            phrases.forEach(phrase => usedPhrases.add(phrase));
        }

        function createAntiRepetitionPrompt(phase) {
            const allContent = Object.values(articleContent).flat().join(' ');
            const usedPhrasesArray = Array.from(usedPhrases);
            const usedConcepts = extractUsedConcepts(allContent);
            
            let phaseInstructions = '';
            switch(phase) {
                case 'inicio':
                    phaseInstructions = 'Este √© um par√°grafo de IN√çCIO/ABERTURA da se√ß√£o. Deve apresentar e contextualizar o tema de forma introdut√≥ria com IDEIAS TOTALMENTE NOVAS.';
                    break;
                case 'meio':
                    phaseInstructions = 'Este √© um par√°grafo de DESENVOLVIMENTO/MEIO da se√ß√£o. Deve expandir com ASPECTOS COMPLETAMENTE DIFERENTES do que j√° foi escrito. NUNCA repita ideias anteriores.';
                    break;
                case 'fim':
                    phaseInstructions = 'Este √© um par√°grafo de FINALIZA√á√ÉO da se√ß√£o. Deve sintetizar e concluir com PERSPECTIVAS ORIGINAIS, usando conectivos de fechamento.';
                    break;
            }

            return `
INSTRU√á√ïES CR√çTICAS PARA ESCRITA ACAD√äMICA SEM REPETI√á√ïES:

${phaseInstructions}

ARTIGO: "${userInputs.titulo}"
CONTE√öDO J√Å ESCRITO: "${allContent}"

CONCEITOS J√Å UTILIZADOS (NUNCA REPITA): ${usedConcepts.join(', ')}
FRASES PROIBIDAS: ${usedPhrasesArray.slice(-30).join(' | ')}

REGRAS OBRIGAT√ìRIAS:
1. JAMAIS use os conceitos j√° mencionados acima.
2. NUNCA comece frases repetindo estruturas j√° usadas.
3. VARIE completamente a estrutura das frases.
4. Use sin√¥nimos e reformula√ß√µes ORIGINAIS.
5. Aborde √ÇNGULOS TOTALMENTE DIFERENTES do tema.
6. 80-120 palavras, linguagem acad√™mica formal.
7. SEJA COMPLETAMENTE ORIGINAL - n√£o repita nenhuma ideia anterior.

ESTRAT√âGIAS PARA NOVOS √ÇNGULOS (adapte ao seu tema):
- Perspectiva hist√≥rica e evolutiva
- Impactos sociais e culturais
- Aplica√ß√µes pr√°ticas e tecnol√≥gicas
- Aspectos econ√¥micos e pol√≠ticos
- Dimens√µes √©ticas e filos√≥ficas
- Compara√ß√µes internacionais
- Desafios e oportunidades futuras
- Metodologias e abordagens inovadoras

ESCREVA um par√°grafo √öNICO e TOTALMENTE ORIGINAL sobre "${userInputs.titulo}":`;
        }

        // --- FUN√á√ïES PARA GERA√á√ÉO DE OP√á√ïES DE PAR√ÅGRAFO ---
        async function generateParagraphStartOptions(phase) {
            const allContent = Object.values(articleContent).flat().join(' ');
            const usedConcepts = extractUsedConcepts(allContent);

            let sectionDescription = '';
            let exampleVariety = '';
            switch(phase) {
                case 'inicio':
                    sectionDescription = 'para a se√ß√£o de INTRODU√á√ÉO. Devem ser aberturas que contextualizam o tema.';
                    exampleVariety = `
                    1. A discuss√£o contempor√¢nea sobre...
                    2. Historicamente, o conceito de...
                    3. No cen√°rio atual, a relev√¢ncia de...`;
                    break;
                case 'meio':
                    sectionDescription = 'para a se√ß√£o de DESENVOLVIMENTO. Cada in√≠cio deve abordar um √¢ngulo diferente.';
                     exampleVariety = `
                    1. Sob uma perspectiva econ√¥mica...
                    2. As implica√ß√µes tecnol√≥gicas revelam...
                    3. Do ponto de vista cultural...`;
                    break;
                case 'fim':
                    sectionDescription = 'para a se√ß√£o de CONCLUS√ÉO. Devem usar conectivos de fechamento e sintetizar ideias.';
                    exampleVariety = `
                    1. Em suma, as evid√™ncias apontam...
                    2. Conclui-se, portanto, que...
                    3. Diante do exposto, torna-se evidente...`;
                    break;
            }
            
            const prompt = `
Com base no artigo sobre "${userInputs.titulo}" e no conte√∫do j√° escrito: "${allContent}"

INSTRU√á√ïES:
1. Gere 10 in√≠cios de par√°grafo √öNICOS E ORIGINAIS ${sectionDescription}.
2. Cada in√≠cio deve ter entre 10-20 palavras.
3. EVITE repetir os conceitos j√° usados: ${usedConcepts.slice(0, 10).join(', ')}.
4. Use estruturas variadas e apropriadas para a fase do texto (in√≠cio, meio ou fim).

FORMATO: Retorne apenas as 10 op√ß√µes numeradas, uma por linha.
1. [primeiro in√≠cio]
...
10. [d√©cimo in√≠cio]

EXEMPLO DE VARIEDADE (adapte ao seu tema):
${exampleVariety}

AGORA GERE 10 IN√çCIOS PARA A FASE DE '${phase.toUpperCase()}' do artigo "${userInputs.titulo}":`;

            try {
                const response = await callPuterAI(prompt);
                return parseStartOptions(response);
            } catch (error) {
                console.error('Erro ao gerar op√ß√µes:', error);
                return generateFallbackOptions();
            }
        }

        function parseStartOptions(response) {
            const lines = response.split('\n').filter(line => line.trim().match(/^\d+\./));
            return lines.map(line => line.replace(/^\d+\.\s*/, '').trim()).slice(0, 10);
        }

        function generateFallbackOptions() {
            return [
                "Sob uma perspectiva contempor√¢nea", "As evid√™ncias emp√≠ricas sugerem", "Do ponto de vista metodol√≥gico",
                "Pesquisas recentes indicam", "Na dimens√£o pr√°tica, verifica-se", "Especialistas da √°rea argumentam",
                "Uma an√°lise comparativa revela", "Os dados estat√≠sticos demonstram", "Atrav√©s de estudos longitudinais",
                "A literatura especializada aponta"
            ];
        }
        
        async function showParagraphStartModal(phase) {
            currentGenerationPhase = phase;
            const phaseTitles = {
                inicio: 'üåü Como Come√ßar a Introdu√ß√£o?',
                meio: 'üìù Como Continuar o Desenvolvimento?',
                fim: 'üéØ Como Finalizar a Se√ß√£o?'
            };

            log(`Gerando op√ß√µes para ${phase}...`, 'info');
            elements.paragraphModalTitle.textContent = phaseTitles[phase] || 'Escolha como iniciar';
            elements.paragraphStartModal.style.display = 'flex';
            elements.paragraphStartsList.innerHTML = '<p>üîÑ Gerando op√ß√µes criativas...</p>';
            
            try {
                const startOptions = await generateParagraphStartOptions(phase);
                let html = '';
                startOptions.forEach((option, index) => {
                    html += `
                        <div style="margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:4px;">
                            <input type="radio" id="start-${index}" name="paragraph-start" value="${option}">
                            <label for="start-${index}" style="cursor:pointer; margin-left:8px;">
                                ${index + 1}. ${option}...
                            </label>
                        </div>
                    `;
                });
                
                elements.paragraphStartsList.innerHTML = html;
                document.querySelectorAll('input[name="paragraph-start"]').forEach(radio => {
                    radio.addEventListener('change', () => {
                        elements.generateParagraphBtn.disabled = false;
                        selectedParagraphStart = radio.value;
                    });
                });
                
            } catch (error) {
                console.error('Erro ao gerar op√ß√µes:', error);
                elements.paragraphStartsList.innerHTML = '<p>‚ùå Erro ao gerar op√ß√µes. Tente novamente.</p>';
            }
        }
        
        function triggerParagraphOptions(phase) {
            if (phase === 'inicio' && sessionActive) {
                alert('Uma se√ß√£o j√° est√° em andamento. Clique em FIM para conclu√≠-la primeiro.');
                return;
            }
            if ((phase === 'meio' || phase === 'fim') && !sessionActive) {
                alert('Voc√™ precisa iniciar uma nova se√ß√£o clicando em IN√çCIO primeiro.');
                return;
            }
            showParagraphStartModal(phase);
        }


        // --- CONTADOR DE P√ÅGINAS ---
        function updatePageCount() {
            const contentHeight = elements.outputDiv.scrollHeight;
            const pageHeight = 800;
            const pages = Math.max(1, Math.ceil(contentHeight / pageHeight));
            elements.pageCountSpan.textContent = pages;
        }

        // --- FUN√á√ïES AUXILIARES DE FEEDBACK ---
        function log(message, type = 'info') {
            elements.statusDiv.className = type;
            elements.statusDiv.innerHTML = `<div>${getStatusIcon(type)} ${message}</div><div style="font-size: 10px; margin-top: 5px; opacity: 0.7;">${new Date().toLocaleTimeString()}</div>`;
        }
        function getStatusIcon(type) {
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            return icons[type] || '‚ÑπÔ∏è';
        }

        // --- L√ìGICA DE CORRE√á√ÉO E SUGEST√ÉO DE TEMAS ---
        async function refineAndSuggestTopics(originalTitle) {
            log('Analisando tema e gerando sugest√µes...', 'info');
            const prompt = `
                Analise o tema para um artigo: "${originalTitle}".
                1. Corrija erros de gram√°tica/digita√ß√£o e reformule-o para ser um t√≠tulo acad√™mico claro e impactante. Este ser√° o "tema corrigido".
                2. Gere 9 temas alternativos criativos com base na ideia principal.
                Retorne sua resposta APENAS no formato JSON, usando as chaves "corrected_title" e "suggestions".
                Exemplo: {"corrected_title": "T√≠tulo Corrigido", "suggestions": ["Sugest√£o 1", "Sugest√£o 2", ...]}
            `;
            
            try {
                const response = await callPuterAI(prompt);
                const jsonString = response.substring(response.indexOf('{'), response.lastIndexOf('}') + 1);
                const parsed = JSON.parse(jsonString);
                return parsed;
            } catch (error) {
                console.error('Erro ao processar sugest√µes de temas:', error);
                log('‚ö†Ô∏è N√£o foi poss√≠vel gerar sugest√µes. Usando o tema original.', 'warning');
                return { corrected_title: originalTitle, suggestions: [] };
            }
        }

        function populateAndShowTopicModal(topicData, originalTitle) {
            let html = `
                <p style="margin-bottom:15px; background-color:#e8f4f8; padding:10px; border-radius:4px;">
                    <strong>Seu Tema Original:</strong> <em>${originalTitle}</em>
                </p>
                <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                    <div style="margin-bottom:10px;">
                        <input type="radio" id="topic-0" name="topic-choice" value="${topicData.corrected_title}" checked>
                        <label for="topic-0" style="font-weight:bold;">${topicData.corrected_title} (Sugest√£o Corrigida)</label>
                    </div>
            `;
            topicData.suggestions.forEach((suggestion, index) => {
                html += `
                    <div style="margin-bottom:10px;">
                        <input type="radio" id="topic-${index + 1}" name="topic-choice" value="${suggestion}">
                        <label for="topic-${index + 1}">${suggestion}</label>
                    </div>
                `;
            });
            html += '</div>';
            elements.topicListDiv.innerHTML = html;
            elements.topicSuggestionModal.style.display = 'flex';
        }

        // --- SISTEMA DE REFER√äNCIAS ---
        function extractRelevantTerms(text, title = '') {
            const stopwords = ['a', 'o', 'as', 'os', 'de', 'da', 'do', 'e', 'em', 'para', 'com', 'um', 'uma', 'que', 'se', 'por', 'mais', 'como', 's√£o', 'ser', 'artigo', 'trabalho'];
            const combinedText = `${title} ${text}`.toLowerCase();
            const cleanText = combinedText.replace(/[^\w\s√°√©√≠√≥√∫√¢√™√Æ√¥√ª√†√®√¨√≤√π√£√µ√ß]/g, ' ');
            const words = cleanText.split(/\s+/).filter(word => word.length > 3 && !stopwords.includes(word)).reduce((acc, word) => { acc[word] = (acc[word] || 0) + 1; return acc; }, {});
            return Object.entries(words).sort(([,a], [,b]) => b - a).slice(0, 5).map(([word]) => word);
        }
        
        async function fetchParagraphReferences(paragraphText, articleTitle) {
            log('Buscando refer√™ncias acad√™micas...', 'info');
            try {
                const relevantTerms = extractRelevantTerms(paragraphText, articleTitle);
                const query = relevantTerms.join(' ');
                
                elements.searchInfoDiv.innerHTML = `<strong>üîç Buscando por:</strong> <em>${query || "termos gen√©ricos"}</em>`;
                elements.searchInfoDiv.style.display = 'block';
                
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const mockReferences = generateMockReferences(relevantTerms, query);
                log(`${mockReferences.length} refer√™ncias encontradas!`, 'success');
                return mockReferences;
            } catch (error) {
                console.error('Erro na busca de refer√™ncias:', error);
                log('‚ö†Ô∏è Erro na busca de refer√™ncias.', 'error');
                return [];
            }
        }
        
        // ==================================================================
        // FUN√á√ÉO CORRIGIDA
        // ==================================================================
        function generateMockReferences(relevantTerms) {
            // Base de dados de autores com nomes completos
            const mockAuthorsPool = [
                'Jo√£o Carlos Silva', 'Maria Fernanda Santos', 'Pedro Henrique Oliveira', 'Ana Beatriz Costa',
                'Carlos Eduardo Souza', 'Fernanda Cristina Lima', 'Roberto Carlos Pereira', 'Juliana Santos Almeida',
                'Lucas Oliveira Ferreira', 'Camila Alves Rodrigues', 'Rafael Silva Martins', 'Beatriz Lima Carvalho',
                'Thiago Santos Nascimento', 'Let√≠cia Costa Barbosa', 'Gabriel Pereira Ribeiro'
            ];
            const journals = [
                'Revista Brasileira de Educa√ß√£o', 'Cadernos de Pesquisa', 'Educa√ß√£o & Sociedade', 'Revista de Administra√ß√£o P√∫blica',
                'Brazilian Journal of Development', 'Research, Society and Development', 'Revista Eletr√¥nica de Educa√ß√£o',
                'Estudos Avan√ßados', 'Ci√™ncia & Educa√ß√£o', 'Interface - Comunica√ß√£o, Sa√∫de, Educa√ß√£o'
            ];
            const referencias = [];
            const numRefs = Math.floor(Math.random() * 6) + 5;
            
            for (let i = 0; i < numRefs; i++) {
                // Escolhe se a refer√™ncia ter√° 1 ou 2 autores
                const numAuthors = Math.random() > 0.7 ? 2 : 1;
                const authorSet = [];
                const usedIndexes = new Set();
                
                // Seleciona autores √∫nicos da pool
                while(authorSet.length < numAuthors) {
                    const randomIndex = Math.floor(Math.random() * mockAuthorsPool.length);
                    if (!usedIndexes.has(randomIndex)) {
                        authorSet.push(mockAuthorsPool[randomIndex]);
                        usedIndexes.add(randomIndex);
                    }
                }

                const year = 2018 + Math.floor(Math.random() * 7);
                const journal = journals[Math.floor(Math.random() * journals.length)];
                const termSample = relevantTerms.slice(0, 3);
                const titleTemplates = [
                    `An√°lise sobre ${termSample[0] || 'o tema'} e suas implica√ß√µes em ${termSample[1] || 'contextos diversos'}`,
                    `O impacto de ${termSample[0] || 'o tema'} na ${termSample[1] || 'sociedade contempor√¢nea'}`,
                    `Estudo comparativo sobre ${termSample[0] || 'o tema'} e ${termSample[1] || 'metodologias aplicadas'}`,
                    `Perspectivas te√≥ricas de ${termSample[0] || 'o tema'} no contexto ${termSample[1] || 'educacional'}`,
                ];
                const title = titleTemplates[Math.floor(Math.random() * titleTemplates.length)];
                const abstract = `Este estudo apresenta uma an√°lise detalhada sobre ${termSample[0] || 'o tema principal'}, explorando suas m√∫ltiplas dimens√µes. Os resultados indicam contribui√ß√µes para a √°rea.`;

                referencias.push({
                    id: `ref_${Date.now()}_${i}`,
                    title: title,
                    authors: authorSet, // Agora `authors` √© um array de nomes completos, ex: ['Jo√£o Carlos Silva', 'Maria Fernanda Santos']
                    year: year,
                    abstract: abstract,
                    url: `https://doi.org/10.1000/example.${year}.${i + 1}`
                });
            }
            return referencias;
        }
        
        async function openReferenceModal(paragraphId, paragraphText, articleTitle) {
            currentParagraphId = paragraphId;
            elements.referenceList.innerHTML = '<p>üîç Buscando refer√™ncias...</p>';
            elements.addReferencesBtn.disabled = true;
            elements.referenceModal.style.display = 'flex';
            
            const references = await fetchParagraphReferences(paragraphText, articleTitle);
            currentModalReferences = references;
            
            if (references.length === 0) {
                elements.referenceList.innerHTML = `<div class="no-results"><strong>‚ùå Nenhuma refer√™ncia encontrada</strong></div>`;
            } else {
                elements.duplicateWarningDiv.style.display = references.some(ref => finalReferences.some(eRef => eRef.id === ref.id)) ? 'block' : 'none';
                elements.duplicateWarningDiv.innerHTML = `‚ö†Ô∏è Algumas refer√™ncias j√° foram usadas.`;
                
                elements.referenceList.innerHTML = references.map((ref, index) => {
                    const isUsed = finalReferences.some(eRef => eRef.id === ref.id);
                    // L√≥gica de cita√ß√£o na lista (AUTOR, ANO)
                    const citationAuthors = ref.authors.map(author => author.split(' ').pop().toUpperCase());
                    let citationText = '';
                    if (citationAuthors.length === 1) {
                        citationText = `${citationAuthors[0]}`;
                    } else if (citationAuthors.length === 2) {
                        citationText = `${citationAuthors[0]}; ${citationAuthors[1]}`;
                    } else {
                        citationText = `${citationAuthors[0]} et al.`;
                    }

                    return `<li style="${isUsed ? 'background-color:#f8f9fa;':''}">
                                <input type="checkbox" id="ref-${index}" value="${index}">
                                <label for="ref-${index}">
                                    <strong>${citationText} (${ref.year})</strong>
                                    ${isUsed?'<span style="color:#6c757d;"> [J√Å USADA]</span>':''}
                                    <br><em>${ref.title}</em>
                                    <br><small style="color:#666;">${ref.abstract ? ref.abstract.substring(0,120)+'...' : 'Sem resumo'}</small>
                                </label>
                            </li>`;
                }).join('');
                elements.addReferencesBtn.disabled = false;
            }
        }

        function addSelectedReferences() {
            const selectedIndices = Array.from(document.querySelectorAll('#reference-list input:checked')).map(input => parseInt(input.value));
            if (selectedIndices.length === 0) { alert('Selecione ao menos uma refer√™ncia.'); return; }
            
            const paragraphElement = document.querySelector(`p[data-id="${currentParagraphId}"]`);
            if (!paragraphElement) return;

            const [sectionKey, indexStr] = currentParagraphId.split('-');
            const originalText = articleContent[sectionKey][parseInt(indexStr)];
            
            const selectedRefs = selectedIndices.map(index => currentModalReferences[index]);
            
            // A l√≥gica de cita√ß√£o aqui est√° correta e vai funcionar com a nova estrutura de dados
            const citations = selectedRefs.map(ref => {
                const lastNames = ref.authors.map(a => a.split(' ').pop().toUpperCase());
                if (lastNames.length > 2) {
                    return `${lastNames[0]} et al., ${ref.year}`;
                } else {
                    return `${lastNames.join('; ')}, ${ref.year}`;
                }
            });
            const cleanText = originalText.replace(/\s*\([A-Z√Ä-√ô\s;,\d\-\.]+\)\.?$/g, '').trim();
            const newText = `${cleanText} (${citations.join('; ')}).`;
            
            paragraphElement.textContent = newText;
            articleContent[sectionKey][parseInt(indexStr)] = newText;
            
            selectedRefs.forEach(ref => { if (!finalReferences.some(eRef => eRef.id === ref.id)) { finalReferences.push(ref); } });
            
            displayABNTDocument();
            elements.referenceModal.style.display = 'none';
            log(`‚úÖ ${selectedIndices.length} refer√™ncia(s) adicionada(s)!`, 'success');
        }

        function formatarReferenciasABNT() {
            // Ordena pela primeira letra do sobrenome do primeiro autor
            const sortedReferences = [...finalReferences].sort((a, b) => 
                a.authors[0].split(' ').pop().toUpperCase().localeCompare(b.authors[0].split(' ').pop().toUpperCase())
            );
            
            // A l√≥gica de formata√ß√£o aqui tamb√©m est√° correta para a nova estrutura de dados
            return sortedReferences.map(ref => {
                const authorsFormatted = ref.authors.map(author => {
                    const names = author.split(' ');
                    const lastName = names.pop().toUpperCase();
                    return `${lastName}, ${names.join(' ')}`;
                });
                
                const authorStr = authorsFormatted.length > 3 ? `${authorsFormatted[0]} et al.` : authorsFormatted.join('; ');

                return `${authorStr}. <strong>${ref.title}</strong>. ${ref.year}. Dispon√≠vel em: <${ref.url}>. Acesso em: ${new Date().toLocaleDateString('pt-BR', { day: 'numeric', month: 'short', year: 'numeric' })}.`;
            }).join('<br><br>');
        }
        
        // --- GERA√á√ÉO E EXIBI√á√ÉO DO CONTE√öDO ---
        async function generateResumoAndAbstract() {
            try {
                log('Gerando resumo autom√°tico...', 'info');
                const allContent = Object.values(articleContent).flat().join(' ');
                if (allContent.length < 100) { log('‚ö†Ô∏è Conte√∫do insuficiente para gerar resumo.', 'warning'); return; }
                
                const resumoPrompt = `Baseado no t√≠tulo "${userInputs.titulo}" e conte√∫do "${allContent}", escreva um resumo acad√™mico de 150-200 palavras em portugu√™s (foco, objetivo, m√©todo, resultados, conclus√µes). IMPORTANTE: Escreva APENAS o texto do resumo, sem incluir a palavra "Resumo" no in√≠cio.`;
                userInputs.resumo = await callPuterAI(resumoPrompt);
                
                const palavrasPrompt = `Com base no resumo "${userInputs.resumo}", extraia 5 palavras-chave em portugu√™s. Responda apenas com as palavras separadas por ponto final. N√£o termine a lista com um ponto. Exemplo: Palavra-chave 1. Palavra-chave 2`;
                const rawPalavrasChave = await callPuterAI(palavrasPrompt);
                userInputs.palavrasChave = rawPalavrasChave.trim().replace(/\.$/, '');

                const abstractPrompt = `Traduza para o ingl√™s acad√™mico o seguinte resumo: "${userInputs.resumo}". IMPORTANTE: Escreva APENAS o texto do abstract em ingl√™s, sem incluir a palavra "Abstract" no in√≠cio.`;
                userInputs.abstract = await callPuterAI(abstractPrompt);

                const keywordsPrompt = `Traduza as seguintes palavras-chave do portugu√™s para o ingl√™s. Responda APENAS com as palavras-chave traduzidas, separadas por ponto final, sem texto introdut√≥rio e sem ponto final no fim. Input: "${userInputs.palavrasChave}" Output:`;
                const translatedKeywords = await callPuterAI(keywordsPrompt);
                userInputs.keywords = translatedKeywords.replace(/Output:/i, '').replace(/"/g, '').trim().replace(/\.$/, '');
                
                log('‚úÖ Resumo e abstract gerados!', 'success');
            } catch (error) {
                log('‚ö†Ô∏è Erro ao gerar resumo. Continue o artigo.', 'warning');
            }
        }

        function displayABNTDocument() {
            let content = `
                <div class="nome-universidade">${userInputs.universidade || ''}</div>
                <div class="titulo-trabalho">${userInputs.titulo || ''}</div>
                <div class="autor">${userInputs.autor || ''}<sup>1</sup></div>
            `;
            
            if (userInputs.resumo && userInputs.isFinalized) {
                const cleanResumo = userInputs.resumo.replace(/^\*?\*?Resumo\*?\*?\s*:?\s*/i, '');
                const cleanAbstract = userInputs.abstract ? userInputs.abstract.replace(/^\*?\*?Abstract\*?\*?\s*:?\s*/i, '') : '';
                const cleanPalavrasChave = userInputs.palavrasChave ? userInputs.palavrasChave.replace(/^Palavras-chave:\s*/i, '') : '';
                const cleanKeywords = userInputs.keywords ? userInputs.keywords.replace(/^Keywords:\s*/i, '') : '';
                
                content += `<div class="resumo-titulo">Resumo</div><div class="resumo-texto">${cleanResumo}</div>`;
                if (cleanPalavrasChave) content += `<div class="palavras-chave"><strong>Palavras-chave:</strong> ${cleanPalavrasChave}.</div>`;
                if (cleanAbstract) content += `<div class="abstract-titulo">Abstract</div><div class="resumo-texto">${cleanAbstract}</div>`;
                if (cleanKeywords) content += `<div class="keywords"><strong>Keywords:</strong> ${cleanKeywords}.</div>`;
            }
            
            const sections = [{ name: 'INTRODU√á√ÉO', key: 'introducao' }, { name: 'DESENVOLVIMENTO', key: 'desenvolvimento' }, { name: 'CONCLUS√ÉO', key: 'conclusao' }];
            sections.forEach(section => {
                if (articleContent[section.key].length > 0) {
                    content += `<div class="section-title">${section.name}</div>`;
                    articleContent[section.key].forEach((text, index) => {
                        content += `<p data-id="${section.key}-${index}" title="üí° Clique para adicionar refer√™ncias">${text}</p>`;
                    });
                }
            });
            if (finalReferences.length > 0) {
                content += `<div class="section-title">REFER√äNCIAS</div><div style="text-align: left;">${formatarReferenciasABNT()}</div>`;
            }
            if (userInputs.email && userInputs.universidade) {
                const instituicaoFormatada = userInputs.universidade.replace(/universidade/gi, 'Universidade').replace(/federal/gi, 'Federal').replace(/estadual/gi, 'Estadual').replace(/municipal/gi, 'Municipal');
                const emailFormatado = userInputs.email.toLowerCase();
                content += `<div class="email-autor"><sup>1</sup> ${userInputs.nivelFormacao}, ${instituicaoFormatada}, ${emailFormatado}.</div>`;
            }
            elements.outputDiv.innerHTML = content;
            elements.footerDiv.innerHTML = `${userInputs.universidade || 'Institui√ß√£o'}, jun. 2025`;
            
            setTimeout(updatePageCount, 100);
        }
        
        // --- EVENTOS E CONTROLE DO FLUXO PRINCIPAL ---
        async function proceedWithArticleGeneration() {
            document.getElementById('initial-form').style.display = 'none';
            document.getElementById('interactive-controls').style.display = 'block';
            elements.currentSectionNameSpan.textContent = 'Introdu√ß√£o';
            sessionActive = false;
            log('‚úÖ Configura√ß√£o conclu√≠da! Clique em IN√çCIO para come√ßar a escrever.', 'success');
        }

        elements.startBtn.addEventListener('click', async () => {
            userInputs = {
                universidade: document.getElementById('universidade').value,
                titulo: document.getElementById('titulo').value,
                autor: document.getElementById('autor').value,
                email: document.getElementById('email').value,
                nivelFormacao: document.getElementById('nivel-formacao').value
            };
            
            if (!userInputs.titulo || !userInputs.autor) { 
                log('‚ùå Preencha t√≠tulo e autor.', 'error'); 
                return; 
            }
            
            elements.startBtn.disabled = true;
            
            try {
                const topicData = await refineAndSuggestTopics(userInputs.titulo);
                if (topicData && topicData.suggestions && topicData.suggestions.length > 0) {
                    populateAndShowTopicModal(topicData, userInputs.titulo);
                } else {
                    await proceedWithArticleGeneration();
                }
            } catch (error) {
                await proceedWithArticleGeneration();
            }
        });

        elements.confirmTopicBtn.addEventListener('click', () => {
            const selectedTopic = document.querySelector('input[name="topic-choice"]:checked').value;
            userInputs.titulo = selectedTopic;
            document.getElementById('titulo').value = selectedTopic;
            elements.topicSuggestionModal.style.display = 'none';
            log(`‚úÖ Tema selecionado: "${selectedTopic}"`, 'success');
            proceedWithArticleGeneration();
        });
        
        async function rewriteLastParagraph() {
            if (lastParagraphIndex === -1) {
                alert('Nenhum par√°grafo para reescrever.');
                return;
            }
            
            elements.rewriteBtn.disabled = true;
            
            try {
                const lastContent = articleContent[currentSection][lastParagraphIndex];
                const lastPhrases = extractKeyPhrases(lastContent);
                lastPhrases.forEach(phrase => usedPhrases.delete(phrase));
                
                const currentPhase = sectionOrder.indexOf(currentSection) === 0 ? 'inicio' :
                                     sectionOrder.indexOf(currentSection) === 1 ? 'meio' : 'fim';

                const prompt = createAntiRepetitionPrompt(currentPhase);
                const newContent = await callPuterAI(prompt);
                
                addPhrasesToMemory(newContent);
                articleContent[currentSection][lastParagraphIndex] = newContent;
                displayABNTDocument();
                
                log('‚úÖ Par√°grafo reescrito com sucesso!', 'success');
            } catch (error) {
                log('‚ùå Erro ao reescrever par√°grafo', 'error');
            } finally {
                elements.rewriteBtn.disabled = false;
            }
        }

        elements.inicioBtn.addEventListener('click', () => triggerParagraphOptions('inicio'));
        elements.meioBtn.addEventListener('click', () => triggerParagraphOptions('meio'));
        elements.fimBtn.addEventListener('click', () => triggerParagraphOptions('fim'));
        elements.rewriteBtn.addEventListener('click', rewriteLastParagraph);

        function createCustomStartPrompt(startPhrase) {
            const allContent = Object.values(articleContent).flat().join(' ');
            const usedConcepts = extractUsedConcepts(allContent);
            
            return `
ESCREVA um par√°grafo acad√™mico para o artigo "${userInputs.titulo}".

INSTRU√á√ÉO ESPEC√çFICA:
- INICIE OBRIGATORIAMENTE com: "${startPhrase}"
- Continue desenvolvendo a ideia de forma natural e acad√™mica
- Complete o par√°grafo com 80-120 palavras totais
- Use linguagem formal e cient√≠fica

CONTE√öDO J√Å ESCRITO: "${allContent}"

EVITE REPETIR CONCEITOS: ${usedConcepts.slice(0, 15).join(', ')}

REGRAS:
1. O par√°grafo DEVE come√ßar exatamente com "${startPhrase}"
2. Desenvolva uma ideia ORIGINAL sobre o tema
3. Mantenha coer√™ncia com o artigo
4. N√£o repita conceitos j√° utilizados

ESCREVA o par√°grafo completo:`;
        }

        elements.generateParagraphBtn.addEventListener('click', async () => {
            if (!selectedParagraphStart) return;
            
            elements.paragraphStartModal.style.display = 'none';
            const allButtons = [elements.inicioBtn, elements.meioBtn, elements.fimBtn];
            allButtons.forEach(btn => btn.disabled = true);
            
            try {
                const prompt = createCustomStartPrompt(selectedParagraphStart);
                const content = await callPuterAI(prompt);
                
                addPhrasesToMemory(content);
                articleContent[currentSection].push(content);
                lastParagraphIndex = articleContent[currentSection].length - 1;
                displayABNTDocument();
                elements.rewriteBtn.style.display = 'block';
                
                log(`‚úÖ Par√°grafo para '${currentGenerationPhase}' criado!`, 'success');

                if (currentGenerationPhase === 'inicio') {
                    sessionActive = true;
                    elements.inicioBtn.disabled = true;
                    elements.meioBtn.disabled = false;
                    elements.fimBtn.disabled = false;
                } else if (currentGenerationPhase === 'fim') {
                    sessionActive = false;
                    elements.inicioBtn.disabled = false;
                    elements.meioBtn.disabled = true;
                    elements.fimBtn.disabled = true;
                    
                    const currentIndex = sectionOrder.indexOf(currentSection);
                    if (currentIndex < sectionOrder.length - 1) {
                        currentSection = sectionOrder[currentIndex + 1];
                        const sectionDisplayName = { 'desenvolvimento': 'Desenvolvimento', 'conclusao': 'Conclus√£o' }[currentSection];
                        elements.currentSectionNameSpan.textContent = sectionDisplayName;
                        log(`üìù Pronto para iniciar: ${sectionDisplayName}`, 'info');
                    } else {
                        await generateResumoAndAbstract();
                        userInputs.isFinalized = true;
                        displayABNTDocument();
                        alert(`üéâ Artigo finalizado! Agora voc√™ pode salv√°-lo como PDF.`);
                        log(`üéì Artigo conclu√≠do!`, 'success');
                    }
                } else { // 'meio'
                    elements.inicioBtn.disabled = true;
                    elements.meioBtn.disabled = false;
                    elements.fimBtn.disabled = false;
                }
                
            } catch (error) {
                log(`‚ùå Erro ao gerar par√°grafo`, 'error');
                if (sessionActive) {
                    elements.inicioBtn.disabled = true;
                    elements.meioBtn.disabled = false;
                    elements.fimBtn.disabled = false;
                } else {
                    elements.inicioBtn.disabled = false;
                    elements.meioBtn.disabled = true;
                    elements.fimBtn.disabled = true;
                }
            } finally {
                selectedParagraphStart = '';
                elements.generateParagraphBtn.disabled = true;
            }
        });

        elements.closeParagraphModalBtn.addEventListener('click', () => {
            elements.paragraphStartModal.style.display = 'none';
            selectedParagraphStart = '';
            elements.generateParagraphBtn.disabled = true;
        });

        elements.paragraphStartModal.addEventListener('click', (e) => {
            if (e.target === elements.paragraphStartModal) {
                elements.paragraphStartModal.style.display = 'none';
                selectedParagraphStart = '';
                elements.generateParagraphBtn.disabled = true;
            }
        });

        elements.outputDiv.addEventListener('click', (e) => {
            const paragraph = e.target.closest('p[data-id]');
            if (paragraph) {
                const paragraphId = paragraph.dataset.id;
                const paragraphText = paragraph.textContent.replace(/\s*\([A-Z√Ä-√ô\s;,\d\-]+\)\s*\.?$/g, '').trim();
                if (userInputs.titulo) {
                    openReferenceModal(paragraphId, paragraphText, userInputs.titulo);
                } else {
                    alert('Erro: T√≠tulo do artigo n√£o encontrado. Reinicie o processo.');
                }
            }
        });
        
        elements.addReferencesBtn.addEventListener('click', addSelectedReferences);
        elements.closeModalBtn.addEventListener('click', () => { elements.referenceModal.style.display = 'none'; });
        elements.referenceModal.addEventListener('click', (e) => { if (e.target === elements.referenceModal) { elements.referenceModal.style.display = 'none'; } });

        elements.savePdfBtn.addEventListener('click', () => {
            alert('A caixa de di√°logo de impress√£o ser√° aberta.\n\n**COMO SALVAR EM PDF:**\n\n1. No campo "Destino", ESCOLHA "Salvar como PDF".\n2. Verifique as configura√ß√µes (como remover cabe√ßalhos/rodap√©s).\n3. Clique em "Salvar".');
            window.print();
        });

        // --- INICIALIZA√á√ÉO ---
        elements.meioBtn.disabled = true;
        elements.fimBtn.disabled = true;
        log('üéØ Preencha os dados e clique em "Iniciar"', 'info');
    </script>
</body>
</html>
