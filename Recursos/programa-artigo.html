<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gerador de Artigo Científico com IA do Puter</title>
    <!-- A única biblioteca necessária para a funcionalidade do Puter -->
    <script src="https://js.puter.com/v2/"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Arial&display=swap');
        
        /* Estilos Gerais */
        body { 
            background-color: #e0e0e0; 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            margin: 0;
        }
        .main-container { 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            gap: 20px; 
            flex-wrap: wrap; 
        }

        /* Painel de Controle (Lateral) */
        .control-panel { 
            position: sticky; 
            top: 20px; 
            width: 400px; 
            background: #f9f9f9; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); 
            z-index: 10;
            max-height: 95vh;
            overflow-y: auto;
        }
        .control-panel h2 { 
            margin-top: 0; 
            text-align: center; 
            color: #333; 
        }
        .form-group { 
            margin-bottom: 15px; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold; 
        }
        .form-group input, .form-group button { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-sizing: border-box; 
            font-size: 14px; 
        }
        .control-panel button { 
            background-color: #1a73e8; 
            color: white; 
            font-weight: bold; 
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .control-panel button:hover:not(:disabled) { 
            background-color: #1765cc; 
        }
        .control-panel button:disabled { 
            background-color: #999; 
            cursor: not-allowed; 
        }
        
        /* Controles Interativos */
        #interactive-controls { display: none; }
        #interactive-controls button { margin-top: 10px; }
        #continueBtn { background-color: #28a745; }
        #continueBtn:hover:not(:disabled) { background-color: #218838; }
        #concludeBtn { background-color: #fd7e14; }
        #concludeBtn:hover:not(:disabled) { background-color: #e8681b; }
        #finalizeBtn { background-color: #ffc107; color: black; }
        #finalizeBtn:hover:not(:disabled) { background-color: #e0a800; }
        #finishBtn { background-color: #dc3545; display: none; }
        #finishBtn:hover:not(:disabled) { background-color: #c82333; }
        
        /* Status e Feedback */
        #status { 
            font-weight: bold; 
            text-align: left; 
            margin-top: 15px; 
            padding: 12px; 
            border-radius: 4px; 
            border: 1px solid transparent;
            font-size: 14px;
        }
        .success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb; }

        /* Container da Página A4 */
        .page-container { 
            width: 21cm; 
            min-height: 29.7cm; 
            padding: 3cm 2cm 2cm 3cm; 
            background: white; 
            box-shadow: 0 0 10px rgba(0,0,0,0.5); 
            box-sizing: border-box; 
        }
        #footer { 
            position: running(footer); 
            font-family: Arial, sans-serif; 
            font-size: 10pt; 
            text-align: center; 
            width: 100%; 
            display: none; /* Só visível na impressão */
        }
        
        /* Estilos ABNT para Conteúdo */
        .abnt-content { 
            font-family: 'Arial', sans-serif; 
            font-size: 12pt; 
            line-height: 1.5; 
            text-align: justify; 
            color: #000;
        }
        .nome-universidade { text-align: center; font-size: 12pt; font-weight: bold; margin-bottom: 2em; }
        .titulo-trabalho { font-size: 14pt; text-align: center; font-weight: bold; text-transform: none; margin-bottom: 2em; }
        .autor { text-align: center; font-size: 12pt; margin-bottom: 1em; }
        .autor sup { font-size: 10pt; }
        .email-autor { text-align: left; font-size: 10pt; margin-top: 2em; border-top: 1px solid #000; padding-top: 10px; }
        .resumo-titulo { font-weight: bold; text-align: left; font-size: 12pt; margin-top: 2em; margin-bottom: 1em; }
        .resumo-texto { text-align: justify; margin-bottom: 1em; }
        .palavras-chave { text-align: left; margin-bottom: 2em; }
        .palavras-chave strong { font-weight: bold; }
        .abstract-titulo { font-weight: bold; font-style: italic; text-align: left; font-size: 12pt; margin-top: 1em; margin-bottom: 1em; }
        .keywords { text-align: left; margin-bottom: 2em; }
        .keywords strong { font-weight: bold; font-style: italic; }
        .section-title { font-weight: bold; text-transform: uppercase; text-align: left; font-size: 12pt; margin-top: 2em; margin-bottom: 1em; }
        .abnt-content p { 
            margin-bottom: 1.5em; 
            cursor: pointer; 
            text-indent: 1.25cm; 
            line-height: 1.5; 
            text-align: justify; 
            transition: background-color 0.2s;
        }
        .abnt-content p:hover { 
            background-color: #f0f8ff; 
        }
        
        /* Modais */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .modal-header h2 { margin: 0; }
        .close-btn {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-btn:hover, .close-btn:focus { color: black; }

        #reference-list { list-style-type: none; padding: 0; max-height: 40vh; overflow-y: auto; }
        #reference-list li {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        #reference-list li:hover { background-color: #f1f1f1; }
        #reference-list label { display: block; cursor: pointer; }
        .modal-footer { margin-top: 20px; text-align: right; }
        .modal-footer button {
             padding: 10px 20px;
             border: none;
             border-radius: 5px;
             cursor: pointer;
        }
        #add-references-btn { background-color: #28a745; color: white; }
        
        /* Estilos de Impressão */
        @page {
            size: A4;
            margin: 3cm 2cm 2cm 3cm;
            @bottom-center {
                content: element(footer);
                font-family: Arial, sans-serif;
                font-size: 10pt;
                color: #000;
            }
        }
        @media print {
            body { background-color: #fff; padding: 0; margin: 0; }
            .control-panel, .modal, #save-controls { display: none !important; }
            .main-container { display: block; }
            .page-container { 
                box-shadow: none; 
                margin: 0; 
                padding: 0; 
                width: 100%; 
                min-height: auto; 
                border: none; 
            }
            .email-autor { display: none !important; }
            .abnt-content p:hover { background-color: transparent; }
            #footer { display: block; }
        }

        /* --- AJUSTES DE RESPONSIVIDADE --- */
        @media (max-width: 1280px) {
            .main-container {
                /* Altera o layout de 'lado a lado' para 'um em cima do outro' */
                flex-direction: column;
                align-items: center; /* Centraliza os itens na vertical */
                gap: 30px; /* Aumenta o espaço entre o painel e a folha */
            }

            .control-panel {
                /* Remove a posição fixa para que ele role com a página */
                position: relative;
                top: 0;
                width: 90%; /* Ocupa a maior parte da largura da tela */
                max-width: 700px; /* Mas não fica excessivamente largo */
                order: 1; /* Garante que o painel venha primeiro */
            }

            .page-container {
                order: 2; /* Garante que a página venha depois do painel */
            }
        }
    </style>
</head>
<body>

    <div class="main-container">
        <!-- PAINEL DE CONTROLE LATERAL -->
        <div class="control-panel">
            <h2>Gerador de Artigo</h2>
            
            <div id="initial-form">
                <div class="form-group">
                    <label for="universidade">Nome da Universidade</label>
                    <input type="text" id="universidade" value="Universidade Federal Exemplo (UFE)">
                </div>
                <div class="form-group">
                    <label for="titulo">Título do Artigo</label>
                    <input type="text" id="titulo" placeholder="Ex: O Impacto da IA na Educação Superior" required>
                </div>
                <div class="form-group">
                    <label for="autor">Autor(a)</label>
                    <input type="text" id="autor" placeholder="Seu Nome Completo" required>
                </div>
                <div class="form-group">
                    <label for="email">E-mail do Autor</label>
                    <input type="email" id="email" placeholder="seu.email@dominio.com">
                </div>
                <button id="startBtn">1. Iniciar Artigo</button>
            </div>

            <div id="interactive-controls">
                <h3>Seção Atual: <span id="current-section-name">Introdução</span></h3>
                <button id="continueBtn">2. Continuar Seção</button>
                <button id="concludeBtn">3. Concluir Seção</button>
                <button id="finalizeBtn">4. Próxima Seção / Finalizar</button>
                <button id="finishBtn">🎉 Artigo Concluído</button>
            </div>
            
            <div id="save-controls" style="margin-top: 20px; border-top: 1px solid #ccc; padding-top: 15px;">
                 <button id="savePdfBtn" style="background-color: #6f42c1;">Salvar como PDF</button>
            </div>

            <div id="status" class="info"></div>
        </div>

        <!-- CONTAINER DO DOCUMENTO -->
        <div class="page-container">
            <div id="content-output" class="abnt-content">
                <!-- O conteúdo do artigo será inserido aqui -->
            </div>
            <div id="footer"></div>
        </div>
    </div>

    <!-- MODAL DE SUGESTÃO DE TEMAS -->
    <div id="topic-suggestion-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Sugestões de Tema</h2>
            </div>
            <div id="topic-list"></div>
            <div class="modal-footer">
                <button id="confirm-topic-btn" style="background-color:#1a73e8; color:white;">Confirmar Tema e Iniciar</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE REFERÊNCIAS -->
    <div id="reference-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Adicionar Referências</h2>
                <span id="close-modal-btn" class="close-btn">×</span>
            </div>
            <div id="search-info" style="font-size: 12px; margin-bottom: 10px; padding: 5px; background: #f0f0f0; border-radius: 4px; display:none;"></div>
            <div id="duplicate-warning" style="font-size: 12px; margin-bottom: 10px; color: #856404; background-color: #fff3cd; padding: 8px; border-radius: 4px; display: none;"></div>
            <ul id="reference-list"></ul>
            <div class="modal-footer">
                <button id="add-references-btn" disabled>Adicionar Selecionadas</button>
            </div>
        </div>
    </div>

<script>
// O SCRIPT JAVASCRIPT CONTINUA IGUAL AO ANTERIOR, SEM MUDANÇAS NECESSÁRIAS
// --- ELEMENTOS DA UI ---
const elements = {
    startBtn: document.getElementById('startBtn'),
    continueBtn: document.getElementById('continueBtn'),
    concludeBtn: document.getElementById('concludeBtn'),
    finalizeBtn: document.getElementById('finalizeBtn'),
    finishBtn: document.getElementById('finishBtn'),
    outputDiv: document.getElementById('content-output'),
    statusDiv: document.getElementById('status'),
    currentSectionNameSpan: document.getElementById('current-section-name'),
    referenceModal: document.getElementById('reference-modal'),
    referenceList: document.getElementById('reference-list'),
    addReferencesBtn: document.getElementById('add-references-btn'),
    closeModalBtn: document.getElementById('close-modal-btn'),
    searchInfoDiv: document.getElementById('search-info'),
    duplicateWarningDiv: document.getElementById('duplicate-warning'),
    savePdfBtn: document.getElementById('savePdfBtn'),
    footerDiv: document.getElementById('footer'),
    topicSuggestionModal: document.getElementById('topic-suggestion-modal'),
    topicListDiv: document.getElementById('topic-list'),
    confirmTopicBtn: document.getElementById('confirm-topic-btn'),
};

// --- ESTADO DA APLICAÇÃO ---
let userInputs = {};
let articleContent = { introducao: [], desenvolvimento: [], conclusao: [] };
let finalReferences = []; 
let currentParagraphId = null;
let currentSection = 'introducao';
const sectionOrder = ['introducao', 'desenvolvimento', 'conclusao'];
let currentModalReferences = [];

// --- FUNÇÃO DE GERAÇÃO COM PUTER AI ---
async function callPuterAI(prompt) {
    try {
        log('🤖 Gerando conteúdo com a IA do Puter...', 'info');
        const response = await puter.ai.chat([{ role: 'user', content: prompt }]);
        
        if (!response || !response.message || !response.message.content) {
            throw new Error('Resposta inválida da IA do Puter.');
        }
        
        return response.message.content.trim();
    } catch (error) {
        console.error('Erro na IA do Puter:', error);
        if (error.message && error.message.toLowerCase().includes('user cancelled')) {
            log('⚠️ Autenticação cancelada. Não é possível gerar conteúdo.', 'warning');
        } else {
            log(`❌ Erro ao gerar conteúdo: ${error.message || 'Erro desconhecido.'}`, 'error');
        }
        throw error; // Re-lança o erro para que a função que chamou saiba que falhou
    }
}

// --- FUNÇÕES AUXILIARES DE FEEDBACK ---
function log(message, type = 'info') {
    elements.statusDiv.className = `status ${type}`;
    const icons = { success: '✅', error: '❌', warning: '⚠️', info: 'ℹ️' };
    elements.statusDiv.innerHTML = `<div>${icons[type] || 'ℹ️'} ${message}</div><div style="font-size: 10px; margin-top: 5px; opacity: 0.7;">${new Date().toLocaleTimeString()}</div>`;
}

// --- LÓGICA DE CORREÇÃO E SUGESTÃO DE TEMAS ---
async function refineAndSuggestTopics(originalTitle) {
    log('Analisando tema e gerando sugestões...', 'info');
    const prompt = `
        Analise o tema para um artigo científico: "${originalTitle}".
        1.  Corrija possíveis erros de gramática/digitação e reformule-o para ser um título acadêmico claro e impactante. Este será o "tema corrigido".
        2.  Gere 4 temas alternativos e criativos, baseados na ideia principal do tema original.
        Retorne sua resposta ESTRITAMENTE no formato JSON, sem nenhum texto adicional antes ou depois.
        O formato deve ser: {"corrected_title": "string", "suggestions": ["string", "string", ...]}
    `;
    try {
        const response = await callPuterAI(prompt);
        // Garante que apenas o JSON seja processado, mesmo que a IA adicione texto extra
        const jsonString = response.substring(response.indexOf('{'), response.lastIndexOf('}') + 1);
        return JSON.parse(jsonString);
    } catch (error) {
        console.error('Erro ao processar sugestões de temas:', error);
        log('⚠️ Não foi possível gerar sugestões. Usando o tema original.', 'warning');
        return { corrected_title: originalTitle, suggestions: [] };
    }
}

function populateAndShowTopicModal(topicData, originalTitle) {
    let html = `
        <p style="margin-bottom:15px; background-color:#e8f4f8; padding:10px; border-radius:4px;">
            <strong>Seu Tema Original:</strong> <em>${originalTitle}</em>
        </p>
        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
            <div style="margin-bottom:10px;">
                <input type="radio" id="topic-0" name="topic-choice" value="${topicData.corrected_title}" checked>
                <label for="topic-0" style="font-weight:bold;">${topicData.corrected_title} (Sugestão Corrigida)</label>
            </div>
    `;
    topicData.suggestions.forEach((suggestion, index) => {
        html += `
            <div style="margin-bottom:10px;">
                <input type="radio" id="topic-${index + 1}" name="topic-choice" value="${suggestion}">
                <label for="topic-${index + 1}">${suggestion}</label>
            </div>
        `;
    });
    html += '</div>';
    elements.topicListDiv.innerHTML = html;
    elements.topicSuggestionModal.style.display = 'flex';
}

// --- LÓGICA DE REFERÊNCIAS ---
function extractRelevantTerms(text, title = '') {
    const stopwords = new Set(['a', 'o', 'as', 'os', 'de', 'da', 'do', 'e', 'em', 'para', 'com', 'um', 'uma', 'que', 'se', 'por', 'mais', 'como', 'são', 'ser', 'foi', 'artigo', 'trabalho', 'estudo', 'pesquisa', 'análise', 'sobre', 'neste']);
    const combinedText = `${title} ${text}`.toLowerCase();
    const cleanText = combinedText.replace(/[^\w\sáéíóúâêîôûàèìòùãõç]/g, ' ');
    const words = cleanText.split(/\s+/).filter(word => word.length > 3 && !stopwords.has(word));
    const wordCounts = words.reduce((acc, word) => { acc[word] = (acc[word] || 0) + 1; return acc; }, {});
    return Object.entries(wordCounts).sort(([,a], [,b]) => b - a).slice(0, 5).map(([word]) => word);
}

async function fetchParagraphReferences(paragraphText, articleTitle) {
    log('Buscando referências acadêmicas...', 'info');
    try {
        const relevantTerms = extractRelevantTerms(paragraphText, articleTitle);
        if (relevantTerms.length === 0) {
            log('⚠️ Não foi possível extrair termos para busca.', 'warning');
            return [];
        }
        const query = relevantTerms.join(' ');
        elements.searchInfoDiv.innerHTML = `<strong>🔍 Buscando por:</strong> <em>${query}</em>`;
        elements.searchInfoDiv.style.display = 'block';
        
        const url = `https://api.semanticscholar.org/graph/v1/paper/search?query=${encodeURIComponent(query)}&limit=10&fields=title,authors,year,abstract,url`;
        // Adicionado um timeout para evitar que a aplicação trave em caso de API lenta
        const response = await fetch(url, { signal: AbortSignal.timeout(10000) });
        if (!response.ok) throw new Error(`API retornou status ${response.status}`);
        
        const data = await response.json();
        const papers = (data.data || []).filter(p => p.title && p.authors && p.authors.length > 0 && p.year);
        log(`${papers.length > 0 ? '✅' : 'ℹ️'} ${papers.length} referências encontradas!`, 'success');
        
        return papers.map(p => ({
            id: p.paperId,
            title: p.title,
            authors: p.authors.map(a => a.name),
            year: p.year,
            abstract: p.abstract || '',
            url: p.url
        }));
    } catch (error) {
        console.error('Erro ao buscar referências:', error);
        log('❌ Erro na busca de referências. Verifique a conexão ou tente novamente.', 'error');
        return [];
    }
}

async function openReferenceModal(paragraphId, paragraphText, articleTitle) {
    currentParagraphId = paragraphId;
    elements.referenceList.innerHTML = '<p>🔍 Buscando referências...</p>';
    elements.addReferencesBtn.disabled = true;
    elements.referenceModal.style.display = 'flex';
    
    const references = await fetchParagraphReferences(paragraphText, articleTitle);
    currentModalReferences = references;
    
    if (references.length === 0) {
        elements.referenceList.innerHTML = `<div style="text-align:center; padding: 20px;"><strong>Nenhuma referência encontrada para este parágrafo.</strong></div>`;
        return;
    }
    
    elements.duplicateWarningDiv.style.display = references.some(ref => finalReferences.some(eRef => eRef.id === ref.id)) ? 'block' : 'none';
    elements.duplicateWarningDiv.innerHTML = `⚠️ Algumas referências sugeridas já foram usadas no artigo.`;

    elements.referenceList.innerHTML = references.map((ref, index) => {
        const isUsed = finalReferences.some(eRef => eRef.id === ref.id);
        return `<li style="${isUsed ? 'background-color:#f8f9fa; opacity: 0.7;':''}">
                    <label>
                        <input type="checkbox" id="ref-${index}" value="${index}">
                        <strong>${ref.authors[0]}${ref.authors.length > 1 ? ' et al.' : ''} (${ref.year})</strong>
                        ${isUsed ? '<span style="color:#6c757d; font-weight:bold;"> [JÁ USADA]</span>':''}
                        <br><em>${ref.title}</em>
                        <br><small style="color:#666;">${ref.abstract ? ref.abstract.substring(0, 120) + '...' : 'Sem resumo disponível'}</small>
                    </label>
                </li>`;
    }).join('');
    elements.addReferencesBtn.disabled = false;
}

function addSelectedReferences() {
    const selectedIndices = Array.from(document.querySelectorAll('#reference-list input:checked')).map(input => parseInt(input.value));
    if (selectedIndices.length === 0) {
        alert('Selecione ao menos uma referência para adicionar.');
        return;
    }
    
    const paragraphElement = document.querySelector(`p[data-id="${currentParagraphId}"]`);
    const [sectionKey, indexStr] = currentParagraphId.split('-');
    const originalText = articleContent[sectionKey][parseInt(indexStr)];
    
    const selectedRefs = selectedIndices.map(index => currentModalReferences[index]);
    
    const citations = selectedRefs.map(ref => {
        const lastName = ref.authors[0].split(' ').pop().toUpperCase();
        return ref.authors.length > 1 ? `${lastName} et al., ${ref.year}` : `${ref.authors.map(a => a.split(' ').pop().toUpperCase()).join('; ')}, ${ref.year}`;
    });
    
    // Remove citações antigas para evitar duplicação antes de adicionar a nova
    const cleanText = originalText.replace(/\s*\([A-ZÀ-Ù\s;,\d\-\.]+\)\.?$/g, '').trim();
    const newText = `${cleanText} (${citations.join('; ')}).`;
    
    articleContent[sectionKey][parseInt(indexStr)] = newText;
    
    // Adiciona as referências à lista final, sem duplicatas
    selectedRefs.forEach(ref => {
        if (!finalReferences.some(existingRef => existingRef.id === ref.id)) {
            finalReferences.push(ref);
        }
    });
    
    displayABNTDocument();
    elements.referenceModal.style.display = 'none';
    log(`✅ ${selectedIndices.length} referência(s) adicionada(s) ao parágrafo!`, 'success');
}

function formatarReferenciasABNT() {
    const sortedReferences = [...finalReferences].sort((a, b) => 
        a.authors[0].split(' ').pop().toUpperCase().localeCompare(b.authors[0].split(' ').pop().toUpperCase())
    );
    
    return sortedReferences.map(ref => {
        const authors = ref.authors.map(author => {
            const names = author.split(' ');
            const lastName = names.pop().toUpperCase();
            const initials = names.map(n => n.charAt(0).toUpperCase() + '.').join(' ');
            return `${lastName}, ${initials}`;
        });
        const authorStr = authors.length > 3 ? `${authors[0]} et al.` : authors.join('; ');
        
        return `${authorStr}. <strong>${ref.title}</strong>. ${ref.year}. Disponível em: <${ref.url}>. Acesso em: ${new Date().toLocaleDateString('pt-BR')}.`;
    }).join('<br><br>');
}


// --- GERAÇÃO E EXIBIÇÃO DO CONTEÚDO ---
async function generateResumoAndAbstract() {
    try {
        log('Gerando resumo e abstract...', 'info');
        const allContent = Object.values(articleContent).flat().join(' ');
        if (allContent.length < 100) {
            log('⚠️ Conteúdo insuficiente para gerar resumo.', 'warning');
            return;
        }

        const resumoPrompt = `Com base no título "${userInputs.titulo}" e no conteúdo a seguir: "${allContent.substring(0, 3000)}", escreva um resumo acadêmico em parágrafo único, contendo entre 150 e 250 palavras em português. O resumo deve seguir a estrutura: contextualização, objetivo, metodologia, resultados e conclusão.`;
        userInputs.resumo = await callPuterAI(resumoPrompt);

        const palavrasPrompt = `Com base no resumo a seguir: "${userInputs.resumo}", extraia exatamente 5 palavras-chave pertinentes em português. Responda apenas com as palavras-chave separadas por ponto final. Exemplo: Palavra 1. Palavra 2. Palavra 3. Palavra 4. Palavra 5`;
        userInputs.palavrasChave = (await callPuterAI(palavrasPrompt)).replace(/\.$/, '');

        const abstractPrompt = `Traduza o seguinte resumo para o inglês acadêmico, mantendo o tom formal: "${userInputs.resumo}"`;
        userInputs.abstract = await callPuterAI(abstractPrompt);

        const keywordsPrompt = `Traduza as seguintes palavras-chave para o inglês: "${userInputs.palavrasChave}". Responda apenas com as palavras traduzidas, separadas por ponto final.`;
        userInputs.keywords = (await callPuterAI(keywordsPrompt)).replace(/\.$/, '');

        log('✅ Resumo, abstract e palavras-chave gerados!', 'success');
    } catch (error) {
        log('❌ Erro ao gerar resumo e abstract.', 'error');
    }
}

function displayABNTDocument() {
    let content = `
        <div class="nome-universidade">${userInputs.universidade || ''}</div>
        <div class="titulo-trabalho">${userInputs.titulo || ''}</div>
        <div class="autor">${userInputs.autor || ''}<sup>1</sup></div>
    `;
    
    if (userInputs.resumo) {
        content += `<div class="resumo-titulo">Resumo</div><div class="resumo-texto">${userInputs.resumo}</div>`;
        if (userInputs.palavrasChave) content += `<div class="palavras-chave"><strong>Palavras-chave:</strong> ${userInputs.palavrasChave}.</div>`;
        if (userInputs.abstract) content += `<div class="abstract-titulo">Abstract</div><div class="resumo-texto">${userInputs.abstract}</div>`;
        if (userInputs.keywords) content += `<div class="keywords"><strong>Keywords:</strong> ${userInputs.keywords}.</div>`;
    }
    
    const sections = [
        { name: '1 INTRODUÇÃO', key: 'introducao' },
        { name: '2 DESENVOLVIMENTO', key: 'desenvolvimento' },
        { name: '3 CONCLUSÃO', key: 'conclusao' }
    ];

    sections.forEach(section => {
        if (articleContent[section.key].length > 0) {
            content += `<div class="section-title">${section.name}</div>`;
            articleContent[section.key].forEach((text, index) => {
                content += `<p data-id="${section.key}-${index}" title="💡 Clique para adicionar/editar referências">${text}</p>`;
            });
        }
    });
    
    if (finalReferences.length > 0) {
        content += `<div class="section-title">REFERÊNCIAS</div><div style="text-align: left; font-size: 12pt; line-height: 1.5;">${formatarReferenciasABNT()}</div>`;
    }
    
    if (userInputs.email) {
        content += `<div class="email-autor"><sup>1</sup> ${userInputs.universidade || ''}, E-mail: ${userInputs.email}</div>`;
    }
    
    elements.outputDiv.innerHTML = content;
    elements.footerDiv.innerHTML = `${userInputs.autor}, ${new Date().getFullYear()}`;
}

// --- EVENTOS E CONTROLE DO FLUXO PRINCIPAL ---
async function proceedWithArticleGeneration() {
    try {
        const prompt = `Escreva o parágrafo inicial para a introdução de um artigo científico com o título "${userInputs.titulo}". O parágrafo deve contextualizar o tema, apresentar sua relevância e indicar o problema de pesquisa. Deve ter entre 100 e 150 palavras e usar linguagem formal. Não inclua citações.`;
        const content = await callPuterAI(prompt);
        
        articleContent.introducao.push(content);
        displayABNTDocument();
        
        document.getElementById('initial-form').style.display = 'none';
        document.getElementById('interactive-controls').style.display = 'block';
        elements.currentSectionNameSpan.textContent = 'Introdução';
        log('✅ Artigo iniciado com sucesso! Continue a introdução.', 'success');
    } catch (error) {
        elements.startBtn.disabled = false; // Reabilita o botão se a geração falhar
    }
}

elements.startBtn.addEventListener('click', async () => {
    userInputs = {
        universidade: document.getElementById('universidade').value,
        titulo: document.getElementById('titulo').value,
        autor: document.getElementById('autor').value,
        email: document.getElementById('email').value
    };
    if (!userInputs.titulo || !userInputs.autor) {
        log('❌ Preencha pelo menos o Título do Artigo e o Autor.', 'error');
        return;
    }
    elements.startBtn.disabled = true;
    
    try {
        const topicData = await refineAndSuggestTopics(userInputs.titulo);
        if (topicData.suggestions && topicData.suggestions.length > 0) {
            populateAndShowTopicModal(topicData, userInputs.titulo);
        } else {
            await proceedWithArticleGeneration(); // Procede mesmo se a sugestão falhar
        }
    } catch (error) {
        await proceedWithArticleGeneration(); // Garante que o app continue
    }
});

elements.confirmTopicBtn.addEventListener('click', () => {
    const selectedTopic = document.querySelector('input[name="topic-choice"]:checked').value;
    userInputs.titulo = selectedTopic;
    document.getElementById('titulo').value = selectedTopic;
    elements.topicSuggestionModal.style.display = 'none';
    log(`✅ Tema selecionado: "${selectedTopic}"`, 'success');
    proceedWithArticleGeneration();
});

async function handleSectionGeneration(type) {
    const btn = type === 'continue' ? elements.continueBtn : elements.concludeBtn;
    btn.disabled = true;
    
    const sectionName = { 'introducao': 'introdução', 'desenvolvimento': 'desenvolvimento', 'conclusao': 'conclusão' }[currentSection];
    const fullArticleText = Object.values(articleContent).flat().join(' ');
    
    let actionText = type === 'continue' 
        ? `desenvolver a seção de "${sectionName}", adicionando novas informações, argumentos ou exemplos`
        : `escrever um parágrafo de conclusão para a seção de "${sectionName}", sintetizando os pontos abordados nela e criando uma transição para a próxima seção`;
    
    const prompt = `Continuando a redação de um artigo sobre "${userInputs.titulo}". O conteúdo já escrito é: "${fullArticleText.substring(0, 3000)}". Sua tarefa é ${actionText}. O novo parágrafo deve ser coeso, ter entre 100 e 150 palavras, e não repetir ideias já ditas.`;
    
    try {
        const content = await callPuterAI(prompt);
        articleContent[currentSection].push(content);
        displayABNTDocument();
        log(`✅ Parágrafo de ${type === 'continue' ? 'continuação' : 'conclusão'} adicionado!`, 'success');
    } catch (error) {
        // O erro já é logado dentro de callPuterAI
    } finally {
        btn.disabled = false;
    }
}

elements.continueBtn.addEventListener('click', () => handleSectionGeneration('continue'));
elements.concludeBtn.addEventListener('click', () => handleSectionGeneration('conclude'));

elements.finalizeBtn.addEventListener('click', async () => {
    const currentIndex = sectionOrder.indexOf(currentSection);
    if (currentIndex < sectionOrder.length - 1) {
        // Avança para a próxima seção
        currentSection = sectionOrder[currentIndex + 1];
        const sectionDisplayName = { 'desenvolvimento': 'Desenvolvimento', 'conclusao': 'Conclusão' }[currentSection];
        elements.currentSectionNameSpan.textContent = sectionDisplayName;
        
        const fullArticleText = Object.values(articleContent).flat().join(' ');
        const prompt = `Com base no artigo já escrito sobre "${userInputs.titulo}": "${fullArticleText.substring(0, 3000)}". Escreva o parágrafo INICIAL da nova seção: "${sectionDisplayName}". Este parágrafo deve servir como uma transição, conectando-se com a seção anterior e apresentando o que será discutido a seguir.`;
        
        try {
            const content = await callPuterAI(prompt);
            articleContent[currentSection].push(content);
            displayABNTDocument();
            log(`✅ Seção '${sectionDisplayName}' iniciada!`, 'success');
        } catch (error) { /* Erro já logado */ }
    } else {
        // Finaliza o artigo
        elements.finalizeBtn.style.display = 'none';
        elements.continueBtn.disabled = true;
        elements.concludeBtn.disabled = true;
        await generateResumoAndAbstract();
        displayABNTDocument();
        elements.finishBtn.style.display = 'block';
        log('🎓 Artigo estruturado! Revise e salve em PDF.', 'success');
    }
});

elements.finishBtn.addEventListener('click', () => {
    alert(`🎉 Artigo finalizado! Agora você pode revisá-lo e salvá-lo como PDF usando o botão roxo.`);
});

// Event listeners para o modal e impressão
elements.outputDiv.addEventListener('click', (e) => {
    const paragraph = e.target.closest('p[data-id]');
    if (paragraph) {
        const paragraphId = paragraph.dataset.id;
        const paragraphText = articleContent[paragraphId.split('-')[0]][parseInt(paragraphId.split('-')[1])];
        const cleanText = paragraphText.replace(/\s*\([A-ZÀ-Ù\s;,\d\-\.]+\)\s*\.?$/g, '').trim();
        openReferenceModal(paragraphId, cleanText, userInputs.titulo);
    }
});

elements.addReferencesBtn.addEventListener('click', addSelectedReferences);
elements.closeModalBtn.addEventListener('click', () => { elements.referenceModal.style.display = 'none'; });
elements.referenceModal.addEventListener('click', (e) => { if (e.target === elements.referenceModal) { elements.referenceModal.style.display = 'none'; } });

elements.savePdfBtn.addEventListener('click', () => {
    alert('A caixa de diálogo de impressão será aberta.\n\n**COMO SALVAR EM PDF:**\n\n1. No campo "Destino", **ESCOLHA "Salvar como PDF"**.\n2. Verifique as configurações (recomenda-se manter "Gráficos de segundo plano" ativado).\n3. Clique em "Salvar".');
    window.print();
});

// --- INICIALIZAÇÃO ---
log('🎯 Preencha os dados e clique em "Iniciar Artigo"', 'info');
</script>

</body>
</html>
