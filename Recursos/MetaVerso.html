<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathVerse IA - A Plataforma Definitiva</title>
    <script src="https://js.puter.com/v2/"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.20.0.min.js" charset="utf-8"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #141e30; --bg-light: #243b55; --primary-color: #4a90e2; --secondary-color: #e74c3c;
            --text-light: #ecf0f1; --text-dark: #2c3e50; --border-color: #34495e; --bg-main: #f4f7f9;
            --correct-color: #27ae60; --incorrect-color: #c0392b;
        }
        /* ... (ESTILOS GERAIS - IDÊNTICOS À RESPOSTA ANTERIOR) ... */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg-main); color: var(--text-dark); overflow: hidden; }
        .container { display: flex; height: 100vh; }
        .sidebar { width: 400px; background: linear-gradient(180deg, #2c3e50, var(--bg-dark)); color: var(--text-light); overflow-y: auto; display: flex; flex-direction: column; }
        .sidebar-header { padding: 25px; text-align: center; background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--border-color); }
        .sidebar-header h1 { font-size: 24px; }
        .area-section { border-bottom: 1px solid var(--border-color); }
        .area-header { padding: 15px 20px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: background 0.2s ease; border-left: 4px solid transparent; font-weight: 600; }
        .area-header:hover { background: rgba(74, 144, 226, 0.2); border-left-color: var(--primary-color); }
        .area-header.active { background: var(--primary-color); }
        .topics-list { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out; background: rgba(0,0,0,0.2); }
        .topics-list.active { max-height: 1500px; }
        .topic-item { padding: 12px 20px 12px 60px; cursor: pointer; transition: all 0.2s ease; border-left: 4px solid transparent; font-size: 14px; position: relative; }
        .topic-item::before { content: '›'; position: absolute; left: 40px; }
        .topic-item:hover { background: rgba(255,255,255,0.1); border-left-color: var(--primary-color); }
        .topic-item.selected { background: rgba(74, 144, 226, 0.3); border-left-color: var(--secondary-color); font-weight: bold; }
        .area-icon { width: 25px; margin-right: 15px; text-align: center; }
        .main-content { flex: 1; display: flex; flex-direction: column; position: relative; }
        #welcome-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; text-align: center; padding: 40px; }
        #welcome-screen h2 { font-size: 3em; margin-bottom: 20px; color: var(--text-dark); }
        #welcome-screen p { font-size: 1.2em; max-width: 600px; color: #555; }
        #topic-dashboard { display: none; height: 100%; flex-direction: column; }
        .dashboard-header { padding: 20px 25px; background: white; border-bottom: 1px solid #e0e0e0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-shrink: 0; }
        .dashboard-header h2 { font-size: 1.8em; } .dashboard-header p { color: #777; }
        .topic-tabs { display: flex; background: #e9ecef; padding: 0 25px; border-bottom: 1px solid #ddd; flex-shrink: 0; }
        .tab-button { padding: 15px 20px; cursor: pointer; border: none; background: transparent; font-size: 1em; font-weight: 600; color: #555; position: relative; transition: color 0.2s ease; }
        .tab-button::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: var(--primary-color); transform: scaleX(0); transition: transform 0.3s ease; }
        .tab-button.active { color: var(--primary-color); }
        .tab-button.active::after { transform: scaleX(1); }
        .content-pane-container { flex-grow: 1; overflow-y: auto; padding: 30px; position: relative; }
        .topic-content-pane { display: none; animation: fadeIn 0.5s ease; }
        .topic-content-pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid var(--primary-color); width: 60px; height: 60px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .content-output { line-height: 1.7; }
        .content-output h3 { margin-top: 20px; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .content-output ul, .content-output ol { margin-left: 20px; margin-bottom: 15px; }
        .content-output code { background: #e9ecef; padding: 2px 5px; border-radius: 4px; font-family: 'Consolas', 'Courier New', monospace; }
        .content-output pre { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .content-output blockquote { border-left: 4px solid #ccc; padding-left: 15px; margin: 15px 0; color: #555; font-style: italic; }
        .interactive-tool-container { display: none; }
        .interactive-tool-container.active { display: block; }
        .interactive-tool { background: white; padding: 25px; border-radius: 8px; border: 1px solid #ddd; margin-top: 20px; }
        .interactive-tool h4 { margin-bottom: 20px; }
        .tool-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .tool-group input, .tool-group textarea { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-family: monospace; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; }
        .btn-primary { background: var(--primary-color); color: white; }
        .tool-output { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #eee; min-height: 50px; font-family: monospace; white-space: pre-wrap; }
        #plot-container { width: 100%; height: 400px; }
        
        /* --- ESTILOS DO QUIZ --- */
        #quiz-container { background: white; padding: 25px; border-radius: 8px; border: 1px solid #ddd; }
        .quiz-question-text { font-size: 1.2em; font-weight: 600; margin-bottom: 20px; }
        .quiz-option { display: block; width: 100%; text-align: left; background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s ease; }
        .quiz-option:hover:not([disabled]) { border-color: var(--primary-color); background: #eaf2fb; }
        .quiz-option.correct { border-color: var(--correct-color); background: #e8f8f0; }
        .quiz-option.incorrect { border-color: var(--incorrect-color); background: #fbecec; }
        .quiz-explanation { border-left: 4px solid var(--primary-color); background: #f8f9fa; padding: 15px; margin-top: 20px; display: none; }
        .quiz-results { text-align: center; }
        
        /* --- ESTILOS DO CHAT --- */
        #ai-chat-widget { position: fixed; bottom: 20px; right: 20px; width: 350px; max-height: 500px; background: white; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden; transition: all 0.3s ease; z-index: 1000; }
        #ai-chat-widget.collapsed { max-height: 45px; }
        #ai-chat-header { background: var(--primary-color); color: white; padding: 10px 15px; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        #ai-chat-body { padding: 15px; flex-grow: 1; overflow-y: auto; }
        .chat-message { margin-bottom: 15px; display: flex; align-items: flex-start; }
        .chat-message .icon { margin-right: 10px; }
        .chat-message .text { background: #f1f1f1; padding: 10px; border-radius: 8px; max-width: 80%; line-height: 1.4; }
        .chat-message.user { flex-direction: row-reverse; }
        .chat-message.user .text { background: var(--primary-color); color: white; }
        .chat-message.user .icon { margin-left: 10px; margin-right: 0; }
        #ai-chat-form { display: flex; border-top: 1px solid #e0e0e0; padding: 10px; }
        #ai-chat-input { flex-grow: 1; border: 1px solid #ccc; padding: 8px; border-radius: 5px; }
        #ai-chat-send { margin-left: 10px; background: var(--primary-color); color: white; border: none; width: 40px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Barra Lateral com a Lista COMPLETA -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fa-solid fa-infinity"></i> MathVerse IA</h1>
                <p>A Plataforma Definitiva</p>
            </div>
            <!-- CONTEÚDO DA SIDEBAR (IDÊNTICO À VERSÃO ANTERIOR, COMPLETO COM AS 17 ÁREAS) -->
            <!-- ... (O HTML completo da sidebar foi omitido aqui para não exceder o limite de caracteres, mas use a versão da sua resposta anterior, que já está correta e completa) ... -->
        </div>

        <!-- Área de Conteúdo Principal -->
        <div class="main-content">
            <!-- ... (Código do Welcome Screen e Dashboard Header idêntico) ... -->
            <div id="topic-dashboard">
                <div class="dashboard-header">
                    <h2 id="dashboard-title"></h2><p id="dashboard-subtitle"></p>
                </div>
                <nav class="topic-tabs">
                    <button class="tab-button active" data-tab="overview">Visão Geral</button>
                    <button class="tab-button" data-tab="theory">Teoria</button>
                    <button class="tab-button" data-tab="examples">Exemplos</button>
                    <button class="tab-button" data-tab="applications">Aplicações</button>
                    <button class="tab-button" data-tab="tools">Ferramentas</button>
                    <button class="tab-button" data-tab="practice">Praticar</button>
                </nav>
                <div class="content-pane-container">
                    <div class="loader" id="content-loader"></div>
                    <div id="pane-overview" class="topic-content-pane active content-output"></div>
                    <div id="pane-theory" class="topic-content-pane content-output"></div>
                    <div id="pane-examples" class="topic-content-pane content-output"></div>
                    <div id="pane-applications" class="topic-content-pane content-output"></div>
                    <div id="pane-tools" class="topic-content-pane">
                        <!-- ... (Código das Ferramentas Interativas idêntico) ... -->
                    </div>
                    <div id="pane-practice" class="topic-content-pane">
                        <!-- QUIZ SERÁ INJETADO AQUI -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- WIDGET DE CHAT IA FUNCIONAL -->
    <div id="ai-chat-widget">
        <div id="ai-chat-header">
            <span><i class="fa-solid fa-robot"></i> Tutor Especialista</span>
            <i class="fa-solid fa-chevron-down"></i>
        </div>
        <div id="ai-chat-body">
            <div class="chat-message">
                <i class="fa-solid fa-robot icon"></i>
                <div class="text">Olá! Selecione um tópico para que eu possa ajudá-lo.</div>
            </div>
        </div>
        <form id="ai-chat-form">
            <input type="text" id="ai-chat-input" placeholder="Faça uma pergunta..." autocomplete="off" disabled>
            <button type="submit" id="ai-chat-send" disabled><i class="fa-solid fa-paper-plane"></i></button>
        </form>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Referências DOM (principais) ---
        const contentLoader = document.getElementById('content-loader');
        const panePractice = document.getElementById('pane-practice');
        
        // --- Estado da Aplicação ---
        let currentTopic = null;
        let currentArea = null;
        let loadedTabs = {};
        let quizQuestions = [];
        let currentQuizQuestionIndex = 0;
        let quizScore = 0;

        // --- LÓGICA PRINCIPAL (Sidebar, Abas, Conteúdo IA - Idêntica à anterior) ---
        // ... (Cole aqui o JS da resposta anterior para a lógica de sidebar e abas) ...

        // --- LÓGICA DO QUIZ (IMPLEMENTAÇÃO COMPLETA) ---
        function resetPracticeTab() {
            panePractice.innerHTML = `
                <h3>Pratique com a IA</h3>
                <p>Teste seus conhecimentos sobre <strong>${currentTopic}</strong>. A IA criará um quiz personalizado para você.</p>
                <button class="btn btn-primary" id="btn-generate-quiz"><i class="fa-solid fa-bolt"></i> Gerar Quiz (5 Questões)</button>
            `;
            document.getElementById('btn-generate-quiz').onclick = generateQuiz;
        }

        async function generateQuiz() {
            panePractice.innerHTML = '';
            contentLoader.style.display = 'block';

            const prompt = `Gere um quiz de 5 questões de múltipla escolha sobre o tópico de matemática "${currentTopic}".
            REGRAS ESTRITAS:
            1.  Cada questão deve ter 4 opções (A, B, C, D).
            2.  Apenas UMA opção correta.
            3.  Forneça uma explicação clara e concisa para a resposta correta.
            4.  Responda APENAS com o JSON, dentro de um bloco de código. O formato JSON DEVE ser:
            \`\`\`json
            {
              "questions": [
                {
                  "question": "Texto da pergunta 1...",
                  "options": ["Opção A", "Opção B", "Opção C", "Opção D"],
                  "correct_answer_index": 2,
                  "explanation": "Explicação para a pergunta 1..."
                }
              ]
            }
            \`\`\``;

            try {
                const response = await puter.ai.chat([{ role: 'user', content: prompt }]);
                const rawContent = response.message.content;
                const jsonMatch = rawContent.match(/```json\s*([\s\S]*?)\s*```/);
                if (!jsonMatch || !jsonMatch[1]) throw new Error("A IA não retornou um JSON válido.");

                const quizData = JSON.parse(jsonMatch[1]);
                quizQuestions = quizData.questions;
                if (!quizQuestions || quizQuestions.length === 0) throw new Error("A IA retornou um quiz vazio.");
                
                startQuiz();
            } catch (error) {
                console.error("Erro ao gerar quiz:", error);
                panePractice.innerHTML = `<p style="color:red;">Erro ao gerar o quiz. Tente novamente. (${error.message})</p>`;
            } finally {
                contentLoader.style.display = 'none';
            }
        }
        
        function startQuiz() {
            currentQuizQuestionIndex = 0;
            quizScore = 0;
            displayQuizQuestion();
        }

        function displayQuizQuestion() {
            if (currentQuizQuestionIndex >= quizQuestions.length) {
                showQuizResults();
                return;
            }
            const q = quizQuestions[currentQuizQuestionIndex];
            panePractice.innerHTML = `
                <div id="quiz-container">
                    <h4>Questão ${currentQuizQuestionIndex + 1}/${quizQuestions.length}</h4>
                    <p class="quiz-question-text">${q.question}</p>
                    <div id="quiz-options">
                        ${q.options.map((opt, index) => `
                            <button class="quiz-option" data-index="${index}">${opt}</button>
                        `).join('')}
                    </div>
                    <div class="quiz-explanation" id="quiz-explanation-text">
                        <strong>Explicação:</strong> ${q.explanation}
                    </div>
                    <button class="btn btn-primary" id="btn-next-quiz" style="display:none; margin-top: 20px;">Próxima Questão →</button>
                </div>`;
            
            document.querySelectorAll('.quiz-option').forEach(btn => {
                btn.onclick = (e) => selectQuizAnswer(e.target);
            });
            document.getElementById('btn-next-quiz').onclick = () => {
                currentQuizQuestionIndex++;
                displayQuizQuestion();
            };
        }
        
        function selectQuizAnswer(selectedButton) {
            const selectedIndex = parseInt(selectedButton.dataset.index);
            const correctIndex = quizQuestions[currentQuizQuestionIndex].correct_answer_index;
            
            document.querySelectorAll('.quiz-option').forEach(btn => {
                btn.disabled = true;
                const btnIndex = parseInt(btn.dataset.index);
                if (btnIndex === correctIndex) {
                    btn.classList.add('correct');
                } else if (btnIndex === selectedIndex) {
                    btn.classList.add('incorrect');
                }
            });
            
            if (selectedIndex === correctIndex) quizScore++;
            
            document.getElementById('quiz-explanation-text').style.display = 'block';
            document.getElementById('btn-next-quiz').style.display = 'inline-block';
        }

        function showQuizResults() {
             panePractice.innerHTML = `
                <div class="quiz-results">
                    <h3>Quiz Concluído!</h3>
                    <h2>Sua Pontuação: ${quizScore} de ${quizQuestions.length}</h2>
                    <p>Você acertou ${((quizScore / quizQuestions.length) * 100).toFixed(0)}% das questões.</p>
                    <button class="btn btn-primary" id="btn-restart-quiz">Tentar Novamente</button>
                </div>
            `;
            document.getElementById('btn-restart-quiz').onclick = generateQuiz;
        }

        // --- LÓGICA DO CHAT (IMPLEMENTAÇÃO COMPLETA) ---
        const chatWidget = document.getElementById('ai-chat-widget');
        const chatHeader = document.getElementById('ai-chat-header');
        const chatBody = document.getElementById('ai-chat-body');
        const chatForm = document.getElementById('ai-chat-form');
        const chatInput = document.getElementById('ai-chat-input');
        const chatSendBtn = document.getElementById('ai-chat-send');
        
        chatHeader.onclick = () => chatWidget.classList.toggle('collapsed');

        chatForm.onsubmit = async (e) => {
            e.preventDefault();
            const userInput = chatInput.value.trim();
            if (!userInput) return;

            addChatMessage(userInput, 'user');
            chatInput.value = '';
            chatInput.disabled = true;
            chatSendBtn.disabled = true;

            try {
                const prompt = `Como um tutor de matemática especialista, responda a seguinte pergunta do aluno no contexto do tópico "${currentTopic}". Pergunta: "${userInput}"`;
                const response = await puter.ai.chat([{ role: 'user', content: prompt }]);
                addChatMessage(response.message.content, 'ai');
            } catch (error) {
                addChatMessage("Desculpe, ocorreu um erro. Por favor, tente novamente.", 'ai');
            } finally {
                chatInput.disabled = false;
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        };
        
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-message ${sender}`;
            const iconClass = sender === 'user' ? 'fa-user' : 'fa-robot';
            const parsedMessage = sender === 'ai' ? marked.parse(message) : message.replace(/</g, "<").replace(/>/g, ">");

            msgDiv.innerHTML = `<i class="fa-solid ${iconClass} icon"></i><div class="text">${parsedMessage}</div>`;
            chatBody.appendChild(msgDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function updateChatContext() {
            chatInput.disabled = false;
            chatSendBtn.disabled = false;
            chatInput.placeholder = `Pergunte sobre ${currentTopic}...`;
            
            const firstMessage = chatBody.querySelector('.chat-message');
            firstMessage.querySelector('.text').innerHTML = `Olá! Sou seu tutor especialista em <strong>${currentTopic}</strong>. Como posso ajudar?`;
            // Limpa mensagens antigas, exceto a primeira
            while (chatBody.children.length > 1) {
                chatBody.removeChild(chatBody.lastChild);
            }
        }
        
        // --- Função de inicialização e ligação de tudo ---
        // (Modifique sua função selectTopic para chamar também updateChatContext() e resetPracticeTab())
        function selectTopic(topicElement) {
             // ... (código existente de selectTopic) ...
             updateChatContext();
             resetPracticeTab(); // Garante que a aba de prática esteja pronta
        }
    });
    </script>
</body>
</html>
